# 关键技术：指数解析与混合数据源 (Index Resolution & Hybrid Data)

## 1. 背景与挑战
在指数分析中，用户输入的代码可能千差万别：
- **标准宽基指数**：如 `000001` (上证指数), `399006` (创业板指)。
- **行业/概念指数**：如 `980022` (半导体概念), `BK0493` (宁组合)。
- **市场前缀差异**：`sh000001`, `sz399006`, 或不带前缀。

同时，单一数据源（如 Tushare）可能存在积分限制或数据缺失，需要备用源（AKShare）进行兜底。

## 2. IndexResolver (智能代码解析器)
`IndexResolver` (`tradingagents/utils/index_resolver.py`) 负责将用户输入的模糊代码转换为精确的数据源描述。

### 2.1 解析流程
1.  **静态映射 (Static Mapping)**: 
    - 优先检查内存中的预定义映射表，用于处理常用但非规范的代码（如 `980022` 映射到半导体概念）。
2.  **动态探测 (Dynamic Lookup)**:
    - 异步遍历 AKShare 的概念板块 (`concept`) 和行业板块 (`industry`) 列表。
    - **模糊匹配策略**: 自动尝试前缀补全（如 `98xxxx` -> `BKxxxx`），尝试在板块名称和代码中进行匹配。
3.  **标准指数验证 (Probe)**: 
    - 如果板块匹配失败，尝试添加 `sh/sz` 前缀。
    - 调用标准指数接口获取最新一天数据，验证该代码是否为有效的宽基指数。

### 2.2 解析结果结构
解析器返回一个标准化的字典，指导后续 Agent 选择正确的数据获取策略：
```json
{
    "name": "半导体",
    "source_type": "concept",  // 关键字段：决定后续调用 concept 还是 industry 还是 index 接口
    "symbol": "半导体",        // AKShare 接口需要的具体参数（部分接口用名称，部分用代码）
    "original_code": "980022",
    "description": "半导体概念板块"
}
```

## 3. HybridIndexDataProvider (混合数据源)
为了保证高可用性，系统实现了一个双层数据供应架构 (`HybridIndexDataProvider`)。

### 3.1 架构设计
-   **Primary Source (主源)**: **Tushare Pro**。
    -   优势：数据规范，复权数据准确，包含详细的宏观数据。
    -   劣势：需要积分权限。
-   **Secondary Source (备源)**: **AKShare**。
    -   优势：完全开源免费，接口覆盖面广（含资金流向、国际新闻）。
    -   劣势：部分数据格式需要清洗。

### 3.2 熔断与降级机制
`HybridIndexDataProvider` 维护每个源的健康状态 (`source_status`)，实现自动故障切换：
1.  **健康检查**: 每次调用前检查源的 `healthy` 状态。
2.  **故障计数**: 连续 `N` 次调用失败后，将该源标记为 `Unhealthy` 并记录 `last_failure_time`。
3.  **冷却恢复**: 源进入冷却期（默认 300秒）。冷却期满后，下一次调用会尝试重连（Reset）。
4.  **自动降级 (Fallback Logic)**:
    ```python
    async def get_macro_data(self):
        # 1. 优先尝试主源
        if self._is_source_healthy("tushare"):
            try: return await self.tushare.get_data()
            except: self._record_failure("tushare")
        
        # 2. Tushare 失败或不健康，自动切换到 AKShare
        if self._is_source_healthy("akshare"):
            return await self.akshare.get_data()
    ```

## 4. 数据标准化
由于不同源返回的数据格式不同（列名、时间格式），系统在 Provider 层进行了统一标准化，确保上层 Agent 对数据源无感知。

*   **列名映射**: 将中文列名（如“收盘”）统一映射为英文标准字段（`close`, `open`, `high`, `low`, `volume`）。
*   **类型转换**: 强制将数值列转换为 `float`，处理空值和异常值。
*   **日期格式**: 统一标准化为 `YYYYMMDD` 字符串或 `datetime` 对象。

```python
# 示例：AKShare 板块数据标准化
def normalize_concept_data(df):
    rename_map = {
        "日期": "trade_date", "开盘": "open", "收盘": "close", ...
    }
    df = df.rename(columns=rename_map)
    # ... 类型转换逻辑 ...
    return df