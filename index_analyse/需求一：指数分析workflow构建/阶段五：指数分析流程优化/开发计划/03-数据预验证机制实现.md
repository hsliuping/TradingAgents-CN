# 03-数据预验证机制实现

## 1. 任务目标
在指数分析任务启动前，增加数据有效性校验，防止因代码错误或数据源不可用导致的 Token 浪费和任务失败。

## 2. 涉及文件
*   `app/services/simple_analysis_service.py`
*   `tradingagents/utils/index_validator.py` (新建)

## 3. 详细实施步骤

### 3.1 创建验证工具 (`index_validator.py`)
**目标**：实现针对指数代码和数据源的验证逻辑。

1.  **新建文件**：`tradingagents/utils/index_validator.py`。
2.  **实现功能**：
    *   `validate_index_code(code: str) -> bool`:
        *   检查后缀：`.SH`, `.SZ` (A股), `^` (美股/全球)。
        *   简单正则匹配。
    *   `check_data_source_connectivity() -> bool`:
        *   尝试调用 `akshare.stock_zh_index_daily(symbol="sh000001")` 获取 1 行数据。
        *   设置短超时（如 5秒）。
    *   `prepare_index_data_async(...)`:
        *   封装上述逻辑，返回 `ValidationResult` 对象（复用或新建）。

### 3.2 服务层集成 (`simple_analysis_service.py`)
**目标**：在任务执行流程中启用验证。

1.  **定位代码**：`execute_analysis_background` 方法（约894行）。
2.  **修改逻辑**：
    *   **原逻辑**：`if analysis_type == "index": validation_result = None`
    *   **新逻辑**：
        ```python
        if analysis_type == "index":
            logger.info(f"📊 指数分析模式：开始验证指数数据")
            validation_result = await prepare_index_data_async(stock_code)
            
            if not validation_result.is_valid:
                # 抛出错误，更新任务状态为 FAILED
                ...
        ```

3.  **错误处理**：
    *   构建用户友好的错误提示（例如：“指数代码格式错误，请使用 000300.SH 格式” 或 “数据源暂时不可用”）。

## 4. 验证标准
1.  **无效代码拦截**：输入 `000300` (无后缀) 应立即失败并提示。
2.  **有效代码通过**：输入 `000300.SH` 应通过验证并继续。
3.  **断网测试**：断开网络或模拟数据源异常，任务应快速失败而非卡住。
