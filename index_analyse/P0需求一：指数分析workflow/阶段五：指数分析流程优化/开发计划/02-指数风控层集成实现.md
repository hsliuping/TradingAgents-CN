# 02-指数风控层集成实现

## 1. 任务目标
将个股分析中成熟的风险管理层（Risk Management Layer）引入指数分析工作流，解决当前指数分析“只顾进攻（生成策略），忽略防守（风险验证）”的问题。

## 2. 涉及文件
*   `tradingagents/graph/setup.py`
*   `tradingagents/agents/analysts/risk_assessment_analyst.py` (复用)
*   `tradingagents/agents/risk_manager/risk_judge.py` (复用)

## 3. 详细实施步骤

### 3.1 Agent 复用与适配
**目标**：复用现有的 Risk Analyst 类，但通过 Prompt 区分指数场景。

1.  **无需新建类**：`Risky/Neutral/Safe Analyst` 和 `Risk Judge` 逻辑通用。
2.  **Prompt 调整**：
    *   在 `create_risk_assessment_analyst` 工厂函数中，检查是否支持 `analysis_type` 参数。
    *   如果不支持，需修改 `risk_assessment_analyst.py`，允许注入不同的 System Prompt。
    *   **指数版 Prompt 重点**：
        *   Risky: 关注宏观流动性宽松、政策强刺激、技术面突破。
        *   Safe: 关注汇率贬值、地缘政治恶化、经济数据不及预期。
        *   Judge: 权衡系统性风险与机会，给出仓位控制建议（0-100%）。

### 3.2 图拓扑修改 (`setup.py`)
**目标**：在 `Strategy Advisor` 之后插入风控闭环。

1.  **引入节点**：
    在 `_setup_index_graph` 中添加：
    *   `Risky Analyst`
    *   `Neutral Analyst`
    *   `Safe Analyst`
    *   `Risk Judge`

2.  **修改连线**：
    *   **断开原连接**：移除 `Strategy Advisor -> END`。
    *   **新连接**：
        *   `Strategy Advisor -> Risky Analyst` (作为风控入口)。
        *   **构建风控循环**（参考 `_setup_stock_graph`）：
            *   `Risky Analyst` -> (`Safe Analyst` | `Risk Judge`)
            *   `Safe Analyst` -> (`Neutral Analyst` | `Risk Judge`)
            *   `Neutral Analyst` -> (`Risky Analyst` | `Risk Judge`)
        *   **出口**：`Risk Judge -> END`。

3.  **条件边配置**：
    *   复用 `self.conditional_logic.should_continue_risk_analysis`。
    *   确保该条件逻辑在指数分析的 State 中也能正常工作（通常依赖 `max_risk_discuss_rounds`，需确认该参数在指数配置中已正确设置）。

## 4. 验证标准
1.  **流程跑通**：Strategy Advisor 输出后，流程进入 Risky Analyst。
2.  **辩论逻辑**：能观察到 Risky/Safe/Neutral 之间的观点交锋。
3.  **最终裁决**：Risk Judge 能综合 Strategy Advisor 的原始建议和辩论结果，输出最终报告。
4.  **报告展示**：前端能看到新增的“风险评估”章节。
