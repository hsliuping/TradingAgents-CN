# 关键技术：结构化输出保证 (Structured Output Enforcement)

## 1. 概述

在自动化交易分析系统中，非结构化的自然语言输出虽然易于阅读，但难以被下游的算法模块（如量化风控、自动化交易执行）所解析和利用。TradingAgents-CN 采用了一套严格的结构化输出保证机制，强制要求 LLM（特别是 Technical Analyst 和 Strategy Advisor）输出符合预定义的 JSON 格式，从而实现“人机共读”——既保留了Markdown的易读性，又具备JSON的机器可解析性。

## 2. 核心机制

### 2.1 Prompt Engineering (提示词工程)
在 System Prompt 中明确约定输出格式 Schema，并给出具体的 Few-shot 示例。

**示例 (Technical Analyst)**:
```text
You must output your analysis in strict JSON format as follows:
{
    "trend_signal": "BULLISH", 
    "confidence": 0.85,
    "key_levels": {
        "support": "3200",
        "resistance": "3350"
    },
    ...
}
Do not wrap the JSON in markdown code blocks.
```

### 2.2 Output Parsing (输出解析)
系统实现了健壮的解析器，能够处理 LLM 输出中常见的格式错误，例如：
*   自动去除 JSON 外围的 Markdown 代码块标记（` ```json ... ``` `）。
*   修复常见的 JSON 语法错误（如末尾逗号）。
*   提取混合文本中的 JSON 片段。

### 2.3 Fallback Mechanism (降级机制)
当 LLM 无法生成有效的 JSON 或工具调用失败时，系统会自动生成一个标准结构的“降级报告”，确保下游节点不会因为输入数据缺失而崩溃。

**降级报告示例**:
```json
{
    "trend_signal": "NEUTRAL",
    "confidence": 0.0,
    "analysis_summary": "【降级报告】由于数据获取受限，无法进行完整的技术分析...",
    "risk_warning": "数据不完整，请谨慎参考"
}
```

## 3. 应用场景

### 3.1 Technical Analyst (技术分析)
*   **输入**: OHLCV 数据、技术指标。
*   **输出**: 结构化的趋势信号 (`trend_signal`) 和支撑阻力位 (`key_levels`)。
*   **用途**: 下游的 Strategy Advisor 会直接读取 `trend_signal` 来辅助判断多空方向，读取 `confidence` 来加权该分析师的意见。

### 3.2 Strategy Advisor (策略顾问)
*   **输入**: 上游所有 Agent 的报告。
*   **输出**: 最终决策结构体。
    ```json
    {
        "action": "BUY",
        "weight": 0.6,  // 建议仓位 60%
        "reasoning": "...",
        "risk_assessment": "..."
    }
    ```
*   **用途**: 该结构化输出可直接对接自动交易接口或风控系统。

## 4. 优势

1.  **确定性**: 将概率性的 LLM 输出转化为确定性的程序变量。
2.  **鲁棒性**: 通过降级机制，保证了系统在极端情况下的稳定性。
3.  **可集成性**: 方便对接外部的量化交易系统、数据库或可视化仪表盘。