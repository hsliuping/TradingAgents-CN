# Risk Judge (风险管理主席/Risk Manager)

## 1. 角色定义
**Risk Judge** (在代码中实现为 `risk_manager.py`) 是整个风险管理流程的最终决策者。作为风险管理委员会的主席，它不直接产生观点，而是聆听激进、保守和中性分析师的辩论，结合交易员的初步计划和历史记忆，做出最终的、可执行的交易决策。

## 2. 核心职责
- **辩论裁决**：总结各方分析师的关键论点，判断哪方的逻辑在当前市场环境下更具说服力。
- **决策制定**：生成明确的交易指令（买入/卖出/持有），拒绝模棱两可。
- **计划修正**：基于辩论结果，对交易员的原始计划进行必要的修正和完善。
- **以史为鉴**：检索历史记忆，利用过去的成功经验或失败教训来辅助当前的决策。

## 3. 输入数据
Agent 接收最全面的输入信息：
1. **交易员/策略顾问初步计划** (`investment_plan` 或 `strategy_report`)：决策的起点。
2. **多维度市场报告**：
   - 宏观 (`macro_report`)、政策 (`policy_report`)、板块 (`sector_report`)
   - 国际新闻 (`international_news_report`)、技术分析 (`technical_report`)
   - (在个股模式下为：市场、情绪、新闻、基本面报告)
3. **辩论全记录** (`history`)：包含 Risky、Safe 和 Neutral Analyst 的多轮交锋记录。
4. **长期记忆** (`past_memories`)：根据当前市场状况检索到的历史相似案例及其结果。检索数量受 `research_depth` 参数控制（深度/全面模式下检索更多）。

## 4. 处理流程
1. **检索记忆**：根据当前市场状况（各报告摘要），从向量数据库中检索相似的历史场景。
2. **综合研判**：
   - 阅读辩论历史，提取最强论点。
   - 对比历史记忆，避免重蹈覆辙。
   - 评估原始计划的可行性。
3. **最终决策**：生成包含明确建议（买/卖/持）和详细理由的最终报告。
4. **容错处理**：具备重试机制，若 LLM 调用失败多次，会生成默认的“持有”建议以确保系统稳定性。

## 5. 输出格式
输出为最终的决策报告，包含：
- **明确且可操作的建议**：买入、卖出或持有。
- **详细推理**：基于辩论和历史反思的逻辑链条。
- **修正后的交易计划**：具体的执行步骤。

**示例输出片段**：
> **Risk Judge**:
> **最终决策：买入 (50% 仓位)**
> 
> **决策理由**：
> 尽管保守派对估值提出了合理的担忧，但激进派关于流动性拐点的论证得到了宏观数据和历史记忆的强力支持。
> 1. **辩论裁决**：激进派指出的“政策底领先市场底”逻辑，在历史上多次被验证有效（参考2018年底案例）。
> 2. **历史教训**：记忆库显示，在类似的流动性释放初期，过于保守往往导致踏空。
> 
> **修正后的计划**：
> 采纳策略顾问的买入建议，但考虑到保守派提到的外部风险，将建议的80%仓位下调至50%，并严格设置5%的动态止损。

## 6. 在 Workflow 中的位置
- 位于 **Risk Management Layer (风险管理层)** 的末端。
- 是整个 Analysis Workflow 的**终点节点**。
- 其输出即为整个系统的最终输出结果。