# 指数分析Workflow优化需求说明

**文档版本**: v1.0  
**创建日期**: 2024-12-14  
**作者**: 项目组  
**状态**: 已确认

---

## 📋 需求背景

### 当前状态 (v2.0.0 - 阶段一)

TradingAgents-CN项目在阶段一已完成指数分析基础功能,支持:
- 4个专业分析师: Macro Analyst, Policy Analyst, Sector Analyst, Strategy Advisor
- 线性工作流: START → Macro → Policy → Sector → Strategy → END
- 基本数据源: AKShare宏观数据、政策新闻、板块资金流向
- 单一仓位输出: 建议仓位值 (0.0-1.0)

### 发现的问题

通过对个股分析工作流的深入研究,发现当前指数分析存在以下不足:

#### 1. 信息盲区

**问题**: 国际媒体(彭博社/路透社)提前爆料的政策传闻未被捕捉

**案例**:
```
2025年12月某日
- 彭博社报道: "中国计划额外推出千亿级芯片支持计划"
- 国内新闻源: 尚未官宣,无报道
- 结果: 国际资本抢跑,北向资金大幅流入半导体板块
- 当前系统: Policy Analyst未捕捉到此信息 ❌
```

**影响**: 
- 散户(依赖国内新闻)慢2天,已经涨了3%
- 失去抢跑机会

#### 2. 长短期混淆

**问题**: 未区分长期政策支持与短期新闻影响

**案例**:
```
分析中证半导体指数
- 长期支持: "自主可控"战略 (5-10年)
- 短期利好: "千亿芯片支持计划"传闻 (1-4周)

当前系统输出:
- Policy Analyst: "自主可控战略支持" ✅
- 但未明确区分这是长期趋势还是短期催化 ❌
- Strategy Advisor: 建议仓位70%
- 但未说明这70%中,多少是长期配置,多少是短期加仓 ❌
```

**影响**:
- 用户不知道什么时候应该减仓(短期利好兑现)
- 容易因短期新闻反复调整长期仓位 → 过度交易

#### 3. 决策单一

**问题**: 仅提供单一仓位建议,缺少动态调整策略

**案例**:
```
当前输出:
- 建议仓位: 70%
- 市场展望: 看多

用户疑问:
- 如果千亿芯片支持正式官宣,是否应该提升仓位?提升到多少?
- 如果传闻证伪,应该降到多少?
- 应该监控哪些指标来判断是否调整?

当前系统: 无法回答 ❌
```

**影响**:
- 缺少动态管理指引
- 用户只能静态持有,无法应对市场变化

#### 4. 风险粗糙

**问题**: 缺少多维度风险评估和分层持仓策略

**案例**:
```
当前输出:
- 关键风险: ["政策不及预期", "外部环境恶化"]

专业投资者需要:
- 系统性风险评估 (宏观、政策)
- 板块集中度风险
- 估值风险
- 分层持仓策略 (核心长期/战术配置/现金储备)

当前系统: 仅简单描述 ❌
```

---

## 🎯 优化需求

### 需求1: 新增国际新闻分析师 (International News Analyst)

**优先级**: P0 (必做)

**需求描述**:

新增International News Analyst节点,专门监控国际媒体(彭博社、路透社、华尔街日报),识别政策传闻、突发事件、市场情绪,给出短期仓位调整建议。

**功能要求**:

1. **数据源**
   - 彭博社新闻 (通过NewsAPI或Bloomberg Terminal)
   - 路透社新闻 (通过NewsAPI或Reuters API)
   - 华尔街日报 (通过NewsAPI或WSJ RSS)
   - Google News (免费降级方案)

2. **新闻分类**
   - 政策传闻: 国际媒体提前爆料但国内未确认
   - 行业事件: 突发事件 (如ASML限制对华出口)
   - 市场情绪: 外资动向 (如大幅增持中国科技股)

3. **影响持续期评估**
   - 短期 (1-7天): 市场情绪类新闻
   - 中期 (1-4周): 政策传闻、行业事件
   - 长期 (数月以上): 政策官宣 (应归入Policy Analyst)

4. **去重机制**
   - 避免与Policy Analyst报告重复
   - 仅保留未被Policy Analyst覆盖的短期新闻

5. **输出**
   - 关键新闻列表 (含来源、日期、类型、影响、可信度)
   - 短期仓位调整建议 (±10%-20%)
   - 调整理由和预期持续时间

**验收标准**:
- [ ] 能成功获取彭博/路透新闻 (成功率>80%)
- [ ] 正确分类新闻类型和影响持续期
- [ ] 与Policy Analyst报告无重复
- [ ] 短期调整幅度合理 (±20%以内)

---

### 需求2: Policy Analyst功能扩展 (长期政策识别)

**优先级**: P0 (必做)

**需求描述**:

在现有Policy Analyst基础上,新增长期政策识别功能,明确区分长期战略政策、中期政策措施、短期调控政策。

**功能要求**:

1. **政策分类**
   - 长期战略政策 (5-10年): 如"自主可控"、"新质生产力"、"碳中和"
   - 中期政策措施 (1-3年): 如"新能源汽车补贴延长2年"
   - 短期调控政策 (数月): 如"降准25BP" (由International News处理)

2. **长期政策属性**
   - 政策名称
   - 持续期
   - 支持强度 (强/中/弱)
   - 受益板块
   - 政策连续性评分 (0-1)

3. **输出**
   - 长期战略政策列表
   - 基于长期政策的基础仓位建议 (40%-80%)
   - 政策连续性评估

**验收标准**:
- [ ] 能识别至少3个长期战略政策
- [ ] 政策分类准确 (长期/中期/短期)
- [ ] 基础仓位建议合理 (40%-80%)
- [ ] 政策连续性评分符合实际

---

### 需求3: Strategy Advisor重构 (双层仓位决策)

**优先级**: P0 (必做)

**需求描述**:

重构Strategy Advisor,实现双层仓位决策机制,区分基础仓位(长期)和短期调整,提供分层持仓策略和动态调整触发条件。

**功能要求**:

1. **双层仓位决策**
   ```
   基础仓位 = Policy Analyst.base_position_recommendation (60%)
   短期调整 = International News.position_adjustment (+15%)
   最终仓位 = 基础仓位 + 短期调整 (75%)
   ```

2. **分层持仓策略**
   - 核心长期仓位: 基于长期政策,不轻易变动
   - 战术性配置: 基于短期新闻,可灵活调整
   - 现金储备: 应对波动,逢低加仓

3. **动态调整策略**
   - 提升触发条件 (如"政策正式官宣")
   - 降低触发条件 (如"传闻证伪")
   - 监控指标列表

4. **输出**
   - 基础仓位 (Policy来源)
   - 短期调整 (International News来源)
   - 最终建议仓位
   - 分层持仓明细
   - 动态调整触发条件
   - 监控指标

**验收标准**:
- [ ] 正确读取Policy Analyst的base_position_recommendation
- [ ] 正确读取International News的position_adjustment
- [ ] 最终仓位 = 基础仓位 + 短期调整 (限制0%-100%)
- [ ] 提供分层持仓明细 (三层)
- [ ] 提供至少2个动态调整触发条件

---

### 需求4: AgentState扩展 (新增字段)

**优先级**: P0 (必做)

**需求描述**:

扩展AgentState,新增international_news_report字段,支持国际新闻分析报告的传递。

**功能要求**:

```python
class AgentState(MessagesState):
    # ... 现有字段
    
    # 🆕 新增字段
    international_news_report: Annotated[str, "国际新闻分析报告"]
    international_news_tool_call_count: Annotated[int, "国际新闻工具调用计数"]
```

**验收标准**:
- [ ] 新增字段定义正确
- [ ] 不影响现有字段
- [ ] 编译通过

---

### 需求5: 工作流集成 (新增节点)

**优先级**: P0 (必做)

**需求描述**:

在指数分析工作流中集成International News Analyst节点,调整工作流顺序。

**工作流变化**:

```
v2.0.0:
START → Macro → Policy → Sector → Strategy → END

v2.1.0:
START → Macro → Policy → International News → Sector → Strategy → END
```

**节点位置理由**:
- International News在Policy之后: 可以对比Policy报告,避免重复
- International News在Sector之前: 为板块分析提供国际视角

**验收标准**:
- [ ] International News节点正确集成
- [ ] 节点顺序正确
- [ ] 工作流执行成功
- [ ] 执行时间增加<50% (从2-3分钟→3-4分钟)

---

## 🚫 非需求 (明确不做)

### 1. Scenario Analysis Module (情景分析模块)

**理由**: 
- Phase 1已解决核心问题(长短期区分)
- 情景分析是"锦上添花",非必需
- 可在Phase 2上线后,根据用户反馈决定是否开发

**状态**: 延迟到v2.2.0

### 2. Market Sentiment Analyst (市场情绪分析师)

**理由**:
- 美股/港股社交媒体监控有价值,但优先级低于国际新闻
- A股量化情绪指标(VIX、北向资金)可在后续版本添加

**状态**: 延迟到v2.2.0

### 3. Multi-Dimensional Risk Module (多维度风险模块)

**理由**:
- 多维度风险评估(系统性/板块/估值)是高级功能
- 可作为可选功能,不影响基础版

**状态**: 延迟到v2.2.0或作为可选插件

---

## ⏱️ 时间要求

### 开发周期

- **Phase 1 (核心开发)**: 2-3周
  - Week 1: International News Analyst + Policy扩展
  - Week 2: Strategy重构 + 工作流集成
  - Week 3: 测试与优化

### 里程碑

- **M1 (Week 1结束)**: International News Analyst可用
- **M2 (Week 2结束)**: 双层仓位决策可用
- **M3 (Week 3结束)**: 端到端测试通过,ready for production

---

## 💰 成本估算

### 开发成本

| 项目 | 工时 |
|------|-----|
| International News Analyst | 2天 |
| Policy Analyst扩展 | 2天 |
| Strategy Advisor重构 | 1天 |
| AgentState扩展 | 0.5天 |
| 工作流集成 | 2天 |
| 单元测试 | 2天 |
| 端到端测试 | 1天 |
| 文档 | 1天 |
| **总计** | **11.5天** |

### 运营成本

| 项目 | 月成本 |
|------|--------|
| NewsAPI订阅 | $50-100 (可选) |
| Google News | $0 (免费) |
| LLM调用增加 | ~$10 (+30% token) |
| **总计** | **$10-110/月** |

**最低成本**: $10/月 (仅用免费方案)

---

## 📊 成功标准

### 功能指标

- [ ] International News能成功获取彭博/路透新闻 (成功率>80%)
- [ ] Policy Analyst能识别长期政策并给出基础仓位
- [ ] Strategy Advisor能正确计算双层仓位
- [ ] 工作流执行成功率>95%
- [ ] 新增Agent不影响现有个股分析功能

### 性能指标

- [ ] 执行时间增加<50% (2-3分钟→3-4分钟)
- [ ] LLM Token消耗增加<40%
- [ ] 系统稳定性: 无新增critical bug

### 用户价值指标

- [ ] 信息时效性提升1-2天 (彭博社领先)
- [ ] 决策科学性提升40% (双层仓位机制)
- [ ] 专业投资者满意度提升50%

---

## ⚠️ 风险与依赖

### 数据源风险

**风险**: NewsAPI可能无法获取所有彭博社新闻

**缓解**:
- 提供3个数据源: Bloomberg (NewsAPI) → Reuters → Google News
- 降级链: 付费API失败 → 免费API → 基于关键词搜索

### 性能风险

**风险**: 新增Agent可能导致执行时间过长

**缓解**:
- 限制新闻获取数量 (最多10条)
- 优化LLM Prompt,减少Token消耗
- 并行调用部分工具 (如果可行)

### 依赖

- **Python库**: newsapi-python, GoogleNews
- **外部API**: NewsAPI (可选,有免费降级)
- **基础版本**: v2.0.0 (阶段一)

---

## 📝 验收流程

### 阶段性验收

1. **Week 1**: International News Analyst演示
   - 演示彭博社新闻获取
   - 演示新闻分类和影响持续期评估

2. **Week 2**: 双层仓位决策演示
   - 演示Policy扩展输出
   - 演示Strategy双层计算

3. **Week 3**: 端到端验收
   - 真实场景测试: 半导体指数 (sh931865)
   - 性能测试: 执行时间、Token消耗
   - 回归测试: 个股分析功能不受影响

### 最终验收

- [ ] 所有功能验收标准通过
- [ ] 所有性能指标达标
- [ ] 文档完整(设计文档、开发计划、README)
- [ ] 代码review通过
- [ ] 测试覆盖率>80%

---

## 📚 参考文档

- [阶段一设计文档](../../阶段一：构建新的指数分析workflow/设计文档/)
- [个股Agent机制借鉴深度分析报告](../个股Agent机制借鉴深度分析报告.md)
- [指数分析优化改造方案v1.0](../指数分析优化改造方案v1.0.md)

---

**文档版本**: v1.0  
**创建日期**: 2024-12-14  
**状态**: 已确认  
**下一步**: 编写概要设计
