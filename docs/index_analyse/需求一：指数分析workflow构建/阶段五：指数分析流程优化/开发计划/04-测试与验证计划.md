# 04-测试与验证计划

## 1. 测试目标
验证阶段五的所有优化（动态并行、风险集成、数据验证）是否按预期工作，且不引入回归问题。

## 2. 测试环境
*   **本地环境**：macOS, Python 3.12+
*   **依赖服务**：Redis, MongoDB (Docker)
*   **LLM**：DashScope (Qwen) 或 DeepSeek

## 3. 测试用例

### 3.1 单元/模块测试
| ID | 测试项 | 输入 | 预期输出 | 备注 |
| :--- | :--- | :--- | :--- | :--- |
| UT-01 | 指数代码验证-成功 | `000001.SH` | `is_valid=True` | |
| UT-02 | 指数代码验证-失败 | `000001` | `is_valid=False`, 提示格式错误 | |
| UT-03 | 数据源连通性 | (正常网络) | `True` | |

### 3.2 集成测试 (Workflow)
| ID | 测试项 | 配置 | 预期行为 |
| :--- | :--- | :--- | :--- |
| IT-01 | **全并行流程** | 选中所有模块 | 1. 所有 Analyst 节点同时启动（看日志时间戳）。<br>2. 最终生成完整报告。 |
| IT-02 | **动态选择子集** | 仅选 Macro, Technical | 1. Policy, News, Sector 节点不执行。<br>2. 报告中仅包含宏观和技术面章节。 |
| IT-03 | **风险层验证** | 深度=标准 | 1. Strategy Advisor 后进入 Risky Analyst。<br>2. 经历至少1轮 Risk/Safe 辩论。<br>3. Risk Judge 输出最终结论。 |
| IT-04 | **异常拦截** | 错误代码 | 任务在 10% 进度处失败，未调用 LLM。 |

## 4. 性能对比测试
*   **基准**：记录 v2.3 版本（串行）分析上证指数的平均耗时（3次取平均）。
*   **对比**：记录 v2.4 版本（并行）分析上证指数的平均耗时。
*   **目标**：并行版本耗时减少 30% 以上。

## 5. 验收步骤
1.  启动 Docker 服务。
2.  启动后端 API (`python -m app.main`)。
3.  运行测试脚本：
    ```bash
    python scripts/download_index_report.py --index 上证指数 --depth 标准
    ```
4.  检查生成的 Markdown 报告：
    *   确认包含“风险评估”章节。
    *   确认各模块内容完整。
5.  查看后端日志：
    *   确认并行执行的日志特征（各模块几乎同时打印 "Start..."）。
