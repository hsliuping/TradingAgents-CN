# v2.4.0 版本说明 - 指数分析流程优化

## 1. 版本概览

本版本旨在全方位优化指数分析（Index Analysis）工作流的灵活性、深度、效率和可靠性。通过引入动态 Agent 选择、并行执行架构、独立风险评估层以及数据预验证机制，打造企业级的指数分析能力。

## 2. 核心变更

### 2.1 动态 Agent 选择与并行化机制
*   **重构指数分析图构建**：重构 `TradingAgentsGraph` 和 `GraphSetup` 中的 `_setup_index_graph` 方法，支持根据用户选择的分析师列表动态构建工作流。
*   **并行执行架构**：打破原有的线性串行依赖，实现 Macro、Policy、News、Sector、Technical 等基础分析模块的**并行执行**，大幅缩短分析总耗时。
*   **消除服务层限制**：移除 `simple_analysis_service.py` 中强制清空指数分析 `selected_analysts` 的逻辑，允许前端传递具体的分析模块组合。

### 2.2 独立风险评估层
*   **引入风险辩论环节**：在策略建议生成后，新增 `Risky`、`Neutral`、`Safe` 三类风险分析师的辩论环节，分别从激进、中性和保守视角对指数策略进行压力测试。
*   **新增 Index Risk Judge**：增加风险裁判节点，综合策略建议与辩论结果，输出包含明确风险提示和仓位控制建议的最终报告。

### 2.3 数据预验证机制
*   **格式验证**：新增对指数代码格式的严格校验（必须包含 `.SH` 或 `.SZ` 后缀）。
*   **可用性探测**：在任务启动前探测底层数据源（如 akshare）的连通性，避免无效任务消耗 LLM 资源。

### 2.4 指数分析自学习记忆机制
*   **全流程记忆注入**：为指数多头研究员、空头研究员及策略顾问引入长短期记忆模块（基于 ChromaDB）。
*   **动态情境反思**：实现了基于“宏观+政策+行业+新闻+技术”多维报告的综合情境提取与向量化。
*   **闭环进化**：支持在分析周期结束后，结合实际市场走势进行反思（Reflection），自动更新向量数据库，实现系统决策能力的持续进化。

### 2.5 个股分析并行化优化 (New)
*   **并行架构迁移**：将个股分析（Stock Analysis）工作流从串行模式升级为并行模式。
*   **效率提升**：市场、社媒、新闻、基本面四个基础模块现在同时执行，大幅缩短个股分析的总耗时。
*   **逻辑复用**：复用了指数分析的“扇出/扇入”与 Barrier 同步机制，保证了系统架构的一致性。

## 3. 影响范围

*   **后端服务**：
    *   `app/services/simple_analysis_service.py`
    *   `tradingagents/graph/trading_graph.py`
    *   `tradingagents/graph/setup.py`
    *   `tradingagents/graph/reflection.py`
    *   `tradingagents/agents/utils/memory.py`
*   **新增服务**：
    *   `app/services/index_validation_service.py` (规划中)
*   **Agent 逻辑**：
    *   复用现有 Risk Agent 逻辑，通过 Prompt 适配指数/宏观场景。
    *   Index Bull/Bear Researcher 及 Strategy Advisor 新增记忆检索能力。

## 4. 升级指南

本版本涉及后端核心工作流变更，前端需配合调整 API 调用参数（传递 `selected_analysts`），后端服务重启即可生效。建议在升级后进行全流程回归测试，特别是并行执行后的日志和状态同步情况。
