# 指数分析流程优化 - 详细设计文档

## 1. 动态 Agent 选择与并行执行机制设计

### 1.1 背景
当前 `_setup_index_graph` 实现为硬编码的线性链：
`Macro -> Policy -> Int'l News -> Sector -> Technical -> Strategy`
即使用户在前端取消勾选“技术分析”，系统仍会执行全流程，导致资源浪费。此外，各模块间本无强依赖关系（例如宏观分析不需要等待行业分析结果），线性执行导致总耗时为各模块之和，效率低下。

### 1.2 设计思路
采用**并行执行**架构，所有基础分析模块（宏观、政策、新闻、行业、技术）同时启动，由后续的“多空研究员”节点负责汇总。

#### 1.2.1 分析师类型映射与并行化
定义标准化的指数分析模块标识：
*   `macro`: 宏观经济分析 (Macro Analyst)
*   `policy`: 政策面分析 (Policy Analyst)
*   `news`: 国际新闻分析 (International News Analyst)
*   `sector`: 行业/板块分析 (Sector Analyst)
*   `technical`: 技术面分析 (Technical Analyst)

**并行执行逻辑**：
1.  **START 节点** 直接连接至所有被选中的基础分析师节点。
2.  各基础分析师节点执行完毕后，统一连接至 `Index Bull Researcher`（作为汇聚节点）。
3.  `Index Bull Researcher` 负责收集 State 中各模块的输出（`macro_analysis`, `policy_analysis`, etc.），开启多空辩论。

#### 1.2.2 动态连线算法
1.  **节点池**：预先定义所有可能的分析师节点及其对应的工具节点、清理节点。
2.  **第一层（并行层）**：
    *   遍历 `selected_analysts`。
    *   将每个选中的 Analyst 节点与 `START` 相连。
    *   配置 Analyst <-> Tool 的循环边。
    *   将 Analyst 的结束边（通过 Clear Node）连接至 **汇聚节点** (`Index Bull Researcher`)。
3.  **第二层（汇聚与辩论）**：
    *   `Index Bull Researcher` <-> `Index Bear Researcher` (多空辩论)。
    *   辩论结束后 -> `Strategy Advisor`。

### 1.3 代码变更点
*   **`tradingagents/graph/trading_graph.py`**:
    *   `__init__`: 确保 `selected_analysts` 被正确保存到 `self.selected_analysts`。
    *   `setup_graph`: 调用 `_setup_index_graph` 时，传递 `selected_analysts` 参数（目前可能只传了 `state` 或为空）。

*   **`tradingagents/graph/setup.py`**:
    *   `_setup_index_graph`:
        *   移除原有的 `workflow.add_edge("Msg Clear Macro", "Policy Analyst")` 等串行连接代码。
        *   改为循环遍历 `selected_analysts`，对每个 Analyst 执行：
            *   `workflow.add_edge(START, f"{analyst_name} Analyst")`
            *   `workflow.add_edge(f"Msg Clear {analyst_name}", "Index Bull Researcher")`
*   **`app/services/simple_analysis_service.py`**:
    *   同前，移除强制清空逻辑。

## 2. 风险管理层集成设计

### 2.1 背景
指数分析目前止步于 `Strategy Advisor`，缺乏独立的风险验证环节。个股分析中的 `Risky/Neutral/Safe` 辩论机制效果良好，应引入指数分析。

### 2.2 节点复用与适配
*   **节点复用**：直接复用 `Risky Analyst`, `Neutral Analyst`, `Safe Analyst`, `Risk Judge` 对应的类和工厂函数。
*   **Prompt 适配**：通过 `analysis_type="index"` 参数在 Prompt 中注入不同的 System Context，引导 Risk Analyst 关注系统性风险、宏观波动率而非个股财务风险。

### 2.3 拓扑结构变更
**新结构**：
START -> [Macro, Policy, ...] (并行) -> Bull/Bear Debate -> Strategy Advisor -> **Risky Analyst** -> (Risk Loop) -> **Risk Judge** -> END

#### 2.3.1 连线逻辑
1.  `Strategy Advisor` 的输出指向 `Risky Analyst`。
2.  复制个股分析中的风险循环逻辑：
    *   `Risky` -> `Safe` / `Risk Judge`
    *   `Safe` -> `Neutral` / `Risk Judge`
    *   `Neutral` -> `Risky` / `Risk Judge`
3.  `Risk Judge` 输出指向 `END`。

## 3. 数据预验证机制设计

### 3.1 背景
指数分析目前跳过所有验证，导致输入错误代码（如 `000300` 漏掉后缀）或数据源不可用时，任务在 LLM 阶段才报错，浪费 Token。

### 3.2 验证逻辑
新增 `IndexValidator` 类或在 `MarketSymbolDetector` 中增强功能：
1.  **格式验证**：
    *   A股指数必须包含后缀 `.SH` 或 `.SZ` (如 `000001.SH`, `399001.SZ`)。
    *   美股/港股指数符合对应格式（如 `^GSPC`, `HSI`）。
2.  **数据源连通性检查 (轻量级)**：
    *   尝试调用 `akshare.stock_zh_index_daily` 获取最近一行数据。
    *   如果失败，立即抛出异常并提示用户检查数据源。

### 3.3 集成点
*   **`app/services/simple_analysis_service.py`**:
    *   在 `execute_analysis_background` 中，当 `analysis_type == "index"` 时，调用验证逻辑。
    *   如果验证失败，直接更新 Task 状态为 FAILED，不进入 Graph 执行。

## 4. 指数分析记忆机制设计

### 4.1 背景
为了让系统具备持续进化的能力，需要将个股分析中的“记忆-反思”机制引入指数分析。通过记录历史宏观环境与最终市场走势的关系，辅助 Agent 做出更准确的判断。

### 4.2 记忆注入与检索
复用 `FinancialSituationMemory` 类，但实例化为指数专用的集合：
*   `index_bull_memory`
*   `index_bear_memory`
*   `strategy_advisor_memory` (注意：复用此名，但在指数分析模式下存储指数相关的策略反思)

**注入流程**：
1.  在 `trading_graph.py` 初始化时创建上述 Memory 实例。
2.  通过 `setup.py` 将实例传递给 `create_index_bull_researcher`, `create_index_bear_researcher` 和 `create_strategy_advisor`。
3.  **Prompt 增强**：在 Agent 的 System Prompt 中增加 Retrieve 环节，查询 ChromaDB 中与当前 `Macro + Policy + Sector + News + Technical` 组合向量最相似的历史记录。

### 4.3 反思机制更新
修改 `tradingagents/graph/reflection.py`，增加指数场景支持：

1.  **情境提取 (`_extract_current_index_situation`)**：
    *   不同于个股关注财务数据，指数分析的情境由宏观报告、政策报告、行业综述、国际新闻和技术面分析组合而成。
    *   格式：`Macro Report \n Policy Report \n Sector Report \n ...`

2.  **反思执行 (`reflect_index_bull_researcher` 等)**：
    *   当外部调用 `reflect_and_remember` 时，根据 `analysis_type="index"` 路由到指数反思逻辑。
    *   LLM 根据 `Situation` 和 `Returns` 生成“Lesson”。
    *   将 `(Situation Vector, Lesson)` 存入向量库。
