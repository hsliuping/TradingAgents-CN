# 02-实时监控引擎详细设计 (Realtime Engine - Option A)

## 1. 设计目标
实现“按需加载”的实时数据获取能力，支持早盘/尾盘的辅助决策，确保数据的时效性在 5 分钟以内。采用轻量化设计，避免后台进程。

## 2. 核心机制：Lazy Load (懒加载)

### 2.1 工作流程
1. **触发**: 用户运行 `main_trading_assistant.py --session morning`。
2. **请求**: Agent 请求 `get_market_snapshot(mode='morning')`。
3. **检查**: `RealtimeMarketMonitor` 检查内存中是否有 < 5分钟 的快照。
   - **Yes**: 直接返回内存数据。
   - **No**: 
     - 触发 API 并发请求 (Tushare/Sina/Eastmoney)。
     - 组装数据。
     - 写入内存缓存。
     - 返回数据。
4. **销毁**: 脚本运行结束，进程退出，内存缓存自动释放。

## 3. 模块设计

### 3.1 `RealtimeMarketMonitor` 类

```python
class RealtimeMarketMonitor:
    def __init__(self, provider: HybridIndexDataProvider):
        self.provider = provider
        self._memory_cache = {}  # {key: (timestamp, data)}
        self.CACHE_TTL = 300     # 5分钟
        
    def get_morning_snapshot(self) -> dict:
        """
        获取早盘快照 (09:15 - 10:00)
        包含:
        1. 隔夜外盘 (美股/A50)
        2. 集合竞价成交额
        3. 开盘15分钟资金流
        """
        pass
        
    def get_closing_snapshot(self) -> dict:
        """
        获取尾盘快照 (14:30 - 15:00)
        包含:
        1. 全天主力净流入
        2. 尾盘30分钟突袭板块
        3. 涨跌家数比 (ADR)
        """
        pass
```

### 3.2 数据结构定义

#### Morning Snapshot
```json
{
  "timestamp": "2023-10-27 09:31:00",
  "global_market": {
    "us_close": "涨",
    "a50_future": "跌"
  },
  "call_auction": {
    "volume": 100000000,
    "sentiment": "neutral"
  },
  "opening_flow": {
    "sector_inflow_top3": ["半导体", "证券", "白酒"],
    "sector_outflow_top3": ["房地产", "银行"]
  }
}
```

#### Closing Snapshot
```json
{
  "timestamp": "2023-10-27 14:45:00",
  "daily_trend": "V型反转",
  "main_fund_net": -50000000,
  "late_session_action": {
    "sudden_inflow_sectors": ["券商"],
    "divergence_warning": false
  }
}
```

## 4. 关键技术点

### 4.1 绕过 MongoDB 缓存
在 `HybridIndexDataProvider` 中增加 `force_refresh` 参数：
```python
def get_realtime_fund_flow(self, force_refresh=False):
    if force_refresh:
        # 即使 DB 有数据也忽略，直接调 API
        return self._fetch_from_api()
    # 常规逻辑...
```

### 4.2 API 性能优化
- 使用 `ThreadPoolExecutor` 并行请求不同板块的数据（如同时请求行业、概念、ETF资金流）。
- 设置严格的 `timeout` (如 3秒)，超时则返回部分数据或空值，避免阻塞主流程。

## 5. 休市与非交易时段处理 (Off-Hours Handling)

### 5.1 数据回退机制
当用户在非交易时段（如晚上 20:00）运行“早盘/尾盘模式”时，系统**不会报错**，而是返回**最近一次有效的市场快照**。

- **行为逻辑**:
    - **API 层面**: Tushare/Sina 接口在休市期间会返回当日收盘数据。
    - **Engine 层面**: `RealtimeMarketMonitor` 会检测当前系统时间。
        - 若 `Now > 15:00`: 返回当日收盘快照（等同于下午盘数据）。
        - 若 `Now < 09:15`: 返回昨日收盘数据 + 提示 "Market Not Open"。
    - **Agent 层面**: Prompt 中会自动注入时间警告："当前非实时交易时段，以下数据为最近一次收盘快照，仅供复盘分析使用。"

### 5.2 流程兼容性
- **盘中模式 (Morning/Afternoon)**: 强依赖 `RealtimeMarketMonitor`，关注瞬时变化。
- **盘后模式 (Post-Market)**: 自动切换回 `HybridIndexDataProvider` 的**日线接口** (Stable Daily Data)，关注全天最终结论，与盘中逻辑完全解耦，互不干扰。

## 6. 自动化调度策略 (Automated Scheduling)

为了避免人工手动触发脚本，将利用系统现有的 `SchedulerService` (APScheduler) 进行自动化托管。考虑到 Agent 分析流程需要消耗一定时间 (约 3-5 分钟)，触发时间需提前预留缓冲。

### 6.1 调度时间表

| 场景 | 触发时间 (Cron) | 预期完成时间 | 决策窗口 | 数据覆盖范围 |
| :--- | :--- | :--- | :--- | :--- |
| **早盘决策 (Morning)** | `45 9 * * 1-5` (09:45) | 09:50 | 09:50 - 10:00 | 集合竞价 + 开盘前15分钟资金流 |
| **尾盘决策 (Afternoon)** | `35 14 * * 1-5` (14:35) | 14:40 | 14:40 - 15:00 | 全天趋势 + 尾盘前1小时资金博弈 |
| **盘后复盘 (Post)** | `30 15 * * 1-5` (15:30) | 15:35 | N/A | 全天完整收盘数据 |

### 6.2 执行缓冲分析
- **早盘**: 
    - 09:30 - 09:45: 市场最剧烈波动期，数据噪音大。
    - 09:45 触发: 此时初步趋势已形成，Agent 获取数据 + 推理耗时约 5 分钟。
    - 09:50 产出报告: 用户有 10-40 分钟的时间进行上午的买入/卖出操作。
- **尾盘**: 
    - **核心痛点**: A股收盘为 15:00，决策必须在此之前执行。
    - 14:35 触发: 预留 5 分钟给 Agent 分析。
    - 14:40 产出报告: **关键**。用户有整整 20 分钟的时间来从容下单（特别是针对尾盘抢筹或避险减仓）。若定在 14:50 触发，留给用户的操作时间仅剩 2-3 分钟，风险极高。
