# å¼€å‘è®¡åˆ’ 04 - è¾…åŠ©æ•°æ®æºæ¢æµ‹ä¸æ™ºèƒ½é™çº§

## 1. ä»»åŠ¡ç›®æ ‡

å®ç°ç»Ÿä¸€çš„æ•°æ®æºå¥åº·æ£€æŸ¥ä¸çŠ¶æ€ç®¡ç†æœºåˆ¶ï¼Œç¡®ä¿æŒ‡æ•°åˆ†æWorkflowèƒ½å¤Ÿï¼š
- åœ¨æ‰§è¡Œå‰ä¸»åŠ¨æ¢æµ‹æ‰€æœ‰æ•°æ®æºå¯ç”¨æ€§
- **ç¼“å­˜ä¼˜å…ˆ**ï¼šå¯¹äºå®è§‚ç­‰ä½é¢‘æ•°æ®ï¼Œä¼˜å…ˆæ£€æŸ¥æœ¬åœ°ç¼“å­˜ï¼Œå‘½ä¸­åˆ™è§†ä¸ºå¯ç”¨
- **å¼‚æ­¥å¹¶è¡Œ**ï¼šå¹¶è¡Œæ‰§è¡Œæ¢æµ‹ä»»åŠ¡ï¼Œå°†æ€»å»¶è¿Ÿæ§åˆ¶åœ¨æœ€å°èŒƒå›´å†…
- åœ¨æ•°æ®æºä¸å¯ç”¨æ—¶ä¼˜é›…é™çº§ï¼Œé¿å…Workflowå¤±è´¥
- ç»´æŠ¤å…¨å±€æ•°æ®æºçŠ¶æ€ï¼Œä¾›å„Agentå…±äº«ä½¿ç”¨

## 2. æ ¸å¿ƒè®¾è®¡ç†å¿µ

### 2.1 é«˜æ€§èƒ½æ¢æµ‹æ¶æ„
- **å¼‚æ­¥å¹¶è¡Œ (Async Parallel)**: ä½¿ç”¨ `asyncio.gather` å¹¶è¡Œå‘å‡ºæ¢æµ‹è¯·æ±‚ï¼Œæ€»è€—æ—¶ â‰ˆ æœ€æ…¢çš„å•ä¸€æ¢æµ‹æ¥å£è€—æ—¶ï¼ˆ<3ç§’ï¼‰ï¼Œè€Œéä¸²è¡Œç´¯åŠ ã€‚
- **ç¼“å­˜è±å… (Cache Exemption)**: å³ä½¿å¤–éƒ¨ API ä¸å¯ç”¨ï¼Œåªè¦æœ¬åœ°ç¼“å­˜ï¼ˆMongoDB/Fileï¼‰å­˜åœ¨ä¸”åœ¨æœ‰æ•ˆæœŸå†…ï¼Œä»æ ‡è®°æ•°æ®æºä¸ºâ€œå¯ç”¨â€ã€‚

### 2.2 çŠ¶æ€ç®¡ç†
- **å…¨å±€å…±äº«**: çŠ¶æ€ä¿¡æ¯åœ¨ `AgentState` å…¨å±€çŠ¶æ€ä¸­ç»´æŠ¤ã€‚
- **æ™ºèƒ½é™çº§**: åŸºäºå…¨å±€çŠ¶æ€åŠ¨æ€è°ƒæ•´ Agent çš„å·¥å…·åˆ—è¡¨ï¼Œç”šè‡³ç›´æ¥è·³è¿‡ LLM è°ƒç”¨ã€‚

## 3. è¯¦ç»†è®¾è®¡

### 3.1 æ•°æ®æºå¥åº·æ£€æŸ¥èŠ‚ç‚¹

#### 3.1.1 èŠ‚ç‚¹ä½ç½®
```
START â†’ Index Info Collector â†’ Data Source Health Manager (Async) â†’ Barrier â†’ Analysts
```

#### 3.1.2 æ£€æŸ¥é€»è¾‘ä¸ç­–ç•¥
| æ•°æ®æºæ ‡è¯† | æ£€æŸ¥å†…å®¹ | ç¼“å­˜è±å…ç­–ç•¥ | æ¢æµ‹æ–¹å¼ (Timeout=3s) | é™çº§è¡Œä¸º |
|----------|----------|------------|----------|----------|
| `macro_db` | å®è§‚ç»æµæ•°æ® | **æ˜¯** (7å¤©å†…æœ‰æ•ˆ) | `fetch_macro_data` (Light) | è·³è¿‡LLMï¼Œè¿”å›é™æ€ç®€æŠ¥ |
| `news_api` | å›½é™…/å›½å†…æ–°é—» | å¦ (éœ€å®æ—¶) | HEADè¯·æ±‚ / ç©ºæœç´¢ | ä»…åŸºäºèƒŒæ™¯ä¿¡æ¯ç”ŸæˆæŠ¥å‘Š |
| `policy_db` | æ”¿ç­–æ–‡ä»¶åº“ | **æ˜¯** (30å¤©å†…æœ‰æ•ˆ) | æ£€æŸ¥æ•°æ®åº“è¿æ¥ | ä½¿ç”¨å†å²æ”¿ç­–æ‘˜è¦ |
| `sector_data` | è¡Œä¸šæ¿å—æ•°æ® | **æ˜¯** (24å°æ—¶å†…æœ‰æ•ˆ)| è·å–æ¿å—åˆ—è¡¨ | ä½¿ç”¨é»˜è®¤æ¿å—é…ç½® |
| `technical` | æŠ€æœ¯æŒ‡æ ‡æ¥å£ | å¦ (éœ€æœ€æ–°è¡Œæƒ…) | è·å–æœ€è¿‘Kçº¿ | ç®€åŒ–æŠ€æœ¯åˆ†æ/è·³è¿‡ |

#### 3.1.3 çŠ¶æ€æ•°æ®ç»“æ„
åœ¨ `AgentState` ä¸­æ–°å¢ `data_source_status` å­—å…¸ï¼š
```python
# å…¨å±€çŠ¶æ€æ‰©å±•
state.update({
    "data_source_status": {
        "macro_db": True,      # å¯ç”¨ (æ¥è‡ªç¼“å­˜æˆ–API)
        "news_api": False,     # ä¸å¯ç”¨ (APIè¶…æ—¶ä¸”æ— ç¼“å­˜)
        "policy_db": True,
        # ...
    },
    "data_source_details": {   # è¯¦ç»†è°ƒè¯•ä¿¡æ¯
        "macro_db": {"source": "cache", "latency": 0.01},
        "news_api": {"error": "Timeout", "latency": 3.02}
    }
})
```

### 3.2 Agent æ™ºèƒ½é€‚é…

#### 3.2.1 ç†”æ–­ä¸é™çº§æœºåˆ¶
å„ Analyst åœ¨æ‰§è¡Œå‰æ£€æŸ¥ `data_source_status`ï¼š

1.  **ç†”æ–­ (Circuit Breaker)**: 
    - å¦‚æœæ ¸å¿ƒæ•°æ®æºå®Œå…¨ä¸å¯ç”¨ä¸”æ— ç¼“å­˜ï¼Œ**ç›´æ¥è¿”å›é¢„åˆ¶ JSON**ã€‚
    - **æ”¶ç›Š**: èŠ‚çœ LLM Tokenï¼Œé¿å…æ— æ•ˆç­‰å¾…ã€‚
    - *ç¤ºä¾‹*: News Analyst å‘ç° `news_api=False`ï¼Œç›´æ¥è¿”å› `{"overall_impact": "æ•°æ®å—é™", ...}`ã€‚

2.  **é™çº§ (Graceful Degradation)**:
    - å¦‚æœé¦–é€‰æºä¸å¯ç”¨ä½†æœ‰å¤‡é€‰æºï¼Œåˆ‡æ¢å·¥å…·ã€‚
    - *ç¤ºä¾‹*: Bloomberg ä¸å¯ç”¨ -> åˆ‡æ¢è‡³ Google Newsã€‚

#### 3.2.2 åŠ¨æ€å·¥å…·ç»‘å®š
```python
def get_tools_for_analyst(analyst_type, state):
    status = state.get("data_source_status", {})
    
    if analyst_type == "news" and not status.get("news_api"):
        return [] # ä¸ç»‘å®šå·¥å…·ï¼Œç”šè‡³ç›´æ¥è·³è¿‡èŠ‚ç‚¹æ‰§è¡Œ
        
    # ... æ­£å¸¸ç»‘å®šé€»è¾‘
```

## 4. å¼€å‘æ­¥éª¤

### 4.1 ç¬¬ä¸€é˜¶æ®µï¼šæ ¸å¿ƒèŠ‚ç‚¹å¼€å‘ï¼ˆ2-3äººå¤©ï¼‰

#### æ­¥éª¤1ï¼šå®ç°å¼‚æ­¥æ¢æµ‹ç±»
- [ ] åˆ›å»º `tradingagents/graph/data_probes.py`
- [ ] å®ç° `DataSourceProbe` ç±»ï¼ŒåŒ…å«å„æºçš„ `async` æ¢æµ‹æ–¹æ³•ã€‚
- [ ] **å…³é”®**: å®ç°â€œå…ˆæŸ¥ç¼“å­˜ï¼ŒåæŸ¥APIâ€çš„é€»è¾‘ã€‚

#### æ­¥éª¤2ï¼šåˆ›å»ºå¥åº·æ£€æŸ¥èŠ‚ç‚¹
- [ ] åœ¨ `tradingagents/graph/nodes/health_check.py` ä¸­å®ç°èŠ‚ç‚¹é€»è¾‘ã€‚
- [ ] ä½¿ç”¨ `asyncio.gather` å¹¶è¡Œæ‰§è¡Œæ‰€æœ‰æ¢æµ‹ã€‚
- [ ] æ ¹æ® `market_type` (Aè‚¡/æ¸¯è‚¡/ç¾è‚¡) è¿‡æ»¤ä¸éœ€è¦æ¢æµ‹çš„æºã€‚

#### æ­¥éª¤3ï¼šé›†æˆåˆ°å·¥ä½œæµ
- [ ] ä¿®æ”¹ `tradingagents/graph/setup.py`ã€‚
- [ ] åœ¨ `Index Info Collector` åæ’å…¥ `Data Source Health Manager`ã€‚

### 4.2 ç¬¬äºŒé˜¶æ®µï¼šAgenté€‚é…ï¼ˆ2-3äººå¤©ï¼‰

#### æ­¥éª¤4ï¼šæ”¹é€  Analyst
- [ ] ä¿®æ”¹ `International News Analyst`: å¢åŠ ç†”æ–­é€»è¾‘ã€‚
- [ ] ä¿®æ”¹ `Macro Analyst`: é€‚é…ç¼“å­˜ä¼˜å…ˆé€»è¾‘ã€‚
- [ ] ä¿®æ”¹ `Strategy Advisor`: Prompt ä¸­å¢åŠ å¯¹â€œæ•°æ®å—é™â€æƒ…å†µçš„å¤„ç†æŒ‡ä»¤ã€‚

### 4.3 ç¬¬ä¸‰é˜¶æ®µï¼šæµ‹è¯•ï¼ˆ1-2äººå¤©ï¼‰

#### æ­¥éª¤5ï¼šæ¨¡æ‹Ÿæµ‹è¯•
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•ï¼Œæ¨¡æ‹Ÿ API è¶…æ—¶ã€æ–­ç½‘ç­‰åœºæ™¯ã€‚
- [ ] éªŒè¯ `asyncio.gather` çš„å¹¶è¡Œæ€§èƒ½ï¼ˆæ€»è€—æ—¶åº”æ¥è¿‘å•æ¬¡æœ€å¤§è¶…æ—¶ï¼‰ã€‚
- [ ] éªŒè¯ç¼“å­˜å‘½ä¸­æ—¶æ˜¯å¦æ­£ç¡®è·³è¿‡äº†ç½‘ç»œè¯·æ±‚ã€‚

## 5. æŠ€æœ¯å®ç°ç»†èŠ‚ (æ ¸å¿ƒä»£ç ç‰‡æ®µ)

### 5.1 å¼‚æ­¥å¹¶è¡Œæ¢æµ‹å®ç°
```python
import asyncio

class DataSourceProbe:
    @staticmethod
    async def probe_macro(index_code: str) -> dict:
        # 1. Check Cache First
        if check_local_cache("macro", index_code):
            return {"available": True, "source": "cache", "latency": 0}
            
        # 2. Check API (Async)
        try:
            start = time.time()
            # å‡è®¾ fetch_macro_api æ˜¯å¼‚æ­¥çš„ï¼Œæˆ–è€…ç”¨ run_in_executor åŒ…è£…
            await asyncio.wait_for(fetch_macro_api_async(), timeout=3.0)
            return {"available": True, "source": "api", "latency": time.time() - start}
        except Exception as e:
            return {"available": False, "error": str(e)}

    @staticmethod
    async def run_all_probes(index_code: str, market_type: str):
        tasks = {
            "macro_db": DataSourceProbe.probe_macro(index_code),
            "news_api": DataSourceProbe.probe_news(),
            # ...
        }
        
        # å¹¶è¡Œæ‰§è¡Œ
        results = await asyncio.gather(*tasks.values(), return_exceptions=True)
        return dict(zip(tasks.keys(), results))
```

### 5.2 èŠ‚ç‚¹ä¸­çš„å¼‚æ­¥è°ƒç”¨é€‚é…
ç”±äº LangGraph èŠ‚ç‚¹å¯èƒ½æ˜¯åŒæ­¥ç¯å¢ƒï¼Œéœ€æ­£ç¡®å¤„ç† Event Loopï¼š
```python
def health_check_node(state):
    # ... è·å– index_code ç­‰ ...
    
    try:
        loop = asyncio.get_event_loop()
    except RuntimeError:
        loop = asyncio.new_event_loop()
        asyncio.set_event_loop(loop)
        
    # æ‰§è¡Œå¹¶è¡Œæ¢æµ‹
    status_map = loop.run_until_complete(
        DataSourceProbe.run_all_probes(index_code, market_type)
    )
    
    return {"data_source_status": status_map}
```

## 6. éªŒæ”¶æ ‡å‡†

- âœ… **å¹¶è¡Œæ€§èƒ½**: æ‰€æœ‰æºæ¢æµ‹çš„æ€»è€—æ—¶ < 3ç§’ã€‚
- âœ… **ç¼“å­˜ç”Ÿæ•ˆ**: å½“æœ¬åœ°æœ‰æœ‰æ•ˆç¼“å­˜æ—¶ï¼Œæ–­ç½‘ä¹Ÿèƒ½æ ‡è®°ä¸ºâ€œå¯ç”¨â€ã€‚
- âœ… **ä¼˜é›…é™çº§**: æ–°é—»æºä¸å¯ç”¨æ—¶ï¼ŒWorkflow ä¸æŠ¥é”™ï¼Œè€Œæ˜¯ç”Ÿæˆä¸€ä»½â€œå—é™æŠ¥å‘Šâ€ã€‚
- âœ… **èµ„æºèŠ‚çœ**: é™çº§æ¨¡å¼ä¸‹ï¼Œç›¸å…³ Agent ä¸æ¶ˆè€— LLM Tokenã€‚

## 7. å½“å‰è¿›åº¦

**çŠ¶æ€**: ğŸ“‹ è§„åˆ’å®Œæˆï¼Œå¾…å¼€å‘
**ä¼˜å…ˆçº§**: ğŸ”´ é«˜ï¼ˆv2.6.0è¡¥ä¸ï¼‰
**é¢„è®¡å·¥ä½œé‡**: 5-8äººå¤©
**åˆ›å»ºæ—¶é—´**: 2026-01-03
**æœ€åæ›´æ–°**: 2026-01-03
