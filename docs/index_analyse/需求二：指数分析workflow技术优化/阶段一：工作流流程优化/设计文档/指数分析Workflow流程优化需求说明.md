# 指数分析 Workflow 流程优化需求说明书

## 1. 引言

### 1.1 编写目的
本文档旨在详细阐述指数分析 Workflow 在性能、功能和架构层面的优化需求，整合了宏观分析缓存、职能重构、节点优化及多空风控增强等多个维度的改进意见。

### 1.2 背景
当前的指数分析 Workflow 虽然框架完整，但在实际运行中暴露出重复计算、职能重叠、分析深度不足等问题。为了提升系统的专业性、效率和用户体验，需要对现有流程进行深度优化。

## 2. 业务需求

### 2.1 性能与成本优化
*   **宏观分析缓存**: 由于宏观数据更新频率低，系统需缓存 `Macro Analyst` 的分析结果（有效期7天），避免重复计算和 API 调用。
*   **动态 Agent 选择**: 用户应能根据需求（如仅关注宏观和政策）动态选择参与分析的 Agent，而非强制全量运行，以节省成本和时间。

### 2.2 职能清晰化与增强
*   **政策与新闻分离**:
    *   **战略政策分析**: 专注于长期、官方政策文本（如五年规划、白皮书）的深度解读，屏蔽短期噪音。
    *   **综合新闻分析**: 统筹所有短期、即时性的国内外新闻、事件及传闻，统一评估其市场影响。
*   **情绪维度补全**: 引入 `Sentiment Analyst`，填补当前对市场情绪（社交媒体热度、恐慌/贪婪指数）分析的空白。**（已规划至后续版本）**
*   **全球情报扩展**: 升级国际新闻分析，覆盖 Twitter、Reddit 等新兴渠道。

### 2.3 决策质量提升
*   **研究深度参数强化**: `research_depth` 参数需实质性影响分析深度。
    *   **深度模式**: 强制进行跨周期对比（如对比2008年、2018年）、极端情境推演及多维度的逻辑交叉验证。
*   **多空博弈优化**: 辩论不应流于形式，需基于历史相似模式匹配（Pattern Matching）进行有据可依的辩论。

### 2.4 风险管理深化
*   **系统性风险关注**: 风险管理层在指数模式下应专注于宏观流动性、政策转向及地缘政治等系统性风险，而非个股层面的财务风险。
*   **量化风险传导**: 要求详细列出风险传导路径（如：美联储加息 -> 汇率贬值 -> 资金外流 -> 核心资产重估）。

## 3. 功能需求

### 3.1 宏观分析缓存
*   **输入**: 交易日期。
*   **处理**: 检查 MongoDB 是否有有效期内的缓存。
*   **输出**: 若命中则直接返回缓存报告，否则执行分析并写入缓存。

### 3.2 动态图构建
*   **输入**: 用户选定的 Agent 列表 (`selected_analysts`)。
*   **处理**: 在图构建阶段动态激活或跳过相应节点。
*   **输出**: 定制化的执行路径。

### 3.3 新增/重构节点
*   **Strategic Policy Analyst**: 输入官方文档/政策新闻，输出长期政策深度报告。
*   **News Analyst**: 输入多源新闻流，输出短期市场影响评估。
*   **Sentiment Analyst** (后续版本规划): 输入社交媒体数据，输出情绪评分和热度榜单。详细规划见 [`../../../待规划需求/情绪分析agent.md`](../../../待规划需求/情绪分析agent.md)

### 3.4 数据源健壮性
*   **前置检查**: 在 Workflow 初期探测辅助数据源（新闻、宏观API）连通性。
*   **优雅降级**: 源不可用时标记状态，后续节点自动跳过并生成降级报告。

## 4. 非功能需求

*   **响应时间**: 缓存命中时，宏观分析节点响应时间应 < 1秒。
*   **可扩展性**: 新增节点（如情绪分析）应能无缝插入现有并行结构。
*   **健壮性**: 单个数据源故障不应导致整个 Workflow 崩溃。