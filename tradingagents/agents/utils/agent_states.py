from typing import Annotated, Sequence
from datetime import date, timedelta, datetime
from typing_extensions import TypedDict, Optional
from langchain_openai import ChatOpenAI
from tradingagents.agents import *
from langgraph.prebuilt import ToolNode
from langgraph.graph import END, StateGraph, START, MessagesState

# å¯¼å…¥ç»Ÿä¸€æ—¥å¿—ç³»ç»Ÿ
from tradingagents.utils.logging_init import get_logger
logger = get_logger("default")


# Researcher team state
class InvestDebateState(TypedDict):
    bull_history: Annotated[
        str, "Bullish Conversation history"
    ]  # Bullish Conversation history
    bear_history: Annotated[
        str, "Bearish Conversation history"
    ]  # Bullish Conversation history
    history: Annotated[str, "Conversation history"]  # Conversation history
    current_response: Annotated[str, "Latest response"]  # Last response
    judge_decision: Annotated[str, "Final judge decision"]  # Last response
    count: Annotated[int, "Length of the current conversation"]  # Conversation length


# Risk management team state
class RiskDebateState(TypedDict):
    risky_history: Annotated[
        str, "Risky Agent's Conversation history"
    ]  # Conversation history
    safe_history: Annotated[
        str, "Safe Agent's Conversation history"
    ]  # Conversation history
    neutral_history: Annotated[
        str, "Neutral Agent's Conversation history"
    ]  # Conversation history
    history: Annotated[str, "Conversation history"]  # Conversation history
    latest_speaker: Annotated[str, "Analyst that spoke last"]
    current_risky_response: Annotated[
        str, "Latest response by the risky analyst"
    ]  # Last response
    current_safe_response: Annotated[
        str, "Latest response by the safe analyst"
    ]  # Last response
    current_neutral_response: Annotated[
        str, "Latest response by the neutral analyst"
    ]  # Last response
    judge_decision: Annotated[str, "Judge's decision"]
    count: Annotated[int, "Length of the current conversation"]  # Conversation length


class AgentState(MessagesState):
    """å…¨å±€çŠ¶æ€ï¼Œæ”¯æŒä¸ªè‚¡åˆ†æå’ŒæŒ‡æ•°åˆ†æä¸¤ç§æ¨¡å¼"""
    
    # ========== é€šç”¨å­—æ®µ ==========
    company_of_interest: Annotated[str, "Company/Index code we are analyzing"]
    trade_date: Annotated[str, "What date we are trading at"]
    sender: Annotated[str, "Agent that sent this message"]
    
    # ========== è·¯ç”±æ ‡è¯† (æ–°å¢) ==========
    is_index: Annotated[bool, "True for index analysis, False for stock analysis"]

    # ========== ä¸ªè‚¡åˆ†æå­—æ®µ (ç°æœ‰ï¼Œä¿æŒä¸å˜) ==========
    # research step
    market_report: Annotated[str, "Report from the Market Analyst"]
    sentiment_report: Annotated[str, "Report from the Social Media Analyst"]
    news_report: Annotated[
        str, "Report from the News Researcher of current world affairs"
    ]
    fundamentals_report: Annotated[str, "Report from the Fundamentals Researcher"]

    # ğŸ”§ æ­»å¾ªç¯ä¿®å¤: å·¥å…·è°ƒç”¨è®¡æ•°å™¨
    market_tool_call_count: Annotated[int, "Market analyst tool call counter"]
    news_tool_call_count: Annotated[int, "News analyst tool call counter"]
    sentiment_tool_call_count: Annotated[int, "Social media analyst tool call counter"]
    fundamentals_tool_call_count: Annotated[int, "Fundamentals analyst tool call counter"]

    # researcher team discussion step
    investment_debate_state: Annotated[
        InvestDebateState, "Current state of the debate on if to invest or not"
    ]
    investment_plan: Annotated[str, "Plan generated by the Analyst"]

    trader_investment_plan: Annotated[str, "Plan generated by the Trader"]

    # risk management team discussion step
    risk_debate_state: Annotated[
        RiskDebateState, "Current state of the debate on evaluating risk"
    ]
    final_trade_decision: Annotated[str, "Final decision made by the Risk Analysts"]
    
    # ========== æŒ‡æ•°åˆ†æå­—æ®µ (æ–°å¢) ==========
    # å®è§‚ç»æµåˆ†æ
    macro_report: Annotated[str, "Report from Macro Analyst (JSON format with confidence)"]
    macro_tool_call_count: Annotated[int, "Macro analyst tool call counter"]
    
    # æ”¿ç­–åˆ†æ
    policy_report: Annotated[str, "Report from Policy Analyst (JSON format with confidence)"]
    policy_tool_call_count: Annotated[int, "Policy analyst tool call counter"]
    
    # æ¿å—è½®åŠ¨åˆ†æ
    sector_report: Annotated[str, "Report from Sector Analyst (JSON format with confidence)"]
    sector_tool_call_count: Annotated[int, "Sector analyst tool call counter"]
    
    # ç­–ç•¥è¾“å‡º
    strategy_report: Annotated[str, "Final strategy report from Strategy Advisor"]
