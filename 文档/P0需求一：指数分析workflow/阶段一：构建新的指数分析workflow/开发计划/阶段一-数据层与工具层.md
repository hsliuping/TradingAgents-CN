# é˜¶æ®µä¸€ï¼šæ•°æ®å±‚ä¸å·¥å…·å±‚å¼€å‘æ–¹æ¡ˆ

## ğŸ“‹ é˜¶æ®µæ¦‚è¿°

**ç›®æ ‡**ï¼šå»ºç«‹æŒ‡æ•°åˆ†æçš„æ•°æ®åŸºç¡€è®¾æ–½ï¼ŒåŒ…æ‹¬æ•°æ®æä¾›è€…ã€LangChainå·¥å…·å°è£…å’ŒPydanticæ¨¡å‹å®šä¹‰ã€‚

**é¢„è®¡æ—¶é—´**ï¼š2-3å¤©  
**ä¼˜å…ˆçº§**ï¼šğŸ”´ æœ€é«˜ï¼ˆåŸºç¡€è®¾æ–½ï¼‰

---

## ğŸ¯ æœ¬é˜¶æ®µäº¤ä»˜ç‰©

### æ–°å»ºæ–‡ä»¶
1. `tradingagents/dataflows/index_data.py` - æ•°æ®æä¾›è€…ç±»
2. `tradingagents/tools/index_tools.py` - LangChainå·¥å…·å°è£…
3. `tradingagents/agents/utils/analysis_schemas.py` - Pydanticæ¨¡å‹å®šä¹‰
4. `tests/dataflows/test_index_data.py` - æ•°æ®å±‚å•å…ƒæµ‹è¯•
5. `tests/tools/test_index_tools.py` - å·¥å…·å±‚å•å…ƒæµ‹è¯•
6. `tests/utils/test_analysis_schemas.py` - Schemaå•å…ƒæµ‹è¯•

### ä¾èµ–é¡¹
- akshareï¼šæ•°æ®æº
- MongoDBï¼šæ•°æ®ç¼“å­˜
- langchainï¼šå·¥å…·å°è£…
- pydanticï¼šæ•°æ®æ¨¡å‹

---

## ğŸ“ è¯¦ç»†å¼€å‘ä»»åŠ¡

### ä»»åŠ¡1.1ï¼šåˆ›å»ºIndexDataProviderç±»

**æ–‡ä»¶**ï¼š`tradingagents/dataflows/index_data.py`

**åŠŸèƒ½æ¸…å•**ï¼š
- [ ] `IndexDataProvider` ç±»å®šä¹‰
- [ ] `get_macro_economics_data()` - è·å–å®è§‚ç»æµæ•°æ®
  - GDPï¼ˆå­£åº¦ï¼‰
  - CPIï¼ˆæœˆåº¦ï¼‰
  - PMIï¼ˆæœˆåº¦ï¼‰
  - M2è´§å¸ä¾›åº”é‡
  - LPRåˆ©ç‡
- [ ] `get_policy_news()` - è·å–æ”¿ç­–æ–°é—»
  - æ–°é—»è”æ’­æ–‡å­—ç¨¿
  - é™çº§æ–¹æ¡ˆï¼šç™¾åº¦è´¢ç»æ–°é—»
- [ ] `get_sector_flows()` - è·å–æ¿å—èµ„é‡‘æµå‘
  - ä¸œæ–¹è´¢å¯Œæ¿å—èµ„é‡‘æµ
  - é™çº§æ–¹æ¡ˆï¼šæ¿å—åç§°åˆ—è¡¨
- [ ] MongoDBç¼“å­˜æœºåˆ¶
  - ç¼“å­˜é”®è®¾è®¡
  - TTLè®¾ç½®ï¼ˆå®è§‚æ•°æ®24hï¼Œæ–°é—»6hï¼‰
- [ ] é”™è¯¯å¤„ç†å’Œé™çº§é€»è¾‘

**å‚è€ƒä»£ç ä½ç½®**ï¼šè¯¦ç»†è®¾è®¡æ–‡æ¡£ ç¬¬2.1èŠ‚

**å®ç°è¦ç‚¹**ï¼š
```python
class IndexDataProvider:
    def __init__(self):
        self.cache = get_cache()
        self.cache_ttl = 86400  # 24å°æ—¶
    
    def get_macro_economics_data(self, end_date: str = None) -> Dict[str, Any]:
        # 1. æ£€æŸ¥ç¼“å­˜
        # 2. è°ƒç”¨AKShareè·å–æ•°æ®
        # 3. å¼‚å¸¸å¤„ç†å’Œé™çº§
        # 4. ç¼“å­˜ç»“æœ
        pass
```

**éªŒè¯æ ‡å‡†**ï¼š
- âœ… æˆåŠŸè·å–æ‰€æœ‰å®è§‚æŒ‡æ ‡æ•°æ®
- âœ… ç¼“å­˜æœºåˆ¶æ­£å¸¸å·¥ä½œï¼ˆç¬¬äºŒæ¬¡è°ƒç”¨ä»ç¼“å­˜è¯»å–ï¼‰
- âœ… APIå¤±è´¥æ—¶é™çº§æ–¹æ¡ˆç”Ÿæ•ˆ
- âœ… æ—¥å¿—è®°å½•æ¸…æ™°

---

### ä»»åŠ¡1.2ï¼šåˆ›å»ºLangChainå·¥å…·

**æ–‡ä»¶**ï¼š`tradingagents/tools/index_tools.py`

**åŠŸèƒ½æ¸…å•**ï¼š
- [ ] `fetch_macro_data` å·¥å…·
  - ä½¿ç”¨ `@tool` è£…é¥°å™¨
  - å‚æ•°ï¼šquery_date (str)
  - è¿”å›ï¼šMarkdownæ ¼å¼çš„å®è§‚æ•°æ®
- [ ] `fetch_policy_news` å·¥å…·
  - å‚æ•°ï¼šlookback_days (int)
  - è¿”å›ï¼šMarkdownæ ¼å¼çš„æ”¿ç­–æ–°é—»
- [ ] `fetch_sector_rotation` å·¥å…·
  - å‚æ•°ï¼štrade_date (str)
  - è¿”å›ï¼šMarkdownæ ¼å¼çš„æ¿å—æ•°æ®
- [ ] `INDEX_ANALYSIS_TOOLS` åˆ—è¡¨

**å‚è€ƒä»£ç ä½ç½®**ï¼šè¯¦ç»†è®¾è®¡æ–‡æ¡£ ç¬¬2.2èŠ‚

**å®ç°è¦ç‚¹**ï¼š
```python
from langchain.tools import tool
from typing import Annotated

@tool
def fetch_macro_data(query_date: Annotated[str, "æŸ¥è¯¢æ—¥æœŸï¼Œæ ¼å¼ yyyy-mm-dd"]) -> str:
    """è·å–æŒ‡å®šæ—¥æœŸçš„å®è§‚ç»æµæŒ‡æ ‡"""
    try:
        data = index_data_provider.get_macro_economics_data(query_date)
        # æ ¼å¼åŒ–ä¸ºMarkdown
        return format_to_markdown(data)
    except Exception as e:
        return f"å®è§‚æ•°æ®è·å–å¤±è´¥: {str(e)}"
```

**éªŒè¯æ ‡å‡†**ï¼š
- âœ… å·¥å…·å¯ä»¥è¢«LangChainæ­£ç¡®è¯†åˆ«
- âœ… å‚æ•°ç±»å‹æç¤ºå®Œæ•´
- âœ… è¿”å›æ ¼å¼åŒ–çš„Markdownæ–‡æœ¬
- âœ… å¼‚å¸¸å¤„ç†å®Œå–„

---

### ä»»åŠ¡1.3ï¼šå®šä¹‰Pydantic Schema

**æ–‡ä»¶**ï¼š`tradingagents/agents/utils/analysis_schemas.py`

**åŠŸèƒ½æ¸…å•**ï¼š
- [ ] `MacroAnalysis` æ¨¡å‹
  - economic_cycle, liquidity, key_indicators
  - analysis_summary, confidence, sentiment_score
- [ ] `PolicyAnalysis` æ¨¡å‹
  - monetary_policy, fiscal_policy, industry_policy
  - key_events, market_impact, analysis_summary
  - confidence, sentiment_score
- [ ] `SectorAnalysis` æ¨¡å‹
  - top_sectors, bottom_sectors, rotation_trend
  - hot_themes, analysis_summary
  - confidence, sentiment_score
- [ ] `StrategyOutput` æ¨¡å‹
  - market_outlook, recommended_position
  - key_risks, opportunity_sectors, rationale
  - final_sentiment_score, confidence
- [ ] JSON Schema å¸¸é‡ï¼ˆç”¨äºPromptï¼‰
  - MACRO_ANALYSIS_SCHEMA
  - POLICY_ANALYSIS_SCHEMA
  - SECTOR_ANALYSIS_SCHEMA
  - STRATEGY_OUTPUT_SCHEMA

**å‚è€ƒä»£ç ä½ç½®**ï¼šè¯¦ç»†è®¾è®¡æ–‡æ¡£ ç¬¬1.2èŠ‚

**å®ç°è¦ç‚¹**ï¼š
```python
from pydantic import BaseModel, Field
from typing import List, Optional

class MacroAnalysis(BaseModel):
    """å®è§‚ç»æµåˆ†æè¾“å‡ºç»“æ„"""
    economic_cycle: str = Field(
        description="å½“å‰ç»æµå‘¨æœŸ: å¤è‹/æ‰©å¼ /æ»èƒ€/è¡°é€€"
    )
    confidence: float = Field(ge=0.0, le=1.0)
    sentiment_score: float = Field(ge=-1.0, le=1.0)
```

**éªŒè¯æ ‡å‡†**ï¼š
- âœ… æ‰€æœ‰å­—æ®µå®šä¹‰å®Œæ•´
- âœ… ç±»å‹çº¦æŸæ­£ç¡®ï¼ˆge, leç­‰ï¼‰
- âœ… å¯ä»¥æ­£ç¡®åºåˆ—åŒ–/ååºåˆ—åŒ–JSON
- âœ… Fieldæè¿°æ¸…æ™°

---

### ä»»åŠ¡1.4ï¼šç¼–å†™å•å…ƒæµ‹è¯•

**æ–‡ä»¶**ï¼š
- `tests/dataflows/test_index_data.py`
- `tests/tools/test_index_tools.py`
- `tests/utils/test_analysis_schemas.py`

**æµ‹è¯•ç”¨ä¾‹æ¸…å•**ï¼š

#### test_index_data.py
- [ ] `test_get_macro_economics_data()` - æµ‹è¯•å®è§‚æ•°æ®è·å–
- [ ] `test_get_macro_economics_data_cache()` - æµ‹è¯•ç¼“å­˜æœºåˆ¶
- [ ] `test_get_policy_news()` - æµ‹è¯•æ”¿ç­–æ–°é—»è·å–
- [ ] `test_get_sector_flows()` - æµ‹è¯•æ¿å—æ•°æ®è·å–
- [ ] `test_api_failure_fallback()` - æµ‹è¯•APIå¤±è´¥é™çº§

#### test_index_tools.py
- [ ] `test_fetch_macro_data()` - æµ‹è¯•å®è§‚æ•°æ®å·¥å…·
- [ ] `test_fetch_policy_news()` - æµ‹è¯•æ”¿ç­–æ–°é—»å·¥å…·
- [ ] `test_fetch_sector_rotation()` - æµ‹è¯•æ¿å—è½®åŠ¨å·¥å…·
- [ ] `test_tool_error_handling()` - æµ‹è¯•å·¥å…·å¼‚å¸¸å¤„ç†

#### test_analysis_schemas.py
- [ ] `test_macro_analysis_schema()` - æµ‹è¯•å®è§‚åˆ†æSchema
- [ ] `test_policy_analysis_schema()` - æµ‹è¯•æ”¿ç­–åˆ†æSchema
- [ ] `test_sector_analysis_schema()` - æµ‹è¯•æ¿å—åˆ†æSchema
- [ ] `test_strategy_output_schema()` - æµ‹è¯•ç­–ç•¥è¾“å‡ºSchema
- [ ] `test_schema_validation()` - æµ‹è¯•å­—æ®µéªŒè¯

**å‚è€ƒä»£ç ä½ç½®**ï¼šæµ‹è¯•è®¡åˆ’ä¸æ€»ç»“è¡¥å…….md ç¬¬6.1èŠ‚

**æµ‹è¯•è¦†ç›–ç‡è¦æ±‚**ï¼šâ‰¥ 80%

---

## ğŸ”„ å¼€å‘æµç¨‹

### Day 1: æ•°æ®å±‚å¼€å‘
1. **ä¸Šåˆ**
   - åˆ›å»º `index_data.py` æ–‡ä»¶
   - å®ç° `IndexDataProvider` ç±»æ¡†æ¶
   - å®ç° `get_macro_economics_data()` æ–¹æ³•
   
2. **ä¸‹åˆ**
   - å®ç° `get_policy_news()` æ–¹æ³•
   - å®ç° `get_sector_flows()` æ–¹æ³•
   - æ·»åŠ ç¼“å­˜æœºåˆ¶
   - ç¼–å†™æ•°æ®å±‚å•å…ƒæµ‹è¯•

3. **æ™šä¸Šï¼ˆå¯é€‰ï¼‰**
   - è¿è¡Œæµ‹è¯•ï¼Œä¿®å¤bug
   - å®Œå–„é”™è¯¯å¤„ç†

### Day 2: å·¥å…·å±‚å’ŒSchemaå¼€å‘
1. **ä¸Šåˆ**
   - åˆ›å»º `index_tools.py` æ–‡ä»¶
   - å®ç°ä¸‰ä¸ªLangChainå·¥å…·
   - ç¼–å†™å·¥å…·å±‚å•å…ƒæµ‹è¯•
   
2. **ä¸‹åˆ**
   - åˆ›å»º `analysis_schemas.py` æ–‡ä»¶
   - å®šä¹‰æ‰€æœ‰Pydanticæ¨¡å‹
   - å®šä¹‰JSON Schemaå¸¸é‡
   - ç¼–å†™Schemaå•å…ƒæµ‹è¯•

3. **æ™šä¸Šï¼ˆå¯é€‰ï¼‰**
   - è¿è¡Œæ‰€æœ‰æµ‹è¯•
   - ä¿®å¤bugï¼Œå®Œå–„æ–‡æ¡£

### Day 3: é›†æˆæµ‹è¯•å’Œä¼˜åŒ–
1. **ä¸Šåˆ**
   - é›†æˆæµ‹è¯•ï¼ˆæ•°æ®å±‚ â†’ å·¥å…·å±‚ â†’ Schemaï¼‰
   - æ€§èƒ½æµ‹è¯•ï¼ˆç¼“å­˜æ•ˆæœã€APIå“åº”æ—¶é—´ï¼‰
   
2. **ä¸‹åˆ**
   - ä¼˜åŒ–ä»£ç 
   - å®Œå–„æ—¥å¿—è®°å½•
   - Code Review
   
3. **éªŒæ”¶**
   - æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡
   - æµ‹è¯•è¦†ç›–ç‡ â‰¥ 80%
   - ä»£ç ç¬¦åˆè§„èŒƒ

---

## âœ… éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶
- [ ] `IndexDataProvider` å¯ä»¥æˆåŠŸè·å–æ‰€æœ‰å®è§‚ç»æµæ•°æ®
- [ ] MongoDBç¼“å­˜æœºåˆ¶æ­£å¸¸å·¥ä½œ
- [ ] APIå¤±è´¥æ—¶é™çº§æ–¹æ¡ˆç”Ÿæ•ˆ
- [ ] ä¸‰ä¸ªLangChainå·¥å…·å¯ä»¥è¢«æ­£ç¡®è°ƒç”¨
- [ ] æ‰€æœ‰Pydanticæ¨¡å‹å¯ä»¥æ­£ç¡®åºåˆ—åŒ–/ååºåˆ—åŒ–

### è´¨é‡éªŒæ”¶
- [ ] æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡
- [ ] æµ‹è¯•è¦†ç›–ç‡ â‰¥ 80%
- [ ] ä»£ç é€šè¿‡ pylint/flake8 æ£€æŸ¥
- [ ] æ‰€æœ‰å‡½æ•°æœ‰å®Œæ•´çš„ç±»å‹æ³¨è§£å’Œdocstring
- [ ] æ—¥å¿—è®°å½•æ¸…æ™°ï¼Œä¾¿äºè°ƒè¯•

### æ€§èƒ½éªŒæ”¶
- [ ] å®è§‚æ•°æ®è·å– < 3ç§’ï¼ˆé¦–æ¬¡ï¼‰
- [ ] ç¼“å­˜å‘½ä¸­å < 100ms
- [ ] å·¥å…·è°ƒç”¨å“åº”æ—¶é—´ < 5ç§’

---

## ğŸ“Š è¿›åº¦è·Ÿè¸ª

| ä»»åŠ¡ | è´Ÿè´£äºº | å¼€å§‹æ—¶é—´ | é¢„è®¡å®Œæˆ | å®é™…å®Œæˆ | çŠ¶æ€ |
|------|--------|----------|----------|----------|------|
| ä»»åŠ¡1.1 IndexDataProvider | - | - | Day 1 | - | ğŸ“‹ å¾…å¼€å§‹ |
| ä»»åŠ¡1.2 LangChainå·¥å…· | - | - | Day 2 ä¸Šåˆ | - | ğŸ“‹ å¾…å¼€å§‹ |
| ä»»åŠ¡1.3 Pydantic Schema | - | - | Day 2 ä¸‹åˆ | - | ğŸ“‹ å¾…å¼€å§‹ |
| ä»»åŠ¡1.4 å•å…ƒæµ‹è¯• | - | - | Day 2 | - | ğŸ“‹ å¾…å¼€å§‹ |
| é›†æˆæµ‹è¯•å’Œä¼˜åŒ– | - | - | Day 3 | - | ğŸ“‹ å¾…å¼€å§‹ |

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### å¸¸è§é—®é¢˜
1. **AKShare APIå˜æ›´**
   - å®šæœŸæ£€æŸ¥AKShareæ–‡æ¡£æ›´æ–°
   - ä¿æŒçµæ´»çš„é™çº§æ–¹æ¡ˆ
   
2. **MongoDBè¿æ¥é—®é¢˜**
   - ç¡®ä¿MongoDBæœåŠ¡å·²å¯åŠ¨
   - æ£€æŸ¥è¿æ¥é…ç½®
   
3. **æ•°æ®æ ¼å¼ä¸ä¸€è‡´**
   - AKShareè¿”å›çš„DataFrameåˆ—åå¯èƒ½å˜åŒ–
   - ä½¿ç”¨ `.get()` æ–¹æ³•å®‰å…¨è®¿é—®

### æœ€ä½³å®è·µ
1. **ç¼“å­˜é”®è®¾è®¡**
   - ä½¿ç”¨è¯­ä¹‰åŒ–çš„é”®åï¼š`macro_data_{date}`
   - é¿å…ç¼“å­˜é”®å†²çª
   
2. **é”™è¯¯æ—¥å¿—**
   - è®°å½•å¤±è´¥çš„APIè°ƒç”¨
   - è®°å½•é™çº§æ–¹æ¡ˆçš„è§¦å‘
   
3. **ä»£ç ç»„ç»‡**
   - æ•°æ®è·å–é€»è¾‘ä¸æ ¼å¼åŒ–é€»è¾‘åˆ†ç¦»
   - æ¯ä¸ªæ–¹æ³•èŒè´£å•ä¸€

---

## ğŸ”— ç›¸å…³èµ„æº

- **å‚è€ƒå®ç°**ï¼š`tradingagents/dataflows/` ç›®å½•ä¸‹çš„ç°æœ‰æ•°æ®æµæ–‡ä»¶
- **AKShareæ–‡æ¡£**ï¼šhttps://akshare.akfamily.xyz/
- **LangChainå·¥å…·æ–‡æ¡£**ï¼šhttps://python.langchain.com/docs/modules/tools/
- **Pydanticæ–‡æ¡£**ï¼šhttps://docs.pydantic.dev/

---

**ä¸‹ä¸€é˜¶æ®µ**ï¼š[é˜¶æ®µäºŒ-AgentèŠ‚ç‚¹å®ç°](./é˜¶æ®µäºŒ-AgentèŠ‚ç‚¹å®ç°.md)

---

**ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¥æœŸ**: 2024-12-11  
**æœ€åæ›´æ–°**: 2024-12-11
