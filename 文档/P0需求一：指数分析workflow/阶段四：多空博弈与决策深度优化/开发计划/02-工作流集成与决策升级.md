# 02-工作流集成与决策升级计划

## 1. 策略顾问 (Strategy Advisor) 升级

### 1.1 核心变更
原有的 Strategy Advisor 侧重于**计算**（加权打分），升级后侧重于**裁决**（听证会模式）。

### 1.2 输入处理
```python
# v2.3 新增
debate_history = state["investment_debate_state"]["history"]
```

### 1.3 输出 Schema 变更
```json
{
  "market_outlook": "...",
  "final_position": 0.x,
  "debate_summary": "多方认为...空方反驳...",  // 新增
  "decision_rationale": "尽管空方提示了...但考虑到多方强调的...决定维持高仓位", // 增强
  ...
}
```

## 2. 图构建 (Graph Setup)

### 2.1 路由逻辑
在 `_setup_index_graph` 中：
```python
# 插入点：Technical Analyst 之后
workflow.add_edge("Msg Clear Technical", "Index Bull Researcher")

# 循环逻辑
workflow.add_conditional_edges(
    "Index Bull Researcher",
    should_continue_debate,
    {"Bear Researcher": "Index Bear Researcher", "Research Manager": "Strategy Advisor"}
)
# 注意：复用 should_continue_debate 时，需要确保返回值映射正确
# 或者在 conditional_logic.py 中新增 should_continue_index_debate
```

### 2.2 状态管理
确保 `AgentState` 初始化时包含 `investment_debate_state`，或者在第一个辩论节点（Bull）进行防御性初始化。

## 3. 风险控制
- **死循环风险**：确保 `should_continue_debate` 有明确的计数器退出机制。
- **上下文超长风险**：如果辩论轮次过多，Prompt 可能超过 Context Window。需限制轮次（建议 max_rounds=2，即每人发言2次）。
