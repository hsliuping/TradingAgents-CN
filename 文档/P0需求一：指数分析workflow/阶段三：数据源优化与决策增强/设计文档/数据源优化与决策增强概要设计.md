# 阶段三：数据源优化与决策增强 - 概要设计

## 1. 总体架构设计

本阶段将对 `tradingagents/dataflows` 模块进行重构，引入 **Hybrid Data Architecture (混合数据架构)**。

```mermaid
graph TD
    User[用户/Agent] --> Service[DataService (场景化服务)]
    
    subgraph "Data Layer (数据层)"
        Service --> Manager[DataSourceManager (源管理器)]
        
        Manager -->|Primary| Tushare[Tushare Adaptor]
        Manager -->|Secondary| AKShare[AKShare Adaptor]
        Manager -->|Backup| Baostock[Baostock Adaptor]
        
        Tushare --> Cache[(MongoDB Cache)]
        AKShare --> Cache
        Baostock --> Cache
    end
    
    subgraph "Real-time Monitor (实时监控)"
        RT[Realtime Engine] --> Manager
        RT -->|Stream| Agents[分析Agents]
    end
```

## 2. 核心模块设计

### 2.1 混合数据提供者 (HybridIndexDataProvider)
取代原有的 `IndexDataProvider`，实现多源路由与融合。

```python
class HybridIndexDataProvider:
    def __init__(self):
        self.tushare = TushareProvider(token=TS_TOKEN)
        self.akshare = AKShareProvider()
        self.baostock = BaostockProvider()
        self.monitor = DataSourceHealthMonitor()

    def get_macro_data(self):
        # 优先使用 Tushare，失败降级至 AKShare
        if self.monitor.is_healthy("tushare"):
            return self.tushare.get_macro_data()
        return self.akshare.get_macro_data()
        
    def get_realtime_quotes(self, codes):
        # 实时行情融合策略
        # 1. 尝试获取高速源 (Sina/Tushare)
        # 2. 交叉验证价格异常
        pass
```

### 2.2 实时监控引擎 (RealtimeMarketMonitor)
专为盘中决策设计，绕过常规长TTL缓存。

- **功能**:
    - 维护一个短周期 (1-5分钟) 的内存缓存。
    - 定时 (Cron/Loop) 刷新关键指标：资金流、涨跌家数、领涨板块。
    - 提供 `get_market_snapshot(mode='morning'|'afternoon')` 接口。

### 2.3 场景化数据服务 (ContextualDataService)
为 Agent 提供经过加工的“决策情报”，而非原始数据。

- **早盘情报 (MorningIntelligence)**:
    - 聚合：外盘涨跌 + 竞价异动 + 消息面情绪。
- **尾盘情报 (ClosingIntelligence)**:
    - 聚合：日内资金趋势 + 尾盘量能 + 技术面支撑压力。

## 3. 数据源接入方案

### 3.1 Tushare Pro 接入
- **必要性**: 提供更稳定的历史行情和结构化的财务/宏观数据。
- **配置**: 需在 `config.yaml` 或环境变量中配置 `TUSHARE_TOKEN`。
- **策略**: 
    - 基础数据 (日线/指数): 强依赖。
    - 实时数据: 视用户积分情况，积分为空时自动降级。

### 3.2 实时资金流增强
- **方案 A**: 继续使用 AKShare 封装的东财接口 (目前最全)。
- **方案 B**: 自研轻量级爬虫，直接请求东财/同花顺的 Web API (风险较高，备用)。
- **优化**: 增加并发请求，同时获取“行业板块”、“概念板块”、“ETF资金”三路数据进行交叉验证。

## 4. 数据库/缓存设计调整

| 集合/Key | 类型 | TTL | 说明 |
| :--- | :--- | :--- | :--- |
| `market_snapshot_realtime` | **Memory Only** | 1-5 mins | 盘中实时快照 (进程生命周期内有效) |
| `sector_flow_intraday` | MongoDB | 1 day | 记录当天的分钟级资金流，用于盘后复盘画图 |
| `macro_economic_master` | MongoDB | Permanent | 宏观数据主表，多源融合后的清洗数据 |

## 5. Agent 升级计划

### 5.0 新增 Technical Analyst (技术分析师)
负责对指数进行纯技术面分析，提供量化的仓位调整建议。

- **职责**:
    - **趋势判断**: 基于均线系统 (MA20/MA60) 判断当前是多头、空头还是震荡趋势。
    - **超买超卖**: 基于 RSI/KDJ 指标识别市场极端情绪。
        - *规则示例*: RSI > 80 (超买) -> 建议减仓; RSI < 20 (超跌) -> 建议反弹博弈或止损。
    - **形态识别**: 识别关键支撑位/压力位，判断突破有效性。
    - **量价分析**: 结合成交量判断上涨/下跌的质量。
- **输出**: `technical_report` (包含 `trend_signal`, `support_resistance`, `position_adjustment_suggestion`)。

### 5.1 Macro Analyst
- **升级**: 增加对“美元指数”、“美债收益率”的实时监控（影响A股估值）。

### 5.2 Sector Analyst
- **升级**: 
    - 增加 **"早盘竞价分析"** 能力。
    - 增加 **"尾盘抢筹识别"** 能力。

### 5.3 Strategy Advisor
- **升级**: 
    - 接入 `ContextualDataService`，根据当前时间自动切换决策逻辑模板（早盘策略 vs 尾盘策略）。
    - **融合技术面建议**: 将 `Technical Analyst` 的建议纳入决策权重。
        - *决策公式*: `Final_Pos = Base_Pos (宏观/政策) * 0.6 + Technical_Adj * 0.4` (示例权重，需动态调整)。
        - *止盈止损逻辑*: 即使宏观向好，若技术面出现 "顶背离" 或 "高位巨量长阴"，强制触发减仓止盈 (如用户提到的减少50%)。

## 6. 开发排期估算
详见开发计划文档。
