# 阶段五：指数分析流程优化 - 总体规划

## 1. 目标
本阶段的核心目标是打破指数分析（Index Analysis）目前“硬编码线性流程”的局限，通过引入动态图构建、并行执行机制和风险博弈机制，全方位提升系统的灵活性、效率与分析深度。同时，引入自学习记忆机制，使指数分析能够从历史判断中积累经验。

## 2. 关键任务分解

### 2.1 任务一：动态 Agent 选择与并行化 (Phase 1)
*   **目标**：允许用户自定义分析模块组合，并通过并行执行大幅降低总耗时。
*   **具体动作**：
    1.  修改 `simple_analysis_service.py`，移除针对指数分析强制清空 `selected_analysts` 的逻辑。
    2.  修改 `trading_graph.py`，透传 `selected_analysts` 参数。
    3.  重构 `setup.py` 中的 `_setup_index_graph`：
        *   支持基于列表动态添加节点。
        *   **实现并行拓扑**：将 START 节点直接连接至所有选中的基础分析节点（Macro, Policy, News, Sector, Technical），使其同时运行。
        *   将所有基础分析节点的输出连接至 `Index Bull Researcher`（作为汇聚点）。

### 2.2 任务二：指数风控层集成 (Phase 2)
*   **目标**：在策略生成后引入多视角的风险评估，避免单向思维风险。
*   **具体动作**：
    1.  复用现有的 Risky/Neutral/Safe Analyst 和 Risk Judge。
    2.  在 `_setup_index_graph` 中引入上述节点。
    3.  配置条件边：`Strategy Advisor` -> `Risky Analyst` -> ... -> `Risk Judge` -> `END`。
    4.  通过 `analysis_type="index"` 参数调整 Prompt 上下文。

### 2.3 任务三：数据预验证机制 (Phase 3)
*   **目标**：在进入 LLM 昂贵计算前，拦截无效请求。
*   **具体动作**：
    1.  新增验证逻辑（或服务）：
        *   检查指数代码格式（如必须含 `.SH` 或 `.SZ`）。
        *   轻量级探测数据源（如 akshare）连通性。
    2.  在 `simple_analysis_service.py` 启动任务前调用该验证逻辑。

### 2.4 任务四：指数分析记忆机制 (Phase 4)
*   **目标**：为指数分析引入长期记忆与反思能力，使其能参考历史相似行情的判断结果。
*   **具体动作**：
    1.  扩展 `FinancialSituationMemory` 支持指数分析场景。
    2.  在 `setup.py` 中向 `Index Bull/Bear Researcher` 和 `Strategy Advisor` 注入记忆对象。
    3.  更新 `reflection.py`，实现指数行情的特征提取（Macro+Policy+Sector+News+Technical）与反思逻辑。
    4.  更新 `trading_graph.py` 中的 `reflect_and_remember` 方法，支持 `analysis_type="index"` 的触发。

### 2.5 任务五：测试与验证 (Phase 5)
*   **目标**：确保重构后的流程稳定可靠。
*   **验证点**：
    1.  **并行效率**：对比串行与并行执行的总耗时。
    2.  **动态组合**：验证“仅宏观”、“仅技术”等组合是否正常运行。
    3.  **风险输出**：验证报告末尾的风险提示章节。
    4.  **记忆回溯**：验证在第二次运行相似行情时，Agent 是否能引用之前的反思内容。
    5.  **异常拦截**：输入错误代码或断网环境下，验证任务是否快速失败并提示友好信息。

## 3. 时间计划
*   **Phase 1 (动态+并行)**：预计 2 天
*   **Phase 2 (风险层)**：预计 1 天
*   **Phase 3 (预验证)**：预计 0.5 天
*   **Phase 4 (记忆机制)**：预计 1 天
*   **Phase 5 (测试)**：预计 1 天

## 4. 交付物
*   更新后的后端代码。
*   包含风险评估和并行执行日志的新版指数分析报告。
*   具备自学习能力的指数分析 Agent 及其记忆库配置。
