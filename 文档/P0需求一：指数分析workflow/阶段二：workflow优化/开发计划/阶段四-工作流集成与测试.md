# é˜¶æ®µå››ï¼šå·¥ä½œæµé›†æˆä¸æµ‹è¯•

## ğŸ“‹ é˜¶æ®µæ¦‚è¿°

**ç›®æ ‡**ï¼šå°†æ–°Agenté›†æˆåˆ°å·¥ä½œæµï¼Œå…¨é¢æµ‹è¯•èŒè´£åˆ†ç¦»å’Œå†³ç­–æ­£ç¡®æ€§

**é¢„è®¡æ—¶é—´**ï¼š2-3å¤©  
**ä¼˜å…ˆçº§**ï¼šğŸ”´ é«˜  
**ä¾èµ–**ï¼šé˜¶æ®µä¸€ã€äºŒã€ä¸‰å®Œæˆ

---

## ğŸ¯ æœ¬é˜¶æ®µäº¤ä»˜ç‰©

### ä¿®æ”¹æ–‡ä»¶
1. `tradingagents/agents/utils/agent_states.py` - æ‰©å±•AgentState
2. `tradingagents/graph/setup.py` - æ‰©å±•å·¥ä½œæµå›¾
3. `tradingagents/agents/utils/agent_utils.py` - æ³¨å†Œå·¥å…·

### æ–°å»ºæ–‡ä»¶
4. `tests/integration/test_index_workflow_v2_1.py` - é›†æˆæµ‹è¯•
5. `tests/éªŒæ”¶æµ‹è¯•æŠ¥å‘Š.md` - æµ‹è¯•æŠ¥å‘Š

---

## ğŸ“ è¯¦ç»†å¼€å‘ä»»åŠ¡

### ä»»åŠ¡4.1ï¼šæ‰©å±•AgentState

**ä¿®æ”¹å†…å®¹**ï¼š
```python
class AgentState(TypedDict):
    # ... åŸæœ‰å­—æ®µ
    
    # ğŸ†• v2.1æ–°å¢å­—æ®µ
    international_news_report: str
    international_news_tool_call_count: int
```

### ä»»åŠ¡4.2ï¼šæ‰©å±•å·¥ä½œæµå›¾

**ä¿®æ”¹ `setup.py`**ï¼š
```python
def _setup_index_graph(self):
    """æ„å»ºæŒ‡æ•°åˆ†æå·¥ä½œæµå›¾ï¼ˆv2.1ï¼‰"""
    
    # ... åˆ›å»ºAgent
    international_news_analyst = create_international_news_analyst(llm, toolkit)
    
    # æ·»åŠ èŠ‚ç‚¹
    builder.add_node("macro_analyst", macro_analyst)
    builder.add_node("policy_analyst", policy_analyst)
    builder.add_node("international_news_analyst", international_news_analyst)  # ğŸ†•
    builder.add_node("sector_analyst", sector_analyst)
    builder.add_node("strategy_advisor", strategy_advisor)
    
    # çº¿æ€§å·¥ä½œæµ
    builder.add_edge(START, "macro_analyst")
    builder.add_edge("macro_analyst", "policy_analyst")
    builder.add_edge("policy_analyst", "international_news_analyst")  # ğŸ†•
    builder.add_edge("international_news_analyst", "sector_analyst")  # ğŸ†•
    builder.add_edge("sector_analyst", "strategy_advisor")
    builder.add_edge("strategy_advisor", END)
```

### ä»»åŠ¡4.3ï¼šé›†æˆæµ‹è¯•

**æµ‹è¯•æ–‡ä»¶**ï¼š`tests/integration/test_index_workflow_v2_1.py`

**æ ¸å¿ƒæµ‹è¯•ç”¨ä¾‹**ï¼š
```python
def test_complete_workflow():
    """æµ‹è¯•å®Œæ•´å·¥ä½œæµ"""
    state = {
        "company_of_interest": "sh931865",
        "trade_date": "2025-12-14",
        "messages": []
    }
    
    # æ‰§è¡Œå·¥ä½œæµ
    result = graph.invoke(state)
    
    # éªŒè¯å„Agentè¾“å‡º
    assert "macro_report" in result
    assert "policy_report" in result
    assert "international_news_report" in result
    assert "sector_report" in result
    assert "strategy_report" in result


def test_responsibility_separation():
    """éªŒè¯èŒè´£åˆ†ç¦»"""
    result = graph.invoke(state)
    
    # éªŒè¯International Newsä¸è¾“å‡ºä»“ä½
    news_report = json.loads(result["international_news_report"])
    assert "position_adjustment" not in news_report
    assert "impact_strength" in news_report
    
    # éªŒè¯Policy Analystä¸è¾“å‡ºä»“ä½
    policy_report = json.loads(result["policy_report"])
    assert "base_position_recommendation" not in policy_report
    assert "overall_support_strength" in policy_report
    
    # éªŒè¯Strategy Advisorè¾“å‡ºä»“ä½
    strategy_report = result["strategy_report"]
    assert "final_position" in strategy_report
    assert "position_breakdown" in strategy_report


def test_decision_correctness():
    """éªŒè¯å†³ç­–æ­£ç¡®æ€§"""
    # åœºæ™¯1: å¼ºæ”¿ç­–+é«˜æ–°é—»
    state = create_test_state(
        policy_strength="å¼º",
        news_impact="é«˜"
    )
    result = graph.invoke(state)
    assert 0.65 <= result["strategy_report"]["final_position"] <= 0.85
    
    # åœºæ™¯2: å¼±æ”¿ç­–+ä½æ–°é—»
    state = create_test_state(
        policy_strength="å¼±",
        news_impact="ä½"
    )
    result = graph.invoke(state)
    assert 0.35 <= result["strategy_report"]["final_position"] <= 0.50
```

### ä»»åŠ¡4.4ï¼šæ€§èƒ½æµ‹è¯•

**æŒ‡æ ‡éªŒè¯**ï¼š
```python
def test_performance():
    """æ€§èƒ½æµ‹è¯•"""
    import time
    
    start = time.time()
    result = graph.invoke(state)
    duration = time.time() - start
    
    # æ‰§è¡Œæ—¶é—´åº”<5åˆ†é’Ÿ
    assert duration < 300, f"æ‰§è¡Œæ—¶é—´{duration}sè¶…è¿‡5åˆ†é’Ÿ"
    
    # Tokenæ¶ˆè€—ç»Ÿè®¡
    token_usage = calculate_token_usage(result)
    assert token_usage < 15000, f"Tokenæ¶ˆè€—{token_usage}è¶…è¿‡é¢„æœŸ"
```

---

## ğŸ“Š è¿›åº¦è·Ÿè¸ª

- [ ] ä»»åŠ¡4.1: æ‰©å±•AgentState (0.5å¤©)
- [ ] ä»»åŠ¡4.2: æ‰©å±•å·¥ä½œæµå›¾ (0.5å¤©)
- [ ] ä»»åŠ¡4.3: é›†æˆæµ‹è¯• (1å¤©)
- [ ] ä»»åŠ¡4.4: æ€§èƒ½æµ‹è¯• (0.5å¤©)

### éªŒæ”¶æ ‡å‡†

âœ… **é›†æˆéªŒæ”¶**ï¼š
- å·¥ä½œæµæ­£å¸¸æ‰§è¡Œ
- èŠ‚ç‚¹é¡ºåºæ­£ç¡®
- çŠ¶æ€ä¼ é€’æ— è¯¯

âœ… **èŒè´£éªŒæ”¶**ï¼š
- International Newsä¸è¾“å‡ºä»“ä½
- Policy Analystä¸è¾“å‡ºä»“ä½
- Strategy Advisorç»Ÿä¸€å†³ç­–

âœ… **æ€§èƒ½éªŒæ”¶**ï¼š
- æ‰§è¡Œæ—¶é—´<5åˆ†é’Ÿ
- Tokenæ¶ˆè€—<15000
- æ— æ˜æ˜¾æ€§èƒ½é—®é¢˜

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å‘åå…¼å®¹**: ç¡®ä¿v2.0åŠŸèƒ½ä¸å—å½±å“
2. **é”™è¯¯å¤„ç†**: æµ‹è¯•å„ç§å¼‚å¸¸åœºæ™¯
3. **æ—¥å¿—è®°å½•**: å®Œæ•´çš„æ‰§è¡Œæ—¥å¿—

---

**é˜¶æ®µè´Ÿè´£äºº**: ___________  
**é¢„è®¡å®Œæˆæ—¥æœŸ**: ___________  
**å®é™…å®Œæˆæ—¥æœŸ**: ___________
