# TradingAgents-CN æŒ‡æ•°åˆ†æè¯¦ç»†è®¾è®¡æ–¹æ¡ˆ
æœ¬æ–‡æ¡£æä¾›äº†â€œæŒ‡æ•°åˆ†æï¼ˆIndex Analysisï¼‰â€åŠŸèƒ½çš„è¯¦ç»†ä»£ç çº§è®¾è®¡è§„èŒƒï¼Œæ—¨åœ¨ä¸ºå¼€å‘äººå‘˜æä¾›ç›´æ¥å®æ–½çš„è“å›¾ã€‚
## 1. æ ¸å¿ƒæ•°æ®ç»“æ„è®¾è®¡

### 1.1 AgentState æ‰©å±•ï¼ˆä¼˜åŒ–ç‰ˆï¼‰

åœ¨ `tradingagents/agents/utils/agent_states.py` ä¸­æ‰©å±• `AgentState`ï¼Œ**ç§»é™¤å†—ä½™çš„ IndexAnalysisState**ï¼Œç›´æ¥åœ¨ AgentState ä¸­æ·»åŠ æ‰€éœ€å­—æ®µã€‚

#### è®¾è®¡åŸåˆ™
- âœ… **å‘åå…¼å®¹**ï¼šæ‰€æœ‰æ–°å­—æ®µä½¿ç”¨ `Annotated` ç±»å‹æç¤ºï¼Œä¸å½±å“ç°æœ‰ä¸ªè‚¡åˆ†æ
- âœ… **æœ€å°åŒ–ä¿®æ”¹**ï¼šä»…æ·»åŠ å¿…è¦å­—æ®µï¼Œä¸ä¿®æ”¹ç°æœ‰å­—æ®µç»“æ„
- âœ… **æ¸…æ™°å‘½å**ï¼šå­—æ®µåéµå¾ªç°æœ‰å‘½åè§„èŒƒï¼ˆå¦‚ `market_report`ï¼‰

#### å®ç°ä»£ç 

```python
# tradingagents/agents/utils/agent_states.py

from typing import Annotated, Sequence
from datetime import date, timedelta, datetime
from typing_extensions import TypedDict, Optional
from langchain_openai import ChatOpenAI
from tradingagents.agents import *
from langgraph.prebuilt import ToolNode
from langgraph.graph import END, StateGraph, START, MessagesState

# ... (ä¿ç•™ç°æœ‰ InvestDebateState å’Œ RiskDebateState)

class AgentState(MessagesState):
    """å…¨å±€çŠ¶æ€ï¼Œæ”¯æŒä¸ªè‚¡åˆ†æå’ŒæŒ‡æ•°åˆ†æä¸¤ç§æ¨¡å¼"""
    
    # ========== é€šç”¨å­—æ®µ ==========
    company_of_interest: Annotated[str, "Company/Index code we are analyzing"]
    trade_date: Annotated[str, "Trading date"]
    sender: Annotated[str, "Agent that sent this message"]
    
    # ========== è·¯ç”±æ ‡è¯† (æ–°å¢) ==========
    is_index: Annotated[bool, "True for index analysis, False for stock analysis"]
    
    # ========== ä¸ªè‚¡åˆ†æå­—æ®µ (ç°æœ‰ï¼Œä¿æŒä¸å˜) ==========
    market_report: Annotated[str, "Report from the Market Analyst"]
    sentiment_report: Annotated[str, "Report from the Social Media Analyst"]
    news_report: Annotated[str, "Report from the News Researcher"]
    fundamentals_report: Annotated[str, "Report from the Fundamentals Researcher"]
    
    # å·¥å…·è°ƒç”¨è®¡æ•°å™¨ (é˜²æ­¢æ­»å¾ªç¯)
    market_tool_call_count: Annotated[int, "Market analyst tool call counter"]
    news_tool_call_count: Annotated[int, "News analyst tool call counter"]
    sentiment_tool_call_count: Annotated[int, "Social media analyst tool call counter"]
    fundamentals_tool_call_count: Annotated[int, "Fundamentals analyst tool call counter"]
    
    # ç ”ç©¶å›¢é˜Ÿè®¨è®º
    investment_debate_state: Annotated[InvestDebateState, "Debate state"]
    investment_plan: Annotated[str, "Investment plan from Research Manager"]
    trader_investment_plan: Annotated[str, "Plan from Trader"]
    
    # é£é™©ç®¡ç†å›¢é˜Ÿè®¨è®º
    risk_debate_state: Annotated[RiskDebateState, "Risk debate state"]
    final_trade_decision: Annotated[str, "Final decision from Risk Judge"]
    
    # ========== æŒ‡æ•°åˆ†æå­—æ®µ (æ–°å¢) ==========
    # å®è§‚åˆ†æ
    macro_report: Annotated[str, "Report from Macro Analyst (JSON format with confidence)"]
    macro_tool_call_count: Annotated[int, "Macro analyst tool call counter"]
    
    # æ”¿ç­–åˆ†æ
    policy_report: Annotated[str, "Report from Policy Analyst (JSON format with confidence)"]
    policy_tool_call_count: Annotated[int, "Policy analyst tool call counter"]
    
    # æ¿å—åˆ†æ
    sector_report: Annotated[str, "Report from Sector Analyst (JSON format with confidence)"]
    sector_tool_call_count: Annotated[int, "Sector analyst tool call counter"]
    
    # æŒ‡æ•°æŠ€æœ¯åˆ†æ
    index_tech_report: Annotated[str, "Report from Index Technical Analyst"]
    index_tech_tool_call_count: Annotated[int, "Index tech analyst tool call counter"]
    
    # ç­–ç•¥æ±‡æ€» (æœ€åç”Ÿæˆ)
    strategy_report: Annotated[str, "Final strategy report from Strategy Advisor"]
    strategy_tool_call_count: Annotated[int, "Strategy advisor tool call counter"]
```

#### å­—æ®µè¯´æ˜è¡¨

| å­—æ®µå | ç±»å‹ | ç”¨é€” | å¡«å……èŠ‚ç‚¹ | ä¾èµ–å­—æ®µ |
|-------|------|------|---------|----------|
| `is_index` | bool | è·¯ç”±æ ‡è¯† | Router/API | - |
| `macro_report` | str (JSON) | å®è§‚åˆ†æç»“æœ | Macro Analyst | - |
| `policy_report` | str (JSON) | æ”¿ç­–åˆ†æç»“æœ | Policy Analyst | `macro_report` |
| `sector_report` | str (JSON) | æ¿å—åˆ†æç»“æœ | Sector Analyst | `policy_report` |
| `index_tech_report` | str | æŒ‡æ•°æŠ€æœ¯åˆ†æ | Index Tech Analyst | - |
| `strategy_report` | str (JSON) | æœ€ç»ˆç­–ç•¥ | Strategy Advisor | ä¸Šè¿°æ‰€æœ‰ report |

#### å…¼å®¹æ€§ä¿è¯

- âœ… ä¸ªè‚¡åˆ†ææµç¨‹ï¼š`is_index=False`ï¼Œä¸è®¿é—®æ–°å¢å­—æ®µï¼Œé›¶å½±å“
- âœ… æŒ‡æ•°åˆ†ææµç¨‹ï¼š`is_index=True`ï¼Œä½¿ç”¨æ–°å¢å­—æ®µï¼Œä¸è®¿é—®ä¸ªè‚¡å­—æ®µ
- âœ… çŠ¶æ€åˆå§‹åŒ–ï¼šæ‰€æœ‰æ–°å­—æ®µé»˜è®¤ä¸º `None` æˆ– `0`
### 1.2 è¾“å‡ºæ•°æ® Schema (Pydantic Models)

ä¸ºäº†ç¡®ä¿ LLM è¾“å‡ºçš„ç»“æ„åŒ–å’Œå¯è§£ææ€§ï¼Œå®šä¹‰ Pydantic æ¨¡å‹ã€‚**ä¼˜åŒ–ç‚¹ï¼šç®€åŒ–æ¨¡å‹ï¼Œä»…ä¿ç•™æ ¸å¿ƒå­—æ®µï¼Œé™ä½ LLM è¾“å‡ºå¤æ‚åº¦ã€‚**

#### è®¾è®¡åŸåˆ™
- âœ… **ç®€æ´æ€§**ï¼šé¿å…è¿‡åº¦ç»†åŒ–ï¼ŒLLM ç”Ÿæˆå¤æ‚ JSON å®¹æ˜“å‡ºé”™
- âœ… **å¯è§£ææ€§**ï¼šä½¿ç”¨ `with_structured_output()` æˆ– JSON Schema æç¤º
- âœ… **å¯æ‰©å±•æ€§**ï¼šé¢„ç•™ `additional_info` å­—æ®µä¾›æœªæ¥æ‰©å±•

#### å®ç°ä»£ç 

```python
# tradingagents/agents/utils/analysis_schemas.py

from pydantic import BaseModel, Field
from typing import List, Optional, Dict, Any

class MacroAnalysis(BaseModel):
    """å®è§‚ç»æµåˆ†æè¾“å‡ºç»“æ„"""
    economic_cycle: str = Field(
        description="å½“å‰ç»æµå‘¨æœŸ: å¤è‹/æ‰©å¼ /æ»èƒ€/è¡°é€€",
        examples=["å¤è‹"]
    )
    liquidity: str = Field(
        description="æµåŠ¨æ€§çŠ¶å†µ: å®½æ¾/ä¸­æ€§/ç´§ç¼©",
        examples=["å®½æ¾"]
    )
    key_indicators: str = Field(
        description="å…³é”®æŒ‡æ ‡æ‘˜è¦ (GDP, CPI, PMIç­‰)",
        examples=["GDPå¢é€Ÿ5.2%ï¼ŒCPIæ¸©å’Œï¼ŒPMIå›å‡è‡³50.1"]
    )
    analysis_summary: str = Field(
        description="ç»¼åˆåˆ†æ (200å­—ä»¥å†…)"
    )
    confidence: float = Field(
        description="ç½®ä¿¡åº¦ (0.0 - 1.0)",
        ge=0.0, le=1.0
    )
    sentiment_score: float = Field(
        description="æƒ…ç»ªå¾—åˆ† (-1.0 æåº¦çœ‹ç©º, 0.0 ä¸­æ€§, 1.0 æåº¦çœ‹å¤š)",
        ge=-1.0, le=1.0
    )

class PolicyAnalysis(BaseModel):
    """æ”¿ç­–åˆ†æè¾“å‡ºç»“æ„"""
    monetary_policy: str = Field(
        description="è´§å¸æ”¿ç­–åŸºè°ƒ: å®½æ¾/ä¸­æ€§/ç´§ç¼©"
    )
    fiscal_policy: str = Field(
        description="è´¢æ”¿æ”¿ç­–åŸºè°ƒ: ç§¯æ/ç¨³å¥/ç´§ç¼©"
    )
    industry_policy: str = Field(
        description="é‡ç‚¹äº§ä¸šæ”¿ç­– (å¦‚ï¼šè‡ªä¸»å¯æ§ã€æ–°èƒ½æºç­‰)"
    )
    key_events: List[str] = Field(
        description="è¿‘æœŸå…³é”®æ”¿ç­–äº‹ä»¶ (æœ€å¤š5æ¡)",
        max_items=5
    )
    market_impact: str = Field(
        description="å¯¹å¸‚åœºçš„é¢„æœŸå½±å“: æ­£é¢/ä¸­æ€§/è´Ÿé¢"
    )
    analysis_summary: str = Field(
        description="ç»¼åˆåˆ†æ (200å­—ä»¥å†…)"
    )
    confidence: float = Field(ge=0.0, le=1.0)
    sentiment_score: float = Field(ge=-1.0, le=1.0)

class SectorPerformance(BaseModel):
    """å•ä¸ªæ¿å—è¡¨ç°"""
    name: str = Field(description="æ¿å—åç§°")
    change_pct: float = Field(description="æ¶¨è·Œå¹… (%)")
    fund_flow: Optional[float] = Field(default=None, description="èµ„é‡‘æµå…¥ (äº¿å…ƒ)")

class SectorAnalysis(BaseModel):
    """æ¿å—è½®åŠ¨åˆ†æè¾“å‡ºç»“æ„"""
    top_sectors: List[SectorPerformance] = Field(
        description="é¢†æ¶¨æ¿å— (å‰5å)",
        max_items=5
    )
    bottom_sectors: List[SectorPerformance] = Field(
        description="é¢†è·Œæ¿å— (å5å)",
        max_items=5
    )
    rotation_trend: str = Field(
        description="æ¿å—è½®åŠ¨ç‰¹å¾ (å¦‚ï¼šæˆé•¿â†’ä»·å€¼ã€å¤§ç›˜â†’å°ç›˜)"
    )
    hot_themes: List[str] = Field(
        description="å½“å‰çƒ­ç‚¹ä¸»é¢˜",
        max_items=5
    )
    analysis_summary: str = Field(
        description="ç»¼åˆåˆ†æ (200å­—ä»¥å†…)"
    )
    confidence: float = Field(ge=0.0, le=1.0)
    sentiment_score: float = Field(ge=-1.0, le=1.0)

class StrategyOutput(BaseModel):
    """Strategy Advisor æœ€ç»ˆè¾“å‡ºç»“æ„"""
    market_outlook: str = Field(
        description="å¸‚åœºå±•æœ›: çœ‹å¤š/ä¸­æ€§/çœ‹ç©º",
        examples=["çœ‹å¤š"]
    )
    recommended_position: float = Field(
        description="å»ºè®®ä»“ä½ (0.0 ç©ºä»“ - 1.0 æ»¡ä»“)",
        ge=0.0, le=1.0
    )
    key_risks: List[str] = Field(
        description="ä¸»è¦é£é™©ç‚¹ (æœ€å¤š5ä¸ª)",
        max_items=5
    )
    opportunity_sectors: List[str] = Field(
        description="æœºä¼šæ¿å— (æœ€å¤š5ä¸ª)",
        max_items=5
    )
    rationale: str = Field(
        description="å†³ç­–é€»è¾‘ (ç»¼åˆå®è§‚ã€æ”¿ç­–ã€æ¿å—åˆ†æ)"
    )
    final_sentiment_score: float = Field(
        description="ç»¼åˆæƒ…ç»ªå¾—åˆ† (åŠ æƒå¹³å‡)",
        ge=-1.0, le=1.0
    )
    confidence: float = Field(
        description="æœ€ç»ˆç½®ä¿¡åº¦",
        ge=0.0, le=1.0
    )

# ç®€åŒ–ç‰ˆï¼šç”¨äº Prompt å†…åµŒ JSON Schemaï¼ˆé¿å…ä½¿ç”¨ Pydanticï¼‰
MACRO_ANALYSIS_SCHEMA = """
{
  "economic_cycle": "å¤è‹/æ‰©å¼ /æ»èƒ€/è¡°é€€",
  "liquidity": "å®½æ¾/ä¸­æ€§/ç´§ç¼©",
  "key_indicators": "å…³é”®æŒ‡æ ‡æ‘˜è¦",
  "analysis_summary": "ç»¼åˆåˆ†æ(200å­—)",
  "confidence": 0.0-1.0,
  "sentiment_score": -1.0-1.0
}
"""

POLICY_ANALYSIS_SCHEMA = """
{
  "monetary_policy": "å®½æ¾/ä¸­æ€§/ç´§ç¼©",
  "fiscal_policy": "ç§¯æ/ç¨³å¥/ç´§ç¼©",
  "industry_policy": "é‡ç‚¹äº§ä¸šæ”¿ç­–",
  "key_events": ["äº‹ä»¶1", "äº‹ä»¶2"],
  "market_impact": "æ­£é¢/ä¸­æ€§/è´Ÿé¢",
  "analysis_summary": "ç»¼åˆåˆ†æ(200å­—)",
  "confidence": 0.0-1.0,
  "sentiment_score": -1.0-1.0
}
"""

SECTOR_ANALYSIS_SCHEMA = """
{
  "top_sectors": [{"name": "æ¿å—å", "change_pct": 3.5}],
  "bottom_sectors": [{"name": "æ¿å—å", "change_pct": -1.2}],
  "rotation_trend": "æ¿å—è½®åŠ¨ç‰¹å¾",
  "hot_themes": ["ä¸»é¢˜1", "ä¸»é¢˜2"],
  "analysis_summary": "ç»¼åˆåˆ†æ(200å­—)",
  "confidence": 0.0-1.0,
  "sentiment_score": -1.0-1.0
}
"""

STRATEGY_OUTPUT_SCHEMA = """
{
  "market_outlook": "çœ‹å¤š/ä¸­æ€§/çœ‹ç©º",
  "recommended_position": 0.0-1.0,
  "key_risks": ["é£é™©1", "é£é™©2"],
  "opportunity_sectors": ["æ¿å—1", "æ¿å—2"],
  "rationale": "å†³ç­–é€»è¾‘",
  "final_sentiment_score": -1.0-1.0,
  "confidence": 0.0-1.0
}
"""
```

#### ä½¿ç”¨æ–¹å¼

**æ–¹å¼1ï¼šPydantic ç»“æ„åŒ–è¾“å‡ºï¼ˆæ¨èç”¨äº OpenAI/Anthropicï¼‰**
```python
llm_with_structure = llm.with_structured_output(MacroAnalysis)
result = llm_with_structure.invoke(messages)
# result æ˜¯ MacroAnalysis å¯¹è±¡ï¼Œå·²è‡ªåŠ¨è§£æ
```

**æ–¹å¼2ï¼šPrompt å†…åµŒ JSON Schemaï¼ˆæ¨èç”¨äºå›½äº§ LLMï¼‰**
```python
prompt = f"""
è¯·æŒ‰ç…§ä»¥ä¸‹ JSON æ ¼å¼è¾“å‡ºåˆ†æç»“æœï¼š
{MACRO_ANALYSIS_SCHEMA}

è¾“å‡ºç¤ºä¾‹ï¼š
{{
  "economic_cycle": "å¤è‹",
  "liquidity": "å®½æ¾",
  ...
}}
"""
```
## 2. æ¥å£ä¸å·¥å…·è§„èŒƒ

### 2.1 æ•°æ®è·å–æ¥å£è®¾è®¡

#### è®¾è®¡åŸåˆ™
- âœ… **åˆ†å±‚è®¾è®¡**ï¼šæ•°æ®å±‚ (`dataflows`) â†’ å·¥å…·å±‚ (`tools`) â†’ Agent å±‚
- âœ… **ç¼“å­˜ä¼˜å…ˆ**ï¼šä¼˜å…ˆä½¿ç”¨ MongoDB ç¼“å­˜ï¼Œé™ä½ API è°ƒç”¨
- âœ… **å¼‚å¸¸å¤„ç†**ï¼šæ‰€æœ‰æ•°æ®æ¥å£å¿…é¡»æœ‰é™çº§æ–¹æ¡ˆ

#### æ ¸å¿ƒæ•°æ®æ¥å£æ¨¡å— (`tradingagents/dataflows/index_data.py`)

```python
# tradingagents/dataflows/index_data.py

import pandas as pd
from typing import Dict, Any, Optional, List
from datetime import datetime, timedelta
import json

# å¯¼å…¥æ—¥å¿—
from tradingagents.utils.logging_init import get_logger
logger = get_logger("dataflows")

# å¯¼å…¥ç¼“å­˜ç®¡ç†å™¨
from tradingagents.dataflows.cache import get_cache

class IndexDataProvider:
    """æŒ‡æ•°åˆ†ææ•°æ®æä¾›è€…"""
    
    def __init__(self):
        self.cache = get_cache()
        self.cache_ttl = 86400  # å®è§‚æ•°æ®ç¼“å­˜ 24 å°æ—¶
    
    def get_macro_economics_data(self, end_date: str = None) -> Dict[str, Any]:
        """
        è·å–å®è§‚ç»æµæ•°æ®
        
        Args:
            end_date: æˆªæ­¢æ—¥æœŸï¼ˆé»˜è®¤ä¸ºå½“å‰æ—¥æœŸï¼‰
        
        Returns:
            Dict åŒ…å« GDP, CPI, PMI, M2, LPR ç­‰å®è§‚æŒ‡æ ‡
        """
        cache_key = f"macro_data_{end_date or 'latest'}"
        
        # å°è¯•ä»ç¼“å­˜è·å–
        cached = self.cache.get(cache_key)
        if cached:
            logger.info(f"âœ… [ç¼“å­˜å‘½ä¸­] å®è§‚æ•°æ®: {cache_key}")
            return json.loads(cached)
        
        logger.info(f"ğŸ” [æ•°æ®è·å–] å¼€å§‹è·å–å®è§‚æ•°æ®...")
        
        result = {}
        
        try:
            import akshare as ak
            
            # GDP (å­£åº¦æ•°æ®)
            try:
                gdp_df = ak.macro_china_gdp_yearly()
                if not gdp_df.empty:
                    latest_gdp = gdp_df.iloc[-1]
                    result["gdp"] = {
                        "value": float(latest_gdp["å­£åº¦å€¼"]) if "å­£åº¦å€¼" in latest_gdp else None,
                        "yoy": float(latest_gdp["åŒæ¯”å¢é•¿"]) if "åŒæ¯”å¢é•¿" in latest_gdp else None,
                        "period": str(latest_gdp["å­£åº¦"]) if "å­£åº¦" in latest_gdp else None
                    }
                    logger.info(f"âœ… GDP æ•°æ®è·å–æˆåŠŸ")
            except Exception as e:
                logger.warning(f"âš ï¸ GDP æ•°æ®è·å–å¤±è´¥: {e}")
                result["gdp"] = None
            
            # CPI (æœˆåº¦æ•°æ®)
            try:
                cpi_df = ak.macro_china_cpi_monthly()
                if not cpi_df.empty:
                    latest_cpi = cpi_df.iloc[-1]
                    result["cpi"] = {
                        "value": float(latest_cpi["å…¨å›½åŒæ¯”"]) if "å…¨å›½åŒæ¯”" in latest_cpi else None,
                        "mom": float(latest_cpi["å…¨å›½ç¯æ¯”"]) if "å…¨å›½ç¯æ¯”" in latest_cpi else None,
                        "date": str(latest_cpi["æœˆä»½"]) if "æœˆä»½" in latest_cpi else None
                    }
                    logger.info(f"âœ… CPI æ•°æ®è·å–æˆåŠŸ")
            except Exception as e:
                logger.warning(f"âš ï¸ CPI æ•°æ®è·å–å¤±è´¥: {e}")
                result["cpi"] = None
            
            # PMI (æœˆåº¦æ•°æ®)
            try:
                pmi_df = ak.macro_china_pmi_yearly()
                if not pmi_df.empty:
                    latest_pmi = pmi_df.iloc[-1]
                    result["pmi"] = {
                        "manufacturing": float(latest_pmi["åˆ¶é€ ä¸šPMI"]) if "åˆ¶é€ ä¸šPMI" in latest_pmi else None,
                        "non_manufacturing": float(latest_pmi["éåˆ¶é€ ä¸šPMI"]) if "éåˆ¶é€ ä¸šPMI" in latest_pmi else None,
                        "date": str(latest_pmi["æœˆä»½"]) if "æœˆä»½" in latest_pmi else None
                    }
                    logger.info(f"âœ… PMI æ•°æ®è·å–æˆåŠŸ")
            except Exception as e:
                logger.warning(f"âš ï¸ PMI æ•°æ®è·å–å¤±è´¥: {e}")
                result["pmi"] = None
            
            # M2 è´§å¸ä¾›åº”é‡
            try:
                m2_df = ak.macro_china_money_supply()
                if not m2_df.empty:
                    latest_m2 = m2_df.iloc[-1]
                    result["m2"] = {
                        "value": float(latest_m2["M2-åŒæ¯”å¢é•¿"]) if "M2-åŒæ¯”å¢é•¿" in latest_m2 else None,
                        "date": str(latest_m2["æœˆä»½"]) if "æœˆä»½" in latest_m2 else None
                    }
                    logger.info(f"âœ… M2 æ•°æ®è·å–æˆåŠŸ")
            except Exception as e:
                logger.warning(f"âš ï¸ M2 æ•°æ®è·å–å¤±è´¥: {e}")
                result["m2"] = None
            
            # LPR è´·æ¬¾å¸‚åœºæŠ¥ä»·åˆ©ç‡
            try:
                lpr_df = ak.macro_china_lpr()
                if not lpr_df.empty:
                    latest_lpr = lpr_df.iloc[-1]
                    result["lpr"] = {
                        "lpr_1y": float(latest_lpr["1å¹´"]) if "1å¹´" in latest_lpr else None,
                        "lpr_5y": float(latest_lpr["5å¹´ä»¥ä¸Š"]) if "5å¹´ä»¥ä¸Š" in latest_lpr else None,
                        "date": str(latest_lpr["æ—¥æœŸ"]) if "æ—¥æœŸ" in latest_lpr else None
                    }
                    logger.info(f"âœ… LPR æ•°æ®è·å–æˆåŠŸ")
            except Exception as e:
                logger.warning(f"âš ï¸ LPR æ•°æ®è·å–å¤±è´¥: {e}, å°è¯•ä½¿ç”¨ Shibor")
                # é™çº§åˆ° Shibor
                try:
                    shibor_df = ak.macro_china_shibor_all()
                    if not shibor_df.empty:
                        latest_shibor = shibor_df.iloc[-1]
                        result["lpr"] = {
                            "lpr_1y": float(latest_shibor["1Y"]) if "1Y" in latest_shibor else None,
                            "date": str(latest_shibor["æ—¥æœŸ"]) if "æ—¥æœŸ" in latest_shibor else None,
                            "source": "Shibor"
                        }
                except:
                    result["lpr"] = None
            
        except Exception as e:
            logger.error(f"âŒ [æ•°æ®å±‚é”™è¯¯] å®è§‚æ•°æ®è·å–å¤±è´¥: {e}")
            return {"error": str(e)}
        
        # ç¼“å­˜ç»“æœ
        self.cache.set(cache_key, json.dumps(result), ex=self.cache_ttl)
        logger.info(f"âœ… [æ•°æ®ç¼“å­˜] å®è§‚æ•°æ®å·²ç¼“å­˜: {cache_key}")
        
        return result
    
    def get_policy_news(self, lookback_days: int = 30) -> str:
        """
        è·å–è¿‘æœŸæ”¿ç­–æ–°é—»
        
        Args:
            lookback_days: å›æº¯å¤©æ•°
        
        Returns:
            æ”¿ç­–æ–°é—»æ‘˜è¦ï¼ˆMarkdown æ ¼å¼ï¼‰
        """
        cache_key = f"policy_news_{lookback_days}d"
        
        cached = self.cache.get(cache_key)
        if cached:
            logger.info(f"âœ… [ç¼“å­˜å‘½ä¸­] æ”¿ç­–æ–°é—»")
            return cached
        
        try:
            import akshare as ak
            
            # æ–¹æ¡ˆ1ï¼šä½¿ç”¨æ–°é—»è”æ’­æ–‡å­—ç¨¿
            news_df = ak.news_cctv()
            
            if not news_df.empty:
                # ç­›é€‰è¿‘æœŸæ–°é—»
                end_date = datetime.now()
                start_date = end_date - timedelta(days=lookback_days)
                
                recent_news = news_df[
                    pd.to_datetime(news_df["æ—¥æœŸ"]) >= start_date
                ]
                
                # ç”Ÿæˆ Markdown
                news_summary = f"## è¿‘ {lookback_days} å¤©æ”¿ç­–æ–°é—»\n\n"
                
                for idx, row in recent_news.head(10).iterrows():
                    news_summary += f"### {row['æ—¥æœŸ']} - {row['æ ‡é¢˜']}\n"
                    news_summary += f"{row['å†…å®¹'][:200]}...\n\n"
                
                # ç¼“å­˜ 6 å°æ—¶
                self.cache.set(cache_key, news_summary, ex=21600)
                return news_summary
            
        except Exception as e:
            logger.warning(f"âš ï¸ æ”¿ç­–æ–°é—»è·å–å¤±è´¥: {e}ï¼Œä½¿ç”¨é™çº§æ–¹æ¡ˆ")
            
            # é™çº§æ–¹æ¡ˆï¼šç™¾åº¦è´¢ç»æ–°é—»
            try:
                news_df = ak.news_economic_baidu()
                return f"è¿‘æœŸè´¢ç»æ–°é—»æ‘˜è¦ï¼ˆæ¥è‡ªç™¾åº¦ï¼‰\n{news_df.head(5).to_markdown()}"
            except:
                return "æ”¿ç­–æ–°é—»æ•°æ®è·å–å¤±è´¥ï¼Œå°†ä¾èµ– LLM å†…éƒ¨çŸ¥è¯†åº“"
    
    def get_sector_flows(self, trade_date: str = None) -> pd.DataFrame:
        """
        è·å–æ¿å—èµ„é‡‘æµå‘
        
        Args:
            trade_date: äº¤æ˜“æ—¥æœŸï¼ˆé»˜è®¤ä¸ºæœ€æ–°ï¼‰
        
        Returns:
            DataFrame åŒ…å«æ¿å—åç§°ã€æ¶¨è·Œå¹…ã€èµ„é‡‘æµå…¥
        """
        cache_key = f"sector_flows_{trade_date or 'latest'}"
        
        try:
            import akshare as ak
            
            # ä½¿ç”¨ä¸œæ–¹è´¢å¯Œæ¿å—èµ„é‡‘æµ
            sector_df = ak.stock_sector_fund_flow_rank(symbol="ä»Šæ—¥")
            
            if not sector_df.empty:
                logger.info(f"âœ… æ¿å—èµ„é‡‘æµå‘æ•°æ®è·å–æˆåŠŸï¼š{len(sector_df)} ä¸ªæ¿å—")
                return sector_df
            
        except Exception as e:
            logger.warning(f"âš ï¸ æ¿å—æµå‘æ•°æ®è·å–å¤±è´¥: {e}ï¼Œä½¿ç”¨é™çº§æ–¹æ¡ˆ")
            
            # é™çº§æ–¹æ¡ˆï¼šæ¿å—åç§°åˆ—è¡¨
            try:
                sector_df = ak.stock_board_industry_name_em()
                logger.info(f"âœ… æ¿å—åç§°æ•°æ®è·å–æˆåŠŸï¼ˆé™çº§æ–¹æ¡ˆï¼‰")
                return sector_df
            except:
                logger.error("âŒ æ¿å—æ•°æ®è·å–å®Œå…¨å¤±è´¥")
                return pd.DataFrame()
    
    def get_market_valuation(self) -> Dict[str, float]:
        """
        è·å–å¸‚åœºæ•´ä½“ä¼°å€¼
        
        Returns:
            Dict åŒ…å« PE/PB åˆ†ä½æ•°
        """
        # TODO: å®ç°é€»è¾‘ï¼Œéœ€è¦æ•°æ®æºæ”¯æŒ
        return {
            "pe_percentile": None,
            "pb_percentile": None,
            "note": "æš‚æœªå®ç°ï¼Œå¾…æ•°æ®æºæ¥å…¥"
        }

# å…¨å±€å®ä¾‹
index_data_provider = IndexDataProvider()
```

#### æ•°æ®æ¥å£è¯´æ˜è¡¨

| æ¥å£æ–¹æ³• | åŠŸèƒ½ | æ•°æ®æº | ç¼“å­˜æ—¶é—´ | é™çº§æ–¹æ¡ˆ |
|---------|------|---------|----------|----------|
| `get_macro_economics_data()` | è·å– GDP/CPI/PMI/M2/LPR | AKShare | 24h | Shibor æ›¿ä»£ LPR |
| `get_policy_news()` | è·å–æ”¿ç­–æ–°é—» | AKShare (CCTV) | 6h | ç™¾åº¦è´¢ç»æ–°é—» |
| `get_sector_flows()` | è·å–æ¿å—èµ„é‡‘æµå‘ | AKShare (ä¸œè´¢) | å®æ—¶ | æ¿å—åç§°åˆ—è¡¨ |
| `get_market_valuation()` | è·å–å¸‚åœºä¼°å€¼ | TODO | - | - |
### 2.2 LangChain å·¥å…·å®šä¹‰ (`tradingagents/tools/index_tools.py`)

å°†æ•°æ®æ¥å£å°è£…ä¸º Agent å¯ç”¨çš„å·¥å…·ã€‚

#### è®¾è®¡åŸåˆ™
- âœ… **éµå¾ªç°æœ‰æ¨¡å¼**ï¼šå‚è€ƒ `agent_utils.py` ä¸­çš„å·¥å…·å®šä¹‰æ–¹å¼
- âœ… **æ¸…æ™°çš„æè¿°**ï¼šLLM èƒ½æ ¹æ®æè¿°æ­£ç¡®é€‰æ‹©å·¥å…·
- âœ… **ç±»å‹æç¤º**ï¼šä½¿ç”¨ `Annotated` æä¾›å‚æ•°è¯´æ˜

```python
# tradingagents/tools/index_tools.py

from langchain.tools import tool
from typing import Annotated
from tradingagents.dataflows.index_data import index_data_provider

@tool
def fetch_macro_data(query_date: Annotated[str, "æŸ¥è¯¢æ—¥æœŸï¼Œæ ¼å¼ yyyy-mm-dd"]) -> str:
    """
    è·å–æŒ‡å®šæ—¥æœŸçš„å®è§‚ç»æµæŒ‡æ ‡ï¼ŒåŒ…æ‹¬GDPã€CPIã€PMIå’Œè´§å¸ä¾›åº”é‡ç­‰ã€‚
    è¿™äº›æŒ‡æ ‡åæ˜ äº†å½“å‰ç»æµå‘¨æœŸæ‰€å¤„çš„é˜¶æ®µã€‚
    """
    try:
        data = index_data_provider.get_macro_economics_data(query_date)
        
        # æ ¼å¼åŒ–ä¸º Markdown
        result = f"## å®è§‚ç»æµæ•°æ®ï¼ˆæˆªæ­¢ {query_date}ï¼‰\n\n"
        
        if data.get("gdp"):
            result += f"### GDP\n"
            result += f"- å­£åº¦å€¼: {data['gdp'].get('value', 'N/A')}\n"
            result += f"- åŒæ¯”å¢é•¿: {data['gdp'].get('yoy', 'N/A')}%\n"
            result += f"- æœŸé—´: {data['gdp'].get('period', 'N/A')}\n\n"
        
        if data.get("cpi"):
            result += f"### CPI ï¼ˆæ¶ˆè´¹è€…ä»·æ ¼æŒ‡æ•°ï¼‰\n"
            result += f"- åŒæ¯”: {data['cpi'].get('value', 'N/A')}%\n"
            result += f"- ç¯æ¯”: {data['cpi'].get('mom', 'N/A')}%\n"
            result += f"- æ—¥æœŸ: {data['cpi'].get('date', 'N/A')}\n\n"
        
        if data.get("pmi"):
            result += f"### PMI ï¼ˆé‡‡è´­ç»ç†äººæŒ‡æ•°ï¼‰\n"
            result += f"- åˆ¶é€ ä¸š: {data['pmi'].get('manufacturing', 'N/A')}\n"
            result += f"- éåˆ¶é€ ä¸š: {data['pmi'].get('non_manufacturing', 'N/A')}\n"
            result += f"- æ—¥æœŸ: {data['pmi'].get('date', 'N/A')}\n\n"
        
        if data.get("m2"):
            result += f"### M2 ï¼ˆè´§å¸ä¾›åº”é‡ï¼‰\n"
            result += f"- åŒæ¯”å¢é•¿: {data['m2'].get('value', 'N/A')}%\n"
            result += f"- æ—¥æœŸ: {data['m2'].get('date', 'N/A')}\n\n"
        
        if data.get("lpr"):
            result += f"### LPR ï¼ˆè´·æ¬¾å¸‚åœºæŠ¥ä»·åˆ©ç‡ï¼‰\n"
            result += f"- 1å¹´æœŸ: {data['lpr'].get('lpr_1y', 'N/A')}%\n"
            result += f"- 5å¹´æœŸ: {data['lpr'].get('lpr_5y', 'N/A')}%\n"
            result += f"- æ—¥æœŸ: {data['lpr'].get('date', 'N/A')}\n\n"
        
        return result
        
    except Exception as e:
        return f"å®è§‚æ•°æ®è·å–å¤±è´¥: {str(e)}"

@tool
def fetch_policy_news(lookback_days: Annotated[int, "å›æº¯å¤©æ•°ï¼Œé»˜è®¤30å¤©"] = 30) -> str:
    """
    è·å–æœ€è¿‘çš„é‡è¦è´¢æ”¿å’Œè´§å¸æ”¿ç­–æ–°é—»ã€‚
    åŒ…æ‹¬å¤®è¡Œå†³ç­–ã€è´¢æ”¿æ”¿ç­–è°ƒæ•´ã€äº§ä¸šæ”¿ç­–ç­‰ã€‚
    """
    try:
        news = index_data_provider.get_policy_news(lookback_days)
        return news
    except Exception as e:
        return f"æ”¿ç­–æ–°é—»è·å–å¤±è´¥: {str(e)}"

@tool
def fetch_sector_rotation(trade_date: Annotated[str, "äº¤æ˜“æ—¥æœŸï¼Œæ ¼å¼ yyyy-mm-dd"]) -> str:
    """
    è·å–æ¿å—èµ„é‡‘æµå‘å’Œæ¶¨è·Œå¹…æ’åï¼Œç”¨äºåˆ†ææ¿å—è½®åŠ¨ã€‚
    åŒ…æ‹¬é¢†æ¶¨æ¿å—ã€é¢†è·Œæ¿å—å’Œèµ„é‡‘æµå‘æƒ…å†µã€‚
    """
    try:
        df = index_data_provider.get_sector_flows(trade_date)
        
        if df.empty:
            return "æ¿å—æ•°æ®è·å–å¤±è´¥æˆ–ä¸ºç©º"
        
        # æ ¼å¼åŒ–ä¸º Markdown
        result = f"## æ¿å—èµ„é‡‘æµå‘ï¼ˆ{trade_date}ï¼‰\n\n"
        
        # é¢†æ¶¨æ¿å— (top 5)
        result += "### ğŸ”º é¢†æ¶¨æ¿å— (Top 5)\n\n"
        top5 = df.head(5)
        for idx, row in top5.iterrows():
            result += f"- **{row.get('æ¿å—åç§°', 'N/A')}**: æ¶¨å¹… {row.get('æ¶¨è·Œå¹…', 0):.2f}%, èµ„é‡‘æµå…¥ {row.get('ä¸»åŠ›å‡€æµå…¥', 0):.2f}äº¿\n"
        
        # é¢†è·Œæ¿å— (bottom 5)
        result += "\n### ğŸ”» é¢†è·Œæ¿å— (Bottom 5)\n\n"
        bottom5 = df.tail(5)
        for idx, row in bottom5.iterrows():
            result += f"- **{row.get('æ¿å—åç§°', 'N/A')}**: æ¶¨å¹… {row.get('æ¶¨è·Œå¹…', 0):.2f}%, èµ„é‡‘æµå…¥ {row.get('ä¸»åŠ›å‡€æµå…¥', 0):.2f}äº¿\n"
        
        return result
        
    except Exception as e:
        return f"æ¿å—æ•°æ®è·å–å¤±è´¥: {str(e)}"

# å·¥å…·åˆ—è¡¨ï¼ˆç”¨äº Agent ç»‘å®šï¼‰
INDEX_ANALYSIS_TOOLS = [
    fetch_macro_data,
    fetch_policy_news,
    fetch_sector_rotation
]
```
### 2.3.1 æ•°æ®æºæ˜ å°„è¡¨ (Data Source Implementation Map)
æœ¬èŠ‚è¯¦ç»†å®šä¹‰äº†å„ä¸ªåˆ†æç»´åº¦æ‰€éœ€çš„å…·ä½“æ•°æ®æºåŠ AKShare æ¥å£ã€‚å¦‚æœåœ¨è¿è¡Œæ—¶æ¥å£ä¸å¯ç”¨ï¼Œç³»ç»Ÿåº”è®°å½•è­¦å‘Šå¹¶å°è¯•ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆæˆ–è·³è¿‡è¯¥æŒ‡æ ‡ã€‚
| æ•°æ®ç±»åˆ« | æŒ‡æ ‡åç§° | AKShare æ¥å£åç§° | å¤‡æ³¨/å‚æ•° | å¤±è´¥é™çº§æ–¹æ¡ˆ |
| :--- | :--- | :--- | :--- | :--- |
| **æŒ‡æ•°è¡Œæƒ…** | æŒ‡æ•°æ—¥çº¿æ•°æ® | `stock_zh_index_daily` | symbol="sh000001" (ä¸Šè¯æŒ‡æ•°) | å¿…éœ€æ•°æ®ï¼Œè‹¥å¤±è´¥åˆ™æµç¨‹ç»ˆæ­¢ |
| **å®è§‚ç»æµ** | GDP (å­£åº¦) | `macro_china_gdp_yearly` | - | ä½¿ç”¨æœ€è¿‘ä¸€æœŸå†å²æ•°æ®æˆ–å¿½ç•¥ |
| **å®è§‚ç»æµ** | CPI (æœˆåº¦) | `macro_china_cpi_monthly` | - | ä½¿ç”¨æœ€è¿‘ä¸€æœŸå†å²æ•°æ®æˆ–å¿½ç•¥ |
| **å®è§‚ç»æµ** | PMI (æœˆåº¦) | `macro_china_pmi_yearly` | - | ä½¿ç”¨æœ€è¿‘ä¸€æœŸå†å²æ•°æ®æˆ–å¿½ç•¥ |
| **å®è§‚ç»æµ** | è´§å¸ä¾›åº”é‡ M2 | `macro_china_money_supply` | - | ä½¿ç”¨æœ€è¿‘ä¸€æœŸå†å²æ•°æ®æˆ–å¿½ç•¥ |
| **å®è§‚ç»æµ** | åˆ©ç‡ (LPR) | `macro_china_lpr` | - | ä½¿ç”¨ Shibor (`macro_china_shibor_all`) |
| **è¡Œä¸šæ¿å—** | è¡Œä¸šæ¿å—æ¶¨è·Œå¹… | `stock_sector_fund_flow_rank` | ä¸œæ–¹è´¢å¯Œèµ„é‡‘æµå‘æ’å | ä½¿ç”¨ `stock_board_industry_name_em` |
| **è¡Œä¸šæ¿å—** | æ¿å—èµ„é‡‘æµå‘ | `stock_sector_fund_flow_rank` | - | å¿½ç•¥èµ„é‡‘æµå‘åˆ†æ |
| **æ”¿ç­–/æ–°é—»** | è´¢ç»æ–°é—» | `news_cctv` | æ–°é—»è”æ’­æ–‡å­—ç¨¿ | ä½¿ç”¨ `news_economic_baidu` |
| **æ”¿ç­–/æ–°é—»** | æ”¿ç­–é¢åˆ†æ | N/A | - | ä¾èµ– LLM å†…éƒ¨çŸ¥è¯†åº“ (fallback) |
> **æ³¨æ„**: AKShare æ¥å£å¯èƒ½ä¼šéšæºç«™æ›´æ–°è€Œå˜åŠ¨ã€‚å»ºè®®åœ¨ `tradingagents/dataflows/index_data.py` ä¸­å®ç°å¼‚å¸¸æ•è·æœºåˆ¶ï¼Œå½“ç‰¹å®šæ¥å£å¤±æ•ˆæ—¶ï¼Œè¿”å› `None` æˆ–é»˜è®¤ç©ºå€¼ï¼Œå¹¶åœ¨æ—¥å¿—ä¸­è®°å½•ï¼Œç¡®ä¿ä¸»æµç¨‹ä¸ä¸­æ–­ã€‚
### 2.5 Agent Prompt æ¨¡æ¿ (Agent Prompt Templates)
ä¸ºäº†ä¿è¯åˆ†æç»“æœçš„ä¸€è‡´æ€§å’Œå¯è§£ææ€§ï¼Œæˆ‘ä»¬å°†ä¸ºæ¯ä¸ª Specialist Agent å®šä¹‰è¯¦ç»†çš„ System Promptã€‚æ‰€æœ‰ Agent å¿…é¡»è¾“å‡ºåŒ…å« `confidence` (ç½®ä¿¡åº¦) å’Œ `sentiment_score` (æƒ…ç»ªåˆ†) çš„ JSON æ ¼å¼ã€‚
#### 2.5.1 Macro Analyst (å®è§‚åˆ†æå¸ˆ)
```text
è§’è‰²: å®è§‚ç»æµåˆ†æå¸ˆ
ä»»åŠ¡: åŸºäºæä¾›çš„æ•°æ®æŒ‡æ ‡åˆ†æå½“å‰çš„å®è§‚ç»æµç¯å¢ƒã€‚
è¾“å…¥æ•°æ®:
- GDP å¢é•¿ç‡: {gdp}
- CPI (é€šèƒ€): {cpi}
- PMI (åˆ¶é€ ä¸š): {pmi}
- è´§å¸ä¾›åº”é‡ (M2): {m2}
- åˆ©ç‡ (LPR): {lpr}
æŒ‡ä»¤:
1. åˆ†ææ¯ä¸ªæŒ‡æ ‡çš„è¶‹åŠ¿ (ä¸Šå‡/ä¸‹é™/æŒå¹³)ã€‚
2. ç¡®å®šå½“å‰çš„ç»æµå‘¨æœŸé˜¶æ®µ (å¤è‹/æ‰©å¼ /æ”¾ç¼“/è¡°é€€)ã€‚
3. è¯„ä¼°æµåŠ¨æ€§çŠ¶å†µ (å®½æ¾/ä¸­æ€§/ç´§ç¼©)ã€‚
4. æä¾›ä¸€ä¸ªä»‹äº -1.0 (éå¸¸æ¶ˆæ) å’Œ 1.0 (éå¸¸ç§¯æ) ä¹‹é—´çš„æƒ…ç»ªå¾—åˆ†ã€‚
5. æä¾›ä¸€ä¸ªä»‹äº 0.0 (çŒœæµ‹) å’Œ 1.0 (ç¡®å®š) ä¹‹é—´çš„ç½®ä¿¡åº¦åˆ†æ•°ã€‚
è¾“å‡ºæ ¼å¼ (JSON):
{
    "indicators": [
        {"name": "GDP", "value": 5.2, "trend": "æŒå¹³"},
        {"name": "CPI", "value": 0.3, "trend": "ä¸‹é™"}
    ],
    "economic_cycle": "å¤è‹",
    "liquidity_assessment": "å®½æ¾",
    "analysis_summary": "GDPå¢é•¿ç¨³å®šï¼Œä½†CPIæ˜¾ç¤ºéœ€æ±‚ç–²è½¯...",
    "sentiment_score": 0.3,
    "confidence": 0.8
}
```
#### 2.5.2 Policy Analyst (æ”¿ç­–åˆ†æå¸ˆ)
```text
è§’è‰²: æ”¿ç­–åˆ†æå¸ˆ
ä»»åŠ¡: åˆ†ææœ€æ–°çš„æ”¿ç­–æ–°é—»å¹¶ç¡®å®šå…¶å¯¹è‚¡ç¥¨å¸‚åœºçš„å½±å“ã€‚
è¾“å…¥æ•°æ®:
- è¿‘æœŸæ–°é—»/æ”¿ç­–äº‹ä»¶: {policy_news}
æŒ‡ä»¤:
1. è¯†åˆ«ä¸è´§å¸æ”¿ç­–ã€è´¢æ”¿æ”¿ç­–å’Œè¡Œä¸šç›‘ç®¡ç›¸å…³çš„å…³é”®æ”¿ç­–äº‹ä»¶ã€‚
2. è¯„ä¼°è¿™äº›äº‹ä»¶å¯¹å¸‚åœºçš„å½±å“ (æ­£é¢/è´Ÿé¢/ä¸­æ€§)ã€‚
3. æ€»ç»“æ•´ä½“æ”¿ç­–ç«‹åœº (æ”¯æŒ/é™åˆ¶/ä¸­æ€§)ã€‚
4. æä¾›ä¸€ä¸ªä»‹äº -1.0 (éå¸¸æ¶ˆæ) å’Œ 1.0 (éå¸¸ç§¯æ) ä¹‹é—´çš„æƒ…ç»ªå¾—åˆ†ã€‚
5. åŸºäºæ–°é—»æ¥æºçš„æ¸…æ™°åº¦å’Œæƒå¨æ€§æä¾›ç½®ä¿¡åº¦åˆ†æ•°ã€‚
è¾“å‡ºæ ¼å¼ (JSON):
{
    "monetary_policy": "å®½æ¾",
    "fiscal_policy": "ç§¯æ",
    "key_events": [
        {"title": "é™å‡†", "impact": "æ­£é¢", "description": "å¤®è¡Œé™å‡† 0.5%"}
    ],
    "market_impact": "æ­£é¢",
    "analysis_summary": "é™å‡†ä¿¡å·è¡¨æ˜å¯¹æµåŠ¨æ€§çš„å¼ºåŠ›æ”¯æŒ...",
    "sentiment_score": 0.6,
    "confidence": 0.9
}
```

#### 2.5.3 Sector Analyst (è¡Œä¸šæ¿å—åˆ†æå¸ˆ)
```text
è§’è‰²: è¡Œä¸šæ¿å—åˆ†æå¸ˆ
ä»»åŠ¡: åˆ†ææ¿å—è¡¨ç°å’Œèµ„é‡‘æµå‘ä»¥è¯†åˆ«å¸‚åœºè¶‹åŠ¿ã€‚
è¾“å…¥æ•°æ®:
- é¢†æ¶¨æ¿å—: {top_sectors}
- é¢†è·Œæ¿å—: {bottom_sectors}
- èµ„é‡‘æµå…¥/æµå‡º: {fund_flows}
æŒ‡ä»¤:
1. è¯†åˆ«å“ªäº›æ¿å—æ­£åœ¨å¼•é¢†å¸‚åœºã€‚
2. åˆ†æå¸‚åœºæ˜¯å¦ç”±ç‰¹å®šä¸»é¢˜ï¼ˆå¦‚äººå·¥æ™ºèƒ½ã€æ–°èƒ½æºï¼‰é©±åŠ¨ï¼Œè¿˜æ˜¯å¹¿æ³›ä¸Šæ¶¨ã€‚
3. æ£€æµ‹æ¿å—è½®åŠ¨è¶‹åŠ¿ï¼ˆä¾‹å¦‚ï¼Œä»é˜²å¾¡æ€§è½¬å‘å‘¨æœŸæ€§ï¼‰ã€‚
4. æä¾›åæ˜ å¸‚åœºåå¼¹/ä¸‹è·Œçš„å¹¿åº¦å’Œå¥åº·çŠ¶å†µçš„æƒ…ç»ªå¾—åˆ†ã€‚
è¾“å‡ºæ ¼å¼ (JSON):
{
    "top_sectors": [{"name": "åŠå¯¼ä½“", "change_pct": 3.5}],
    "bottom_sectors": [{"name": "æˆ¿åœ°äº§", "change_pct": -1.2}],
    "rotation_trend": "æˆé•¿æ¿å—è¡¨ç°ä¼˜äºä»·å€¼æ¿å—...",
    "hot_concepts": ["äººå·¥æ™ºèƒ½", "ç®—åŠ›"],
    "analysis_summary": "ç§‘æŠ€æ¿å—çš„å¼ºåŠ²æµå…¥è¡¨æ˜é£é™©åå¥½è¾ƒé«˜...",
    "sentiment_score": 0.4,
    "confidence": 0.8
}
```
#### 2.5.4 Strategy Advisor (ç­–ç•¥é¡¾é—®)
```text
è§’è‰²: é¦–å¸­ç­–ç•¥é¡¾é—®
ä»»åŠ¡: ç»¼åˆå®è§‚ã€æ”¿ç­–å’Œæ¿å—åˆ†æï¼Œåˆ¶å®šæœ€ç»ˆçš„æŠ•èµ„ç­–ç•¥ã€‚
è¾“å…¥æ•°æ®:
- å®è§‚åˆ†æ: {macro_analysis}
- æ”¿ç­–åˆ†æ: {policy_analysis}
- æ¿å—åˆ†æ: {sector_analysis}
- å¸‚åœºä¼°å€¼: {valuation}
æŒ‡ä»¤:
1. ç»¼åˆæ‰€æœ‰è¾“å…¥ä»¥ç¡®å®šæ•´ä½“å¸‚åœºå±•æœ› (çœ‹æ¶¨/çœ‹è·Œ/ä¸­æ€§)ã€‚
2. å»ºè®®å…·ä½“çš„ä»“ä½æ°´å¹³ (0.0 åˆ° 1.0)ã€‚
3. å¼ºè°ƒå…³é”®é£é™© (ä¾‹å¦‚ï¼Œå¤–éƒ¨å†²å‡»ã€æ”¿ç­–æ”¶ç´§)ã€‚
4. åŸºäºæ¿å—åˆ†æå’Œæ”¿ç­–æ”¯æŒæ¨èæœºä¼šæ¿å—ã€‚
5. æä¾›æœ€ç»ˆçš„åŠ æƒæƒ…ç»ªå¾—åˆ†ã€‚
è¾“å‡ºæ ¼å¼ (JSON):
{
    "market_outlook": "çœ‹æ¶¨",
    "recommended_position": 0.7,
    "key_risks": ["æ±‡ç‡æ³¢åŠ¨", "æ¶ˆè´¹ç–²è½¯"],
    "opportunity_sectors": ["ç§‘æŠ€", "é«˜è‚¡æ¯"],
    "rationale": "å®è§‚å¤è‹ç»“åˆæ”¯æŒæ€§è´§å¸æ”¿ç­–...",
    "final_sentiment_score": 0.55
}
```
## 3. Agent èŠ‚ç‚¹è¯¦ç»†å®ç°

### ğŸ“‹ å¯è¡Œæ€§åˆ†æç»“è®º

âœ… **æ•´ä½“å¯è¡Œæ€§ï¼šé«˜åº¦å¯è¡Œ**

1. **æ¶æ„å…¼å®¹æ€§** â­â­â­â­â­
   - ç°æœ‰ LangGraph æ¶æ„å®Œå…¨æ”¯æŒåˆ†æ”¯å·¥ä½œæµ
   - AgentState åŸºäº MessagesStateï¼Œæ‰©å±•æ€§æå¼º
   - æ— éœ€ä¿®æ”¹æ ¸å¿ƒæ¡†æ¶ä»£ç 
   
2. **ä»£ç å¤ç”¨æ€§** â­â­â­â­â­
   - å¯å®Œå…¨å¤ç”¨ç°æœ‰ Analyst èŠ‚ç‚¹çš„åˆ›å»ºæ¨¡å¼ï¼ˆ`create_market_analyst`ï¼‰
   - å·¥å…·ç»‘å®šæœºåˆ¶ï¼ˆ`llm.bind_tools()`ï¼‰å·²éªŒè¯ç¨³å®š
   - æ¡ä»¶è·¯ç”±é€»è¾‘ï¼ˆ`should_continue_*`ï¼‰æ¨¡å¼æˆç†Ÿ
   
3. **å¯¹åŸæœ‰ä»£ç çš„å½±å“** â­â­â­â­â­ï¼ˆæœ€å°åŒ–ï¼‰
   - âœ… **é›¶ç ´åæ€§ä¿®æ”¹**ï¼šä»…åœ¨ `AgentState` æ·»åŠ æ–°å­—æ®µï¼Œä¸å½±å“ç°æœ‰ä¸ªè‚¡åˆ†ææµç¨‹
   - âœ… **éš”ç¦»è®¾è®¡**ï¼šæŒ‡æ•°åˆ†æèŠ‚ç‚¹ç‹¬ç«‹äºä¸ªè‚¡åˆ†æèŠ‚ç‚¹ï¼Œé€šè¿‡ `is_index` è·¯ç”±
   - âœ… **æ•°æ®å±‚éš”ç¦»**ï¼šæ–°å»º `index_data.py` å’Œ `index_tools.py`ï¼Œä¸ä¿®æ”¹ç°æœ‰æ•°æ®æ¥å£

4. **ç³»ç»Ÿå¯æ‰©å±•æ€§** â­â­â­â­â­
   - âœ… **æ’ä»¶åŒ–æ¶æ„**ï¼šæ–° Agent èŠ‚ç‚¹å¯ç‹¬ç«‹å¼€å‘ã€æµ‹è¯•ã€éƒ¨ç½²
   - âœ… **çµæ´»è·¯ç”±**ï¼šåŸºäº `is_index` å­—æ®µçš„è·¯ç”±æœºåˆ¶ï¼Œæœªæ¥å¯æ‰©å±•è‡³æœŸè´§ã€å€ºåˆ¸ç­‰èµ„äº§ç±»åˆ«
   - âœ… **ç»Ÿä¸€çŠ¶æ€ç®¡ç†**ï¼šæ‰€æœ‰åˆ†æç»“æœå­˜å‚¨åœ¨ `AgentState` ä¸­ï¼Œä¾¿äºè¿½æº¯å’Œè°ƒè¯•
   - âœ… **ç‹¬ç«‹å·¥å…·é›†**ï¼šæŒ‡æ•°åˆ†æå·¥å…·ä¸ä¸ªè‚¡å·¥å…·å®Œå…¨è§£è€¦ï¼Œäº’ä¸å¹²æ‰°

---

### 3.1 Macro Analystï¼ˆå®è§‚ç»æµåˆ†æå¸ˆï¼‰

**æ–‡ä»¶è·¯å¾„**: `tradingagents/agents/analysts/macro_analyst.py`

#### 3.1.1 åˆ†ææ€è·¯

**æ ¸å¿ƒèŒè´£**: åˆ†æå®è§‚ç»æµç¯å¢ƒï¼Œåˆ¤æ–­ç»æµå‘¨æœŸé˜¶æ®µå’ŒæµåŠ¨æ€§çŠ¶å†µ

**åˆ†æç»´åº¦**:
1. **ç»æµå‘¨æœŸåˆ¤æ–­**:
   - GDP å¢é€Ÿè¶‹åŠ¿ â†’ åˆ¤æ–­ç»æµæ˜¯å¤è‹ã€æ‰©å¼ ã€æ»èƒ€è¿˜æ˜¯è¡°é€€
   - PMI æŒ‡æ•°ï¼ˆ50ä¸ºè£æ¯çº¿ï¼‰â†’ éªŒè¯ç»æµæ´»è·ƒåº¦
   - CPI é€šèƒ€æ°´å¹³ â†’ åˆ¤æ–­ä»·æ ¼å‹åŠ›å’Œéœ€æ±‚å¼ºåº¦

2. **æµåŠ¨æ€§è¯„ä¼°**:
   - M2 åŒæ¯”å¢é€Ÿ â†’ åˆ¤æ–­è´§å¸ä¾›åº”æ˜¯å¦å……è£•
   - LPR åˆ©ç‡èµ°åŠ¿ â†’ åˆ¤æ–­èèµ„æˆæœ¬å’Œæ”¿ç­–å¯¼å‘
   - é™æ¯/é™å‡†é¢„æœŸ â†’ è¯†åˆ«æ”¿ç­–ä¿¡å·

3. **æƒ…ç»ªè¯„åˆ†é€»è¾‘**:
   - ç»æµæ‰©å¼  + æµåŠ¨æ€§å®½æ¾ â†’ `sentiment_score = 0.5 ~ 0.8`ï¼ˆçœ‹å¤šï¼‰
   - ç»æµè¡°é€€ + æµåŠ¨æ€§ç´§ç¼© â†’ `sentiment_score = -0.8 ~ -0.5`ï¼ˆçœ‹ç©ºï¼‰
   - æ»èƒ€ï¼ˆä½å¢é•¿é«˜é€šèƒ€ï¼‰â†’ `sentiment_score = -0.3 ~ 0.0`ï¼ˆè°¨æ…ï¼‰

**æ•°æ®æ¥æº**: 
- å·¥å…·ï¼š`fetch_macro_data(query_date)`
- æ•°æ®æºï¼šAKShareï¼ˆGDPã€CPIã€PMIã€M2ã€LPRï¼‰

#### 3.1.2 å®ç°ä»£ç 

```python
# tradingagents/agents/analysts/macro_analyst.py

from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder
import json

from tradingagents.utils.logging_init import get_logger
logger = get_logger("agents")

def create_macro_analyst(llm, index_toolkit):
    """
    åˆ›å»ºå®è§‚ç»æµåˆ†æå¸ˆèŠ‚ç‚¹
    
    Args:
        llm: è¯­è¨€æ¨¡å‹å®ä¾‹
        index_toolkit: æŒ‡æ•°åˆ†æå·¥å…·é›†ï¼ˆåŒ…å« fetch_macro_data ç­‰ï¼‰
    
    Returns:
        å®è§‚åˆ†æå¸ˆèŠ‚ç‚¹å‡½æ•°
    """
    
    def macro_analyst_node(state):
        logger.info("ğŸŒ [å®è§‚åˆ†æå¸ˆ] èŠ‚ç‚¹å¼€å§‹")
        
        # å·¥å…·è°ƒç”¨è®¡æ•°å™¨ - é˜²æ­¢æ­»å¾ªç¯
        tool_call_count = state.get("macro_tool_call_count", 0)
        max_tool_calls = 3
        logger.info(f"ğŸ”§ [å·¥å…·è°ƒç”¨] å½“å‰æ¬¡æ•°: {tool_call_count}/{max_tool_calls}")
        
        # å¦‚æœè¾¾åˆ°æœ€å¤§æ¬¡æ•°ï¼Œå¼ºåˆ¶è¿”å›é™çº§ç»“æœ
        if tool_call_count >= max_tool_calls:
            logger.warning("âš ï¸ [å®è§‚åˆ†æå¸ˆ] è¾¾åˆ°æœ€å¤§å·¥å…·è°ƒç”¨æ¬¡æ•°ï¼Œä½¿ç”¨é™çº§æ–¹æ¡ˆ")
            fallback_report = json.dumps({
                "economic_cycle": "æœªçŸ¥",
                "liquidity": "ä¸­æ€§",
                "key_indicators": "æ•°æ®è·å–å¤±è´¥",
                "analysis_summary": "ç”±äºæ•°æ®è·å–è¶…æ—¶ï¼Œæ— æ³•å®Œæˆå®è§‚åˆ†æ",
                "confidence": 0.3,
                "sentiment_score": 0.0
            }, ensure_ascii=False)
            return {
                "messages": [],
                "macro_report": fallback_report,
                "macro_tool_call_count": tool_call_count + 1
            }
        
        current_date = state["trade_date"]
        index_code = state["company_of_interest"]  # ä¾‹å¦‚ "sh000001"
        
        # æ„å»º Prompt
        prompt = ChatPromptTemplate.from_messages(
            [
                (
                    "system",
                    "ä½ æ˜¯ä¸€ä½èµ„æ·±çš„å®è§‚ç»æµåˆ†æå¸ˆï¼Œä¸“æ³¨äºé€šè¿‡å…³é”®ç»æµæŒ‡æ ‡åˆ†æå®è§‚ç»æµç¯å¢ƒã€‚\n"
                    "\n"
                    "ğŸ“Š **ä½ çš„ä»»åŠ¡ï¼š**\n"
                    "1. è°ƒç”¨å·¥å…·è·å–æœ€æ–°çš„å®è§‚ç»æµæ•°æ®ï¼ˆGDPã€CPIã€PMIã€M2ã€LPRï¼‰\n"
                    "2. åˆ†ææ¯ä¸ªæŒ‡æ ‡çš„è¶‹åŠ¿å’Œå«ä¹‰\n"
                    "3. åˆ¤æ–­å½“å‰ç»æµå‘¨æœŸé˜¶æ®µï¼ˆå¤è‹/æ‰©å¼ /æ»èƒ€/è¡°é€€ï¼‰\n"
                    "4. è¯„ä¼°æµåŠ¨æ€§çŠ¶å†µï¼ˆå®½æ¾/ä¸­æ€§/ç´§ç¼©ï¼‰\n"
                    "5. ç»™å‡ºæƒ…ç»ªè¯„åˆ†ï¼ˆ-1.0 æåº¦çœ‹ç©ºï¼Œ0.0 ä¸­æ€§ï¼Œ1.0 æåº¦çœ‹å¤šï¼‰\n"
                    "\n"
                    "ğŸ“‹ **åˆ†æå¯¹è±¡ï¼š**\n"
                    "- æŒ‡æ•°ä»£ç ï¼š{index_code}\n"
                    "- åˆ†ææ—¥æœŸï¼š{current_date}\n"
                    "\n"
                    "âš ï¸ **é‡è¦ï¼š**\n"
                    "- å¿…é¡»å…ˆè°ƒç”¨ fetch_macro_data å·¥å…·è·å–æ•°æ®\n"
                    "- è·å–æ•°æ®åï¼ŒæŒ‰ä»¥ä¸‹JSONæ ¼å¼è¾“å‡ºåˆ†æç»“æœï¼š\n"
                    "{{\n"
                    '  "economic_cycle": "å¤è‹/æ‰©å¼ /æ»èƒ€/è¡°é€€",\n'
                    '  "liquidity": "å®½æ¾/ä¸­æ€§/ç´§ç¼©",\n'
                    '  "key_indicators": "GDPå¢é€Ÿ5.2%, CPIæ¸©å’Œ, PMIå›å‡è‡³50.1",\n'
                    '  "analysis_summary": "ç»æµå¤„äºå¤è‹é˜¶æ®µï¼ŒæµåŠ¨æ€§ä¿æŒå®½æ¾...",\n'
                    '  "confidence": 0.85,\n'
                    '  "sentiment_score": 0.6\n'
                    "}}\n"
                    "\n"
                    "ğŸ’¡ **è¯„åˆ†æŒ‡å—ï¼š**\n"
                    "- ç»æµæ‰©å¼  + æµåŠ¨æ€§å®½æ¾ â†’ sentiment_score = 0.5 ~ 0.8\n"
                    "- ç»æµè¡°é€€ + æµåŠ¨æ€§ç´§ç¼© â†’ sentiment_score = -0.8 ~ -0.5\n"
                    "- æ»èƒ€ï¼ˆä½å¢é•¿é«˜é€šèƒ€ï¼‰â†’ sentiment_score = -0.3 ~ 0.0\n"
                ),
                MessagesPlaceholder(variable_name="messages"),
            ]
        )
        
        # ç»‘å®šå·¥å…·
        tools = [index_toolkit.fetch_macro_data]
        chain = prompt | llm.bind_tools(tools)
        
        # è°ƒç”¨ LLM
        result = chain.invoke({
            "messages": state["messages"],
            "index_code": index_code,
            "current_date": current_date
        })
        
        logger.info(f"ğŸŒ [å®è§‚åˆ†æå¸ˆ] LLM è¿”å›æ¶ˆæ¯ç±»å‹: {type(result).__name__}")
        
        # å°è¯•æå– JSON æ ¼å¼çš„æŠ¥å‘Š
        report = ""
        if hasattr(result, 'content') and result.content:
            content = result.content
            # å°è¯•æå– JSON
            if '{' in content and '}' in content:
                try:
                    start = content.index('{')
                    end = content.rindex('}') + 1
                    json_str = content[start:end]
                    # éªŒè¯ JSON æ ¼å¼
                    json.loads(json_str)
                    report = json_str
                    logger.info(f"âœ… [å®è§‚åˆ†æå¸ˆ] æˆåŠŸæå–JSONæŠ¥å‘Š: {report[:100]}...")
                except:
                    logger.warning("âš ï¸ [å®è§‚åˆ†æå¸ˆ] JSONæå–å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹å†…å®¹")
                    report = content
        
        return {
            "messages": [result],
            "macro_report": report or "",
            "macro_tool_call_count": tool_call_count + 1
        }
    
    return macro_analyst_node
```

---

### 3.2 Policy Analystï¼ˆæ”¿ç­–åˆ†æå¸ˆï¼‰

**æ–‡ä»¶è·¯å¾„**: `tradingagents/agents/analysts/policy_analyst.py`

#### 3.2.1 åˆ†ææ€è·¯

**æ ¸å¿ƒèŒè´£**: åˆ†æè´§å¸æ”¿ç­–ã€è´¢æ”¿æ”¿ç­–å’Œäº§ä¸šæ”¿ç­–å¯¹å¸‚åœºçš„å½±å“

**åˆ†æç»´åº¦**:
1. **è´§å¸æ”¿ç­–è¯†åˆ«**:
   - é™æ¯/é™å‡† â†’ å®½æ¾ä¿¡å· â†’ åˆ©å¥½è‚¡å¸‚
   - åŠ æ¯/æå‡† â†’ ç´§ç¼©ä¿¡å· â†’ åˆ©ç©ºè‚¡å¸‚
   - MLF/OMO æ“ä½œ â†’ çŸ­æœŸæµåŠ¨æ€§è°ƒèŠ‚

2. **è´¢æ”¿æ”¿ç­–è¯„ä¼°**:
   - å‡ç¨é™è´¹ â†’ ä¼ä¸šç›ˆåˆ©æ”¹å–„ â†’ æ­£é¢
   - åŸºå»ºæŠ•èµ„ â†’ å‘¨æœŸæ¿å—å—ç›Š â†’ æ­£é¢
   - èµ¤å­—ç‡è°ƒæ•´ â†’ è´¢æ”¿ç©ºé—´è¯„ä¼°

3. **äº§ä¸šæ”¿ç­–æ˜ å°„**:
   - è‡ªä¸»å¯æ§ï¼ˆåŠå¯¼ä½“ã€å›½é˜²å†›å·¥ï¼‰â†’ é«˜æ”¿ç­–ç¡®å®šæ€§
   - æ–°èƒ½æºï¼ˆå…‰ä¼ã€å‚¨èƒ½ã€æ–°èƒ½æºè½¦ï¼‰â†’ é•¿æœŸæ‰¶æŒ
   - æˆ¿åœ°äº§è°ƒæ§ â†’ åœ°äº§é“¾å½±å“

4. **æƒ…ç»ªè¯„åˆ†é€»è¾‘**:
   - å¤šé¡¹å®½æ¾æ”¿ç­–å åŠ  â†’ `sentiment_score = 0.6 ~ 0.9`
   - æ”¿ç­–çœŸç©ºæœŸ â†’ `sentiment_score = -0.1 ~ 0.1`
   - ç´§ç¼©æ”¿ç­–å‡ºå° â†’ `sentiment_score = -0.7 ~ -0.3`

**æ•°æ®æ¥æº**: 
- å·¥å…·ï¼š`fetch_policy_news(lookback_days=30)`
- æ•°æ®æºï¼šæ–°é—»è”æ’­ã€ç™¾åº¦è´¢ç»æ–°é—»

#### 3.2.2 å®ç°ä»£ç 

```python
# tradingagents/agents/analysts/policy_analyst.py

from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder
import json

from tradingagents.utils.logging_init import get_logger
logger = get_logger("agents")

def create_policy_analyst(llm, index_toolkit):
    """
    åˆ›å»ºæ”¿ç­–åˆ†æå¸ˆèŠ‚ç‚¹
    
    Args:
        llm: è¯­è¨€æ¨¡å‹å®ä¾‹
        index_toolkit: æŒ‡æ•°åˆ†æå·¥å…·é›†
    
    Returns:
        æ”¿ç­–åˆ†æå¸ˆèŠ‚ç‚¹å‡½æ•°
    """
    
    def policy_analyst_node(state):
        logger.info("ğŸ“œ [æ”¿ç­–åˆ†æå¸ˆ] èŠ‚ç‚¹å¼€å§‹")
        
        # å·¥å…·è°ƒç”¨è®¡æ•°å™¨
        tool_call_count = state.get("policy_tool_call_count", 0)
        max_tool_calls = 3
        logger.info(f"ğŸ”§ [å·¥å…·è°ƒç”¨] å½“å‰æ¬¡æ•°: {tool_call_count}/{max_tool_calls}")
        
        # é™çº§æ–¹æ¡ˆ
        if tool_call_count >= max_tool_calls:
            logger.warning("âš ï¸ [æ”¿ç­–åˆ†æå¸ˆ] è¾¾åˆ°æœ€å¤§å·¥å…·è°ƒç”¨æ¬¡æ•°ï¼Œä½¿ç”¨é™çº§æ–¹æ¡ˆ")
            fallback_report = json.dumps({
                "monetary_policy": "ä¸­æ€§",
                "fiscal_policy": "ç¨³å¥",
                "industry_policy": "æœªçŸ¥",
                "key_events": [],
                "market_impact": "ä¸­æ€§",
                "analysis_summary": "æ”¿ç­–æ–°é—»è·å–å¤±è´¥ï¼Œä¾èµ–LLMå†…éƒ¨çŸ¥è¯†åº“",
                "confidence": 0.3,
                "sentiment_score": 0.0
            }, ensure_ascii=False)
            return {
                "messages": [],
                "policy_report": fallback_report,
                "policy_tool_call_count": tool_call_count + 1
            }
        
        current_date = state["trade_date"]
        
        # æ„å»º Prompt
        prompt = ChatPromptTemplate.from_messages(
            [
                (
                    "system",
                    "ä½ æ˜¯ä¸€ä½èµ„æ·±çš„æ”¿ç­–åˆ†æå¸ˆï¼Œä¸“æ³¨äºè§£è¯»è´§å¸æ”¿ç­–ã€è´¢æ”¿æ”¿ç­–å’Œäº§ä¸šæ”¿ç­–å¯¹è‚¡å¸‚çš„å½±å“ã€‚\n"
                    "\n"
                    "ğŸ“Š **ä½ çš„ä»»åŠ¡ï¼š**\n"
                    "1. è°ƒç”¨å·¥å…·è·å–è¿‘æœŸï¼ˆ30å¤©ï¼‰çš„æ”¿ç­–æ–°é—»\n"
                    "2. è¯†åˆ«è´§å¸æ”¿ç­–åŸºè°ƒï¼ˆå®½æ¾/ä¸­æ€§/ç´§ç¼©ï¼‰\n"
                    "3. è¯†åˆ«è´¢æ”¿æ”¿ç­–åŸºè°ƒï¼ˆç§¯æ/ç¨³å¥/ç´§ç¼©ï¼‰\n"
                    "4. è¯†åˆ«äº§ä¸šæ”¿ç­–é‡ç‚¹ï¼ˆå¦‚ï¼šè‡ªä¸»å¯æ§ã€æ–°èƒ½æºã€æˆ¿åœ°äº§è°ƒæ§ï¼‰\n"
                    "5. åˆ¤æ–­æ”¿ç­–å¯¹å¸‚åœºçš„å½±å“ï¼ˆæ­£é¢/ä¸­æ€§/è´Ÿé¢ï¼‰\n"
                    "6. ç»™å‡ºæƒ…ç»ªè¯„åˆ†ï¼ˆ-1.0 æåº¦çœ‹ç©ºï¼Œ0.0 ä¸­æ€§ï¼Œ1.0 æåº¦çœ‹å¤šï¼‰\n"
                    "\n"
                    "ğŸ“‹ **åˆ†ææ—¥æœŸï¼š** {current_date}\n"
                    "\n"
                    "âš ï¸ **é‡è¦ï¼š**\n"
                    "- å¿…é¡»å…ˆè°ƒç”¨ fetch_policy_news å·¥å…·è·å–æ–°é—»\n"
                    "- è·å–æ–°é—»åï¼ŒæŒ‰ä»¥ä¸‹JSONæ ¼å¼è¾“å‡ºåˆ†æç»“æœï¼š\n"
                    "{{\n"
                    '  "monetary_policy": "å®½æ¾/ä¸­æ€§/ç´§ç¼©",\n'
                    '  "fiscal_policy": "ç§¯æ/ç¨³å¥/ç´§ç¼©",\n'
                    '  "industry_policy": "è‡ªä¸»å¯æ§ã€æ–°èƒ½æºç­‰",\n'
                    '  "key_events": ["é™å‡†0.5%", "å‡ç¨æ”¿ç­–"],\n'
                    '  "market_impact": "æ­£é¢/ä¸­æ€§/è´Ÿé¢",\n'
                    '  "analysis_summary": "å¤®è¡Œé™å‡†è¡¨æ˜æµåŠ¨æ€§æ”¯æŒ...",\n'
                    '  "confidence": 0.9,\n'
                    '  "sentiment_score": 0.7\n'
                    "}}\n"
                    "\n"
                    "ğŸ’¡ **è¯„åˆ†æŒ‡å—ï¼š**\n"
                    "- å¤šé¡¹å®½æ¾æ”¿ç­–å åŠ  â†’ sentiment_score = 0.6 ~ 0.9\n"
                    "- æ”¿ç­–çœŸç©ºæœŸ â†’ sentiment_score = -0.1 ~ 0.1\n"
                    "- ç´§ç¼©æ”¿ç­–å‡ºå° â†’ sentiment_score = -0.7 ~ -0.3\n"
                ),
                MessagesPlaceholder(variable_name="messages"),
            ]
        )
        
        # ç»‘å®šå·¥å…·
        tools = [index_toolkit.fetch_policy_news]
        chain = prompt | llm.bind_tools(tools)
        
        # è°ƒç”¨ LLM
        result = chain.invoke({
            "messages": state["messages"],
            "current_date": current_date
        })
        
        logger.info(f"ğŸ“œ [æ”¿ç­–åˆ†æå¸ˆ] LLM è¿”å›æ¶ˆæ¯ç±»å‹: {type(result).__name__}")
        
        # æå– JSON æŠ¥å‘Š
        report = ""
        if hasattr(result, 'content') and result.content:
            content = result.content
            if '{' in content and '}' in content:
                try:
                    start = content.index('{')
                    end = content.rindex('}') + 1
                    json_str = content[start:end]
                    json.loads(json_str)
                    report = json_str
                    logger.info(f"âœ… [æ”¿ç­–åˆ†æå¸ˆ] æˆåŠŸæå–JSONæŠ¥å‘Š")
                except:
                    logger.warning("âš ï¸ [æ”¿ç­–åˆ†æå¸ˆ] JSONæå–å¤±è´¥")
                    report = content
        
        return {
            "messages": [result],
            "policy_report": report or "",
            "policy_tool_call_count": tool_call_count + 1
        }
    
    return policy_analyst_node
```

---

### 3.3 Sector Analystï¼ˆæ¿å—è½®åŠ¨åˆ†æå¸ˆï¼‰

**æ–‡ä»¶è·¯å¾„**: `tradingagents/agents/analysts/sector_analyst.py`

#### 3.3.1 åˆ†ææ€è·¯

**æ ¸å¿ƒèŒè´£**: åˆ†ææ¿å—èµ„é‡‘æµå‘å’Œè½®åŠ¨è¶‹åŠ¿ï¼Œè¯†åˆ«å¸‚åœºçƒ­ç‚¹

**åˆ†æç»´åº¦**:
1. **é¢†æ¶¨æ¿å—è¯†åˆ«**:
   - Top 5 æ¶¨å¹…æ¿å— â†’ èµ„é‡‘æµå…¥æ–¹å‘
   - ä¸»åŠ›èµ„é‡‘å‡€æµå…¥ â†’ æœºæ„è¡Œä¸º
   - æˆäº¤é‡æ”¾å¤§ â†’ å¸‚åœºå…³æ³¨åº¦

2. **è½®åŠ¨ç‰¹å¾åˆ¤æ–­**:
   - æˆé•¿ â†’ ä»·å€¼ â†’ å¤§ç›˜è‚¡ä¸»å¯¼ï¼Œé£é™©åå¥½é™ä½
   - å‘¨æœŸ â†’ æ¶ˆè´¹ â†’ ç»æµé¢„æœŸå˜åŒ–
   - å¤§ç›˜ â†’ å°ç›˜ â†’ å¸‚åœºæƒ…ç»ªè½¬æ¢

3. **çƒ­ç‚¹ä¸»é¢˜æŒ–æ˜**:
   - ç»“åˆæ”¿ç­–æŠ¥å‘Šï¼ˆæ¥è‡ª Policy Analystï¼‰
   - è¯†åˆ«å—ç›Šæ¿å—ï¼ˆå¦‚æ”¿ç­–æåŠ "è‡ªä¸»å¯æ§" â†’ åŠå¯¼ä½“æ¿å—ï¼‰
   - äº¤å‰éªŒè¯ï¼ˆæ”¿ç­–+èµ„é‡‘æµå‘ï¼‰

4. **æƒ…ç»ªè¯„åˆ†é€»è¾‘**:
   - æ™®æ¶¨ï¼ˆå¤šæ¿å—ä¸Šæ¶¨ï¼‰â†’ `sentiment_score = 0.5 ~ 0.8`
   - ç»“æ„æ€§è¡Œæƒ…ï¼ˆä¸ªåˆ«æ¿å—å¼ºåŠ¿ï¼‰â†’ `sentiment_score = 0.2 ~ 0.5`
   - æ™®è·Œ â†’ `sentiment_score = -0.8 ~ -0.5`

**æ•°æ®æ¥æº**: 
- å·¥å…·ï¼š`fetch_sector_rotation(trade_date)`
- æ•°æ®æºï¼šä¸œæ–¹è´¢å¯Œæ¿å—èµ„é‡‘æµ
- è¾…åŠ©ï¼š`state['policy_report']`ï¼ˆä¸Šæ¸¸æŠ¥å‘Šï¼‰

#### 3.3.2 å®ç°ä»£ç 

```python
# tradingagents/agents/analysts/sector_analyst.py

from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder
import json

from tradingagents.utils.logging_init import get_logger
logger = get_logger("agents")

def create_sector_analyst(llm, index_toolkit):
    """
    åˆ›å»ºæ¿å—è½®åŠ¨åˆ†æå¸ˆèŠ‚ç‚¹
    
    Args:
        llm: è¯­è¨€æ¨¡å‹å®ä¾‹
        index_toolkit: æŒ‡æ•°åˆ†æå·¥å…·é›†
    
    Returns:
        æ¿å—åˆ†æå¸ˆèŠ‚ç‚¹å‡½æ•°
    """
    
    def sector_analyst_node(state):
        logger.info("ğŸ”„ [æ¿å—åˆ†æå¸ˆ] èŠ‚ç‚¹å¼€å§‹")
        
        # å·¥å…·è°ƒç”¨è®¡æ•°å™¨
        tool_call_count = state.get("sector_tool_call_count", 0)
        max_tool_calls = 3
        logger.info(f"ğŸ”§ [å·¥å…·è°ƒç”¨] å½“å‰æ¬¡æ•°: {tool_call_count}/{max_tool_calls}")
        
        # é™çº§æ–¹æ¡ˆ
        if tool_call_count >= max_tool_calls:
            logger.warning("âš ï¸ [æ¿å—åˆ†æå¸ˆ] è¾¾åˆ°æœ€å¤§å·¥å…·è°ƒç”¨æ¬¡æ•°ï¼Œä½¿ç”¨é™çº§æ–¹æ¡ˆ")
            fallback_report = json.dumps({
                "top_sectors": [],
                "bottom_sectors": [],
                "rotation_trend": "æœªçŸ¥",
                "hot_themes": [],
                "analysis_summary": "æ¿å—æ•°æ®è·å–å¤±è´¥",
                "confidence": 0.3,
                "sentiment_score": 0.0
            }, ensure_ascii=False)
            return {
                "messages": [],
                "sector_report": fallback_report,
                "sector_tool_call_count": tool_call_count + 1
            }
        
        current_date = state["trade_date"]
        policy_report = state.get("policy_report", "")
        
        # è§£ææ”¿ç­–æŠ¥å‘Šä¸­çš„äº§ä¸šæ”¿ç­–
        industry_policy_hint = ""
        if policy_report:
            try:
                policy_data = json.loads(policy_report)
                industry_policy_hint = policy_data.get("industry_policy", "")
                logger.info(f"ğŸ“œ [æ¿å—åˆ†æå¸ˆ] è·å–åˆ°äº§ä¸šæ”¿ç­–: {industry_policy_hint}")
            except:
                logger.warning("âš ï¸ [æ¿å—åˆ†æå¸ˆ] æ— æ³•è§£ææ”¿ç­–æŠ¥å‘Š")
        
        # æ„å»º Prompt
        prompt = ChatPromptTemplate.from_messages(
            [
                (
                    "system",
                    "ä½ æ˜¯ä¸€ä½èµ„æ·±çš„æ¿å—è½®åŠ¨åˆ†æå¸ˆï¼Œä¸“æ³¨äºé€šè¿‡èµ„é‡‘æµå‘å’Œæ¶¨è·Œå¹…è¯†åˆ«å¸‚åœºçƒ­ç‚¹ã€‚\n"
                    "\n"
                    "ğŸ“Š **ä½ çš„ä»»åŠ¡ï¼š**\n"
                    "1. è°ƒç”¨å·¥å…·è·å–æ¿å—èµ„é‡‘æµå‘å’Œæ¶¨è·Œå¹…æ’å\n"
                    "2. è¯†åˆ«é¢†æ¶¨æ¿å—ï¼ˆTop 5ï¼‰å’Œé¢†è·Œæ¿å—ï¼ˆBottom 5ï¼‰\n"
                    "3. åˆ†ææ¿å—è½®åŠ¨ç‰¹å¾ï¼ˆå¦‚ï¼šæˆé•¿â†’ä»·å€¼ã€å‘¨æœŸâ†’æ¶ˆè´¹ï¼‰\n"
                    "4. ç»“åˆäº§ä¸šæ”¿ç­–ï¼Œè¯†åˆ«çƒ­ç‚¹ä¸»é¢˜\n"
                    "5. ç»™å‡ºæƒ…ç»ªè¯„åˆ†ï¼ˆ-1.0 æåº¦çœ‹ç©ºï¼Œ0.0 ä¸­æ€§ï¼Œ1.0 æåº¦çœ‹å¤šï¼‰\n"
                    "\n"
                    "ğŸ“‹ **åˆ†ææ—¥æœŸï¼š** {current_date}\n"
                    "ğŸ“‹ **äº§ä¸šæ”¿ç­–å‚è€ƒï¼š** {industry_policy_hint}\n"
                    "\n"
                    "âš ï¸ **é‡è¦ï¼š**\n"
                    "- å¿…é¡»å…ˆè°ƒç”¨ fetch_sector_rotation å·¥å…·è·å–æ•°æ®\n"
                    "- è·å–æ•°æ®åï¼ŒæŒ‰ä»¥ä¸‹JSONæ ¼å¼è¾“å‡ºåˆ†æç»“æœï¼š\n"
                    "{{\n"
                    '  "top_sectors": [{{"name": "åŠå¯¼ä½“", "change_pct": 3.5}}],\n'
                    '  "bottom_sectors": [{{"name": "æˆ¿åœ°äº§", "change_pct": -1.2}}],\n'
                    '  "rotation_trend": "æˆé•¿æ¿å—è¡¨ç°ä¼˜äºä»·å€¼æ¿å—",\n'
                    '  "hot_themes": ["äººå·¥æ™ºèƒ½", "ç®—åŠ›"],\n'
                    '  "analysis_summary": "ç§‘æŠ€æ¿å—èµ„é‡‘æµå…¥å¼ºåŠ²...",\n'
                    '  "confidence": 0.85,\n'
                    '  "sentiment_score": 0.6\n'
                    "}}\n"
                    "\n"
                    "ğŸ’¡ **è¯„åˆ†æŒ‡å—ï¼š**\n"
                    "- æ™®æ¶¨ï¼ˆå¤šæ¿å—ä¸Šæ¶¨ï¼‰â†’ sentiment_score = 0.5 ~ 0.8\n"
                    "- ç»“æ„æ€§è¡Œæƒ…ï¼ˆä¸ªåˆ«æ¿å—å¼ºåŠ¿ï¼‰â†’ sentiment_score = 0.2 ~ 0.5\n"
                    "- æ™®è·Œ â†’ sentiment_score = -0.8 ~ -0.5\n"
                    "\n"
                    "ğŸ’¡ **çƒ­ç‚¹ä¸»é¢˜è¯†åˆ«æç¤ºï¼š**\n"
                    "- å¦‚æœäº§ä¸šæ”¿ç­–æåˆ° 'è‡ªä¸»å¯æ§'ï¼Œå…³æ³¨ï¼šåŠå¯¼ä½“ã€å›½é˜²å†›å·¥\n"
                    "- å¦‚æœäº§ä¸šæ”¿ç­–æåˆ° 'æ–°èƒ½æº'ï¼Œå…³æ³¨ï¼šå…‰ä¼ã€å‚¨èƒ½ã€æ–°èƒ½æºè½¦\n"
                    "- å¦‚æœè´§å¸æ”¿ç­–å®½æ¾ï¼Œå…³æ³¨ï¼šåœ°äº§é“¾ã€åˆ¸å•†\n"
                ),
                MessagesPlaceholder(variable_name="messages"),
            ]
        )
        
        # ç»‘å®šå·¥å…·
        tools = [index_toolkit.fetch_sector_rotation]
        chain = prompt | llm.bind_tools(tools)
        
        # è°ƒç”¨ LLM
        result = chain.invoke({
            "messages": state["messages"],
            "current_date": current_date,
            "industry_policy_hint": industry_policy_hint or "æ— "
        })
        
        logger.info(f"ğŸ”„ [æ¿å—åˆ†æå¸ˆ] LLM è¿”å›æ¶ˆæ¯ç±»å‹: {type(result).__name__}")
        
        # æå– JSON æŠ¥å‘Š
        report = ""
        if hasattr(result, 'content') and result.content:
            content = result.content
            if '{' in content and '}' in content:
                try:
                    start = content.index('{')
                    end = content.rindex('}') + 1
                    json_str = content[start:end]
                    json.loads(json_str)
                    report = json_str
                    logger.info(f"âœ… [æ¿å—åˆ†æå¸ˆ] æˆåŠŸæå–JSONæŠ¥å‘Š")
                except:
                    logger.warning("âš ï¸ [æ¿å—åˆ†æå¸ˆ] JSONæå–å¤±è´¥")
                    report = content
        
        return {
            "messages": [result],
            "sector_report": report or "",
            "sector_tool_call_count": tool_call_count + 1
        }
    
    return sector_analyst_node
```

---

### 3.4 Strategy Advisorï¼ˆç­–ç•¥é¡¾é—®ï¼‰

**æ–‡ä»¶è·¯å¾„**: `tradingagents/agents/analysts/strategy_advisor.py`

#### 3.4.1 åˆ†ææ€è·¯

**æ ¸å¿ƒèŒè´£**: ç»¼åˆå®è§‚ã€æ”¿ç­–ã€æ¿å—ä¸‰ä¸ªç»´åº¦çš„åˆ†æï¼Œç»™å‡ºæœ€ç»ˆæŠ•èµ„ç­–ç•¥

**åˆ†æç»´åº¦**:
1. **ç»¼åˆæƒ…ç»ªè®¡ç®—**ï¼ˆåŠ æƒå¹³å‡ï¼‰:
   ```python
   # æƒé‡åˆ†é…ï¼šå®è§‚ 30%ã€æ”¿ç­– 40%ã€æ¿å— 30%
   final_sentiment = (
       macro_sentiment * 0.3 * macro_confidence +
       policy_sentiment * 0.4 * policy_confidence +
       sector_sentiment * 0.3 * sector_confidence
   ) / (macro_confidence * 0.3 + policy_confidence * 0.4 + sector_confidence * 0.3)
   ```

2. **ä»“ä½å»ºè®®æ˜ å°„**:
   - `final_sentiment > 0.5` â†’ `recommended_position = 0.7 ~ 1.0`ï¼ˆæ¿€è¿›ï¼‰
   - `0.2 < final_sentiment <= 0.5` â†’ `recommended_position = 0.5 ~ 0.7`ï¼ˆç¨³å¥ï¼‰
   - `-0.2 < final_sentiment <= 0.2` â†’ `recommended_position = 0.3 ~ 0.5`ï¼ˆè°¨æ…ï¼‰
   - `final_sentiment <= -0.2` â†’ `recommended_position = 0.0 ~ 0.3`ï¼ˆé˜²å¾¡ï¼‰

3. **é£é™©è¯†åˆ«**:
   - å®è§‚ï¼šç»æµè¡°é€€ã€é€šèƒ€å¤±æ§
   - æ”¿ç­–ï¼šæ”¿ç­–æ”¶ç´§ã€ç›‘ç®¡åŠ å¼º
   - æ¿å—ï¼šèµ„é‡‘æ’¤ç¦»ã€çƒ­ç‚¹æ¶ˆé€€

4. **æœºä¼šæ¿å—æ¨è**:
   - ç›´æ¥ä» Sector Analyst çš„ `hot_themes` æå–
   - äº¤å‰éªŒè¯æ”¿ç­–æ”¯æŒæ–¹å‘

**æ•°æ®æ¥æº**: 
- **ä¸éœ€è¦è°ƒç”¨å·¥å…·**ï¼Œç›´æ¥è¯»å– `state` ä¸­çš„ä¸Šæ¸¸æŠ¥å‘Šï¼š
  - `state['macro_report']`
  - `state['policy_report']`
  - `state['sector_report']`

#### 3.4.2 å®ç°ä»£ç 

```python
# tradingagents/agents/analysts/strategy_advisor.py

from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder
import json

from tradingagents.utils.logging_init import get_logger
logger = get_logger("agents")

def create_strategy_advisor(llm):
    """
    åˆ›å»ºç­–ç•¥é¡¾é—®èŠ‚ç‚¹ï¼ˆæœ€åçš„æ±‡æ€»èŠ‚ç‚¹ï¼‰
    
    Args:
        llm: è¯­è¨€æ¨¡å‹å®ä¾‹
    
    Returns:
        ç­–ç•¥é¡¾é—®èŠ‚ç‚¹å‡½æ•°
    """
    
    def strategy_advisor_node(state):
        logger.info("ğŸ¯ [ç­–ç•¥é¡¾é—®] èŠ‚ç‚¹å¼€å§‹")
        
        # è·å–ä¸Šæ¸¸æŠ¥å‘Š
        macro_report = state.get("macro_report", "")
        policy_report = state.get("policy_report", "")
        sector_report = state.get("sector_report", "")
        
        logger.info(f"ğŸ“Š [ç­–ç•¥é¡¾é—®] è·å–åˆ°ä¸Šæ¸¸æŠ¥å‘Š:")
        logger.info(f"  - å®è§‚æŠ¥å‘Š: {len(macro_report)} å­—ç¬¦")
        logger.info(f"  - æ”¿ç­–æŠ¥å‘Š: {len(policy_report)} å­—ç¬¦")
        logger.info(f"  - æ¿å—æŠ¥å‘Š: {len(sector_report)} å­—ç¬¦")
        
        # å¦‚æœä»»ä½•ä¸€ä¸ªæŠ¥å‘Šç¼ºå¤±ï¼Œè¿”å›é™çº§ç»“æœ
        if not (macro_report and policy_report and sector_report):
            logger.warning("âš ï¸ [ç­–ç•¥é¡¾é—®] ä¸Šæ¸¸æŠ¥å‘Šä¸å®Œæ•´ï¼Œä½¿ç”¨é™çº§æ–¹æ¡ˆ")
            fallback_report = json.dumps({
                "market_outlook": "ä¸­æ€§",
                "recommended_position": 0.5,
                "key_risks": ["æ•°æ®ä¸å®Œæ•´"],
                "opportunity_sectors": [],
                "rationale": "ç”±äºä¸Šæ¸¸åˆ†ææŠ¥å‘Šä¸å®Œæ•´ï¼Œæ— æ³•ç»™å‡ºæ˜ç¡®å»ºè®®",
                "final_sentiment_score": 0.0,
                "confidence": 0.3
            }, ensure_ascii=False)
            return {
                "messages": [],
                "strategy_report": fallback_report
            }
        
        current_date = state["trade_date"]
        
        # æ„å»º Promptï¼ˆä¸éœ€è¦å·¥å…·ï¼Œç›´æ¥åˆ†æï¼‰
        prompt = ChatPromptTemplate.from_messages(
            [
                (
                    "system",
                    "ä½ æ˜¯ä¸€ä½é¦–å¸­æŠ•èµ„ç­–ç•¥é¡¾é—®ï¼Œè´Ÿè´£ç»¼åˆå®è§‚ã€æ”¿ç­–ã€æ¿å—ä¸‰ä¸ªç»´åº¦çš„åˆ†æï¼Œåˆ¶å®šæœ€ç»ˆçš„æŠ•èµ„ç­–ç•¥ã€‚\n"
                    "\n"
                    "ğŸ“Š **ä½ çš„ä»»åŠ¡ï¼š**\n"
                    "1. è§£æå®è§‚ã€æ”¿ç­–ã€æ¿å—åˆ†æå¸ˆçš„æŠ¥å‘Šï¼ˆJSONæ ¼å¼ï¼‰\n"
                    "2. è®¡ç®—åŠ æƒæƒ…ç»ªå¾—åˆ†ï¼š\n"
                    "   - å®è§‚æƒé‡ 30%\n"
                    "   - æ”¿ç­–æƒé‡ 40%ï¼ˆæ”¿ç­–å¯¹Aè‚¡å½±å“æœ€å¤§ï¼‰\n"
                    "   - æ¿å—æƒé‡ 30%\n"
                    "   - å…¬å¼: final_sentiment = (macro_sent*0.3*macro_conf + policy_sent*0.4*policy_conf + sector_sent*0.3*sector_conf) / (0.3*macro_conf + 0.4*policy_conf + 0.3*sector_conf)\n"
                    "3. æ ¹æ®åŠ æƒæƒ…ç»ªç»™å‡ºä»“ä½å»ºè®®ï¼š\n"
                    "   - æƒ…ç»ª > 0.5 â†’ ä»“ä½ 0.7~1.0ï¼ˆæ¿€è¿›ï¼‰\n"
                    "   - æƒ…ç»ª 0.2~0.5 â†’ ä»“ä½ 0.5~0.7ï¼ˆç¨³å¥ï¼‰\n"
                    "   - æƒ…ç»ª -0.2~0.2 â†’ ä»“ä½ 0.3~0.5ï¼ˆè°¨æ…ï¼‰\n"
                    "   - æƒ…ç»ª < -0.2 â†’ ä»“ä½ 0.0~0.3ï¼ˆé˜²å¾¡ï¼‰\n"
                    "4. è¯†åˆ«å…³é”®é£é™©ç‚¹\n"
                    "5. æ¨èæœºä¼šæ¿å—ï¼ˆä»æ¿å—æŠ¥å‘Šçš„hot_themesæå–ï¼‰\n"
                    "\n"
                    "ğŸ“‹ **è¾“å…¥æ•°æ®ï¼š**\n"
                    "\n"
                    "**å®è§‚æŠ¥å‘Šï¼š**\n"
                    "{macro_report}\n"
                    "\n"
                    "**æ”¿ç­–æŠ¥å‘Šï¼š**\n"
                    "{policy_report}\n"
                    "\n"
                    "**æ¿å—æŠ¥å‘Šï¼š**\n"
                    "{sector_report}\n"
                    "\n"
                    "ğŸ“‹ **åˆ†ææ—¥æœŸï¼š** {current_date}\n"
                    "\n"
                    "âš ï¸ **é‡è¦ï¼šç›´æ¥è¾“å‡ºJSONæ ¼å¼çš„ç­–ç•¥æŠ¥å‘Šï¼ˆä¸éœ€è¦è°ƒç”¨å·¥å…·ï¼‰ï¼š**\n"
                    "{{\n"
                    '  "market_outlook": "çœ‹å¤š/ä¸­æ€§/çœ‹ç©º",\n'
                    '  "recommended_position": 0.7,\n'
                    '  "key_risks": ["æ±‡ç‡æ³¢åŠ¨", "æ¶ˆè´¹ç–²è½¯"],\n'
                    '  "opportunity_sectors": ["ç§‘æŠ€", "é«˜è‚¡æ¯"],\n'
                    '  "rationale": "å®è§‚å¤„äºå¤è‹é˜¶æ®µï¼Œæ”¿ç­–ä¿æŒå®½æ¾ï¼Œç§‘æŠ€æ¿å—èµ„é‡‘æµå…¥å¼ºåŠ²...",\n'
                    '  "final_sentiment_score": 0.55,\n'
                    '  "confidence": 0.85\n'
                    "}}\n"
                ),
                MessagesPlaceholder(variable_name="messages"),
            ]
        )
        
        # ä¸ç»‘å®šå·¥å…·ï¼Œç›´æ¥è°ƒç”¨ LLM
        chain = prompt | llm
        
        # è°ƒç”¨ LLM
        result = chain.invoke({
            "messages": state["messages"],
            "macro_report": macro_report,
            "policy_report": policy_report,
            "sector_report": sector_report,
            "current_date": current_date
        })
        
        logger.info(f"ğŸ¯ [ç­–ç•¥é¡¾é—®] LLM è¿”å›æ¶ˆæ¯ç±»å‹: {type(result).__name__}")
        
        # æå– JSON æŠ¥å‘Š
        report = ""
        if hasattr(result, 'content') and result.content:
            content = result.content
            if '{' in content and '}' in content:
                try:
                    start = content.index('{')
                    end = content.rindex('}') + 1
                    json_str = content[start:end]
                    json.loads(json_str)
                    report = json_str
                    logger.info(f"âœ… [ç­–ç•¥é¡¾é—®] æˆåŠŸæå–JSONæŠ¥å‘Š")
                except:
                    logger.warning("âš ï¸ [ç­–ç•¥é¡¾é—®] JSONæå–å¤±è´¥")
                    report = content
        
        return {
            "messages": [result],
            "strategy_report": report or ""
        }
    
    return strategy_advisor_node
```
## 4. å›¾æ„å»ºä¸è·¯ç”±é€»è¾‘

### 4.1 è·¯ç”±é€»è¾‘æ‰©å±• (`tradingagents/graph/conditional_logic.py`)

åœ¨ `ConditionalLogic` ç±»ä¸­æ·»åŠ æŒ‡æ•°åˆ†æçš„è·¯ç”±æ–¹æ³•ã€‚

```python
# tradingagents/graph/conditional_logic.py

class ConditionalLogic:
    """Handles conditional logic for determining graph flow."""

    def __init__(self, max_debate_rounds=1, max_risk_discuss_rounds=1):
        """Initialize with configuration parameters."""
        self.max_debate_rounds = max_debate_rounds
        self.max_risk_discuss_rounds = max_risk_discuss_rounds
    
    # ... ç°æœ‰çš„ should_continue_marketã€should_continue_social ç­‰æ–¹æ³•ä¿æŒä¸å˜ ...
    
    # ========== æ–°å¢ï¼šæŒ‡æ•°åˆ†æè·¯ç”±æ–¹æ³• ==========
    
    def should_continue_macro(self, state: AgentState):
        """Determine if macro analysis should continue."""
        from tradingagents.utils.logging_init import get_logger
        logger = get_logger("agents")
        
        messages = state["messages"]
        last_message = messages[-1]
        
        # å·¥å…·è°ƒç”¨è®¡æ•°å™¨
        tool_call_count = state.get("macro_tool_call_count", 0)
        max_tool_calls = 3
        
        # æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰å®è§‚åˆ†ææŠ¥å‘Š
        macro_report = state.get("macro_report", "")
        
        logger.info(f"ğŸ”€ [æ¡ä»¶åˆ¤æ–­] should_continue_macro")
        logger.info(f"ğŸ”€ [æ¡ä»¶åˆ¤æ–­] - æŠ¥å‘Šé•¿åº¦: {len(macro_report)}")
        logger.info(f"ğŸ”§ [æ­»å¾ªç¯ä¿®å¤] - å·¥å…·è°ƒç”¨æ¬¡æ•°: {tool_call_count}/{max_tool_calls}")
        
        # å¦‚æœè¾¾åˆ°æœ€å¤§å·¥å…·è°ƒç”¨æ¬¡æ•°ï¼Œå¼ºåˆ¶ç»“æŸ
        if tool_call_count >= max_tool_calls:
            logger.warning(f"ğŸ”§ [æ­»å¾ªç¯ä¿®å¤] è¾¾åˆ°æœ€å¤§å·¥å…·è°ƒç”¨æ¬¡æ•°ï¼Œå¼ºåˆ¶ç»“æŸ: Msg Clear Macro")
            return "Msg Clear Macro"
        
        # å¦‚æœå·²ç»æœ‰æŠ¥å‘Šå†…å®¹ï¼Œè¯´æ˜åˆ†æå·²å®Œæˆ
        if macro_report and len(macro_report) > 100:
            logger.info(f"ğŸ”€ [æ¡ä»¶åˆ¤æ–­] âœ… æŠ¥å‘Šå·²å®Œæˆï¼Œè¿”å›: Msg Clear Macro")
            return "Msg Clear Macro"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å·¥å…·è°ƒç”¨
        if hasattr(last_message, 'tool_calls') and last_message.tool_calls:
            logger.info(f"ğŸ”€ [æ¡ä»¶åˆ¤æ–­] ğŸ”§ æ£€æµ‹åˆ°tool_callsï¼Œè¿”å›: tools_macro")
            return "tools_macro"
        
        logger.info(f"ğŸ”€ [æ¡ä»¶åˆ¤æ–­] âœ… æ— tool_callsï¼Œè¿”å›: Msg Clear Macro")
        return "Msg Clear Macro"
    
    def should_continue_policy(self, state: AgentState):
        """Determine if policy analysis should continue."""
        from tradingagents.utils.logging_init import get_logger
        logger = get_logger("agents")
        
        messages = state["messages"]
        last_message = messages[-1]
        
        tool_call_count = state.get("policy_tool_call_count", 0)
        max_tool_calls = 3
        policy_report = state.get("policy_report", "")
        
        logger.info(f"ğŸ”€ [æ¡ä»¶åˆ¤æ–­] should_continue_policy")
        logger.info(f"ğŸ”€ [æ¡ä»¶åˆ¤æ–­] - æŠ¥å‘Šé•¿åº¦: {len(policy_report)}")
        logger.info(f"ğŸ”§ [æ­»å¾ªç¯ä¿®å¤] - å·¥å…·è°ƒç”¨æ¬¡æ•°: {tool_call_count}/{max_tool_calls}")
        
        if tool_call_count >= max_tool_calls:
            logger.warning(f"ğŸ”§ [æ­»å¾ªç¯ä¿®å¤] è¾¾åˆ°æœ€å¤§å·¥å…·è°ƒç”¨æ¬¡æ•°ï¼Œå¼ºåˆ¶ç»“æŸ: Msg Clear Policy")
            return "Msg Clear Policy"
        
        if policy_report and len(policy_report) > 100:
            logger.info(f"ğŸ”€ [æ¡ä»¶åˆ¤æ–­] âœ… æŠ¥å‘Šå·²å®Œæˆï¼Œè¿”å›: Msg Clear Policy")
            return "Msg Clear Policy"
        
        if hasattr(last_message, 'tool_calls') and last_message.tool_calls:
            logger.info(f"ğŸ”€ [æ¡ä»¶åˆ¤æ–­] ğŸ”§ æ£€æµ‹åˆ°tool_callsï¼Œè¿”å›: tools_policy")
            return "tools_policy"
        
        logger.info(f"ğŸ”€ [æ¡ä»¶åˆ¤æ–­] âœ… æ— tool_callsï¼Œè¿”å›: Msg Clear Policy")
        return "Msg Clear Policy"
    
    def should_continue_sector(self, state: AgentState):
        """Determine if sector analysis should continue."""
        from tradingagents.utils.logging_init import get_logger
        logger = get_logger("agents")
        
        messages = state["messages"]
        last_message = messages[-1]
        
        tool_call_count = state.get("sector_tool_call_count", 0)
        max_tool_calls = 3
        sector_report = state.get("sector_report", "")
        
        logger.info(f"ğŸ”€ [æ¡ä»¶åˆ¤æ–­] should_continue_sector")
        logger.info(f"ğŸ”€ [æ¡ä»¶åˆ¤æ–­] - æŠ¥å‘Šé•¿åº¦: {len(sector_report)}")
        logger.info(f"ğŸ”§ [æ­»å¾ªç¯ä¿®å¤] - å·¥å…·è°ƒç”¨æ¬¡æ•°: {tool_call_count}/{max_tool_calls}")
        
        if tool_call_count >= max_tool_calls:
            logger.warning(f"ğŸ”§ [æ­»å¾ªç¯ä¿®å¤] è¾¾åˆ°æœ€å¤§å·¥å…·è°ƒç”¨æ¬¡æ•°ï¼Œå¼ºåˆ¶ç»“æŸ: Msg Clear Sector")
            return "Msg Clear Sector"
        
        if sector_report and len(sector_report) > 100:
            logger.info(f"ğŸ”€ [æ¡ä»¶åˆ¤æ–­] âœ… æŠ¥å‘Šå·²å®Œæˆï¼Œè¿”å›: Msg Clear Sector")
            return "Msg Clear Sector"
        
        if hasattr(last_message, 'tool_calls') and last_message.tool_calls:
            logger.info(f"ğŸ”€ [æ¡ä»¶åˆ¤æ–­] ğŸ”§ æ£€æµ‹åˆ°tool_callsï¼Œè¿”å›: tools_sector")
            return "tools_sector"
        
        logger.info(f"ğŸ”€ [æ¡ä»¶åˆ¤æ–­] âœ… æ— tool_callsï¼Œè¿”å›: Msg Clear Sector")
        return "Msg Clear Sector"
    
    def should_continue_strategy(self, state: AgentState):
        """Determine if strategy advisory should continue."""
        from tradingagents.utils.logging_init import get_logger
        logger = get_logger("agents")
        
        messages = state["messages"]
        last_message = messages[-1]
        
        # Strategy Advisor ä¸è°ƒç”¨å·¥å…·ï¼Œæ‰€ä»¥é€šå¸¸ä¸€æ¬¡å°±å®Œæˆ
        strategy_report = state.get("strategy_report", "")
        
        logger.info(f"ğŸ”€ [æ¡ä»¶åˆ¤æ–­] should_continue_strategy")
        logger.info(f"ğŸ”€ [æ¡ä»¶åˆ¤æ–­] - æŠ¥å‘Šé•¿åº¦: {len(strategy_report)}")
        
        # å¦‚æœå·²ç»æœ‰æŠ¥å‘Šï¼Œç›´æ¥ç»“æŸ
        if strategy_report and len(strategy_report) > 100:
            logger.info(f"ğŸ”€ [æ¡ä»¶åˆ¤æ–­] âœ… æŠ¥å‘Šå·²å®Œæˆï¼Œè¿”å›: Msg Clear Strategy")
            return "Msg Clear Strategy"
        
        # Strategy Advisor ç†è®ºä¸Šä¸åº”è¯¥è°ƒç”¨å·¥å…·ï¼Œä½†ä¿ç•™åˆ¤æ–­é€»è¾‘
        if hasattr(last_message, 'tool_calls') and last_message.tool_calls:
            logger.warning(f"ğŸ”€ [æ¡ä»¶åˆ¤æ–­] âš ï¸ Strategy Advisor ä¸åº”è°ƒç”¨å·¥å…·ï¼Œä½†æ£€æµ‹åˆ°tool_calls")
            return "Msg Clear Strategy"  # å¼ºåˆ¶ç»“æŸ
        
        logger.info(f"ğŸ”€ [æ¡ä»¶åˆ¤æ–­] âœ… æ— tool_callsï¼Œè¿”å›: Msg Clear Strategy")
        return "Msg Clear Strategy"
```

---

### 4.2 å›¾æ„å»ºæ‰©å±• (`tradingagents/graph/setup.py`)

åœ¨ `GraphSetup.setup_graph()` æ–¹æ³•ä¸­æ·»åŠ æŒ‡æ•°åˆ†æèŠ‚ç‚¹çš„æ³¨å†Œå’Œè¿æ¥é€»è¾‘ã€‚

#### 4.2.1 ä¿®æ”¹è¦ç‚¹

**å…³é”®ä¿®æ”¹**:
1. åœ¨ `setup_graph()` æ–¹æ³•ä¸­æ·»åŠ  `analysis_type` å‚æ•°
2. æ ¹æ® `analysis_type` é€‰æ‹©ä¸åŒçš„åˆ†ææµç¨‹
3. æ·»åŠ è·¯ç”±èŠ‚ç‚¹åˆ¤æ–­ `is_index` å­—æ®µ

#### 4.2.2 å®ç°ä»£ç 

```python
# tradingagents/graph/setup.py

class GraphSetup:
    """Handles the setup and configuration of the agent graph."""
    
    # ... ç°æœ‰çš„ __init__ æ–¹æ³•ä¿æŒä¸å˜ ...
    
    def setup_graph(
        self, 
        selected_analysts=["market", "social", "news", "fundamentals"],
        analysis_type="stock"  # æ–°å¢å‚æ•°ï¼š"stock" æˆ– "index"
    ):
        """
        Set up and compile the agent workflow graph.

        Args:
            selected_analysts (list): List of analyst types to include (for stock analysis).
            analysis_type (str): "stock" for individual stock analysis, "index" for index analysis.
        """
        
        if analysis_type == "stock":
            return self._setup_stock_graph(selected_analysts)
        elif analysis_type == "index":
            return self._setup_index_graph()
        else:
            raise ValueError(f"Unknown analysis_type: {analysis_type}")
    
    def _setup_stock_graph(self, selected_analysts):
        """
        ç°æœ‰çš„ä¸ªè‚¡åˆ†æå›¾æ„å»ºé€»è¾‘ï¼ˆä¿æŒä¸å˜ï¼‰
        """
        # ... ç°æœ‰çš„æ‰€æœ‰ä»£ç ä¿æŒä¸å˜ ...
        # ï¼ˆè¿™é‡Œæ˜¯åŸæœ‰çš„ setup_graph çš„å…¨éƒ¨å†…å®¹ï¼‰
        pass  # ä¸ºç®€æ´èµ·è§ï¼Œçœç•¥ç°æœ‰ä»£ç 
    
    def _setup_index_graph(self):
        """
        æ–°å¢ï¼šæŒ‡æ•°åˆ†æå›¾æ„å»ºé€»è¾‘
        
        æŒ‡æ•°åˆ†ææµç¨‹ï¼š
        START â†’ Macro Analyst â†’ Policy Analyst â†’ Sector Analyst â†’ Strategy Advisor â†’ END
        """
        from tradingagents.agents.analysts.macro_analyst import create_macro_analyst
        from tradingagents.agents.analysts.policy_analyst import create_policy_analyst
        from tradingagents.agents.analysts.sector_analyst import create_sector_analyst
        from tradingagents.agents.analysts.strategy_advisor import create_strategy_advisor
        from tradingagents.agents.utils.agent_utils import create_msg_delete
        
        logger.info("ğŸ—ï¸ [å›¾æ„å»º] å¼€å§‹æ„å»ºæŒ‡æ•°åˆ†æå·¥ä½œæµ")
        
        # åˆ›å»ºæŒ‡æ•°åˆ†æå·¥å…·é›†ï¼ˆå‡è®¾åœ¨ toolkit ä¸­å·²æ·»åŠ  index_toolkitï¼‰
        # è¿™é‡Œéœ€è¦åœ¨ Toolkit ç±»ä¸­æ–°å¢ index ç›¸å…³å·¥å…·çš„åˆå§‹åŒ–
        index_toolkit = self.toolkit  # å‡è®¾ toolkit å·²ç»åŒ…å« fetch_macro_data ç­‰å·¥å…·
        
        # åˆ›å»ºåˆ†æå¸ˆèŠ‚ç‚¹
        macro_analyst_node = create_macro_analyst(self.quick_thinking_llm, index_toolkit)
        policy_analyst_node = create_policy_analyst(self.quick_thinking_llm, index_toolkit)
        sector_analyst_node = create_sector_analyst(self.quick_thinking_llm, index_toolkit)
        strategy_advisor_node = create_strategy_advisor(self.deep_thinking_llm)  # ä¸éœ€è¦å·¥å…·
        
        # åˆ›å»ºæ¶ˆæ¯æ¸…ç†èŠ‚ç‚¹
        macro_clear = create_msg_delete()
        policy_clear = create_msg_delete()
        sector_clear = create_msg_delete()
        strategy_clear = create_msg_delete()
        
        # åˆ›å»ºå·¥ä½œæµ
        workflow = StateGraph(AgentState)
        
        # æ·»åŠ èŠ‚ç‚¹
        workflow.add_node("Macro Analyst", macro_analyst_node)
        workflow.add_node("Msg Clear Macro", macro_clear)
        workflow.add_node("tools_macro", self.tool_nodes.get("index_macro", ToolNode([])))
        
        workflow.add_node("Policy Analyst", policy_analyst_node)
        workflow.add_node("Msg Clear Policy", policy_clear)
        workflow.add_node("tools_policy", self.tool_nodes.get("index_policy", ToolNode([])))
        
        workflow.add_node("Sector Analyst", sector_analyst_node)
        workflow.add_node("Msg Clear Sector", sector_clear)
        workflow.add_node("tools_sector", self.tool_nodes.get("index_sector", ToolNode([])))
        
        workflow.add_node("Strategy Advisor", strategy_advisor_node)
        workflow.add_node("Msg Clear Strategy", strategy_clear)
        
        # å®šä¹‰è¾¹
        # START â†’ Macro Analyst
        workflow.add_edge(START, "Macro Analyst")
        
        # Macro Analyst â†” tools_macro
        workflow.add_conditional_edges(
            "Macro Analyst",
            self.conditional_logic.should_continue_macro,
            ["tools_macro", "Msg Clear Macro"],
        )
        workflow.add_edge("tools_macro", "Macro Analyst")
        workflow.add_edge("Msg Clear Macro", "Policy Analyst")
        
        # Policy Analyst â†” tools_policy
        workflow.add_conditional_edges(
            "Policy Analyst",
            self.conditional_logic.should_continue_policy,
            ["tools_policy", "Msg Clear Policy"],
        )
        workflow.add_edge("tools_policy", "Policy Analyst")
        workflow.add_edge("Msg Clear Policy", "Sector Analyst")
        
        # Sector Analyst â†” tools_sector
        workflow.add_conditional_edges(
            "Sector Analyst",
            self.conditional_logic.should_continue_sector,
            ["tools_sector", "Msg Clear Sector"],
        )
        workflow.add_edge("tools_sector", "Sector Analyst")
        workflow.add_edge("Msg Clear Sector", "Strategy Advisor")
        
        # Strategy Advisor â†’ END
        workflow.add_conditional_edges(
            "Strategy Advisor",
            self.conditional_logic.should_continue_strategy,
            ["Msg Clear Strategy"],
        )
        workflow.add_edge("Msg Clear Strategy", END)
        
        # ç¼–è¯‘å›¾
        graph = workflow.compile()
        logger.info("âœ… [å›¾æ„å»º] æŒ‡æ•°åˆ†æå·¥ä½œæµæ„å»ºå®Œæˆ")
        
        return graph
```

#### 4.2.3 å·¥å…·èŠ‚ç‚¹åˆå§‹åŒ–

åœ¨ `GraphSetup.__init__()` ä¸­æ·»åŠ æŒ‡æ•°åˆ†æå·¥å…·èŠ‚ç‚¹çš„åˆå§‹åŒ–ï¼ˆæˆ–åœ¨å¤–éƒ¨ä¼ å…¥ï¼‰ï¼š

```python
# tradingagents/graph/setup.py (åœ¨ __init__ ä¸­)

def __init__(
    self,
    quick_thinking_llm: ChatOpenAI,
    deep_thinking_llm: ChatOpenAI,
    toolkit: Toolkit,
    tool_nodes: Dict[str, ToolNode],
    bull_memory,
    bear_memory,
    trader_memory,
    invest_judge_memory,
    risk_manager_memory,
    conditional_logic: ConditionalLogic,
    config: Dict[str, Any] = None,
    react_llm = None,
):
    """Initialize with required components."""
    self.quick_thinking_llm = quick_thinking_llm
    self.deep_thinking_llm = deep_thinking_llm
    self.toolkit = toolkit
    self.tool_nodes = tool_nodes
    self.bull_memory = bull_memory
    self.bear_memory = bear_memory
    self.trader_memory = trader_memory
    self.invest_judge_memory = invest_judge_memory
    self.risk_manager_memory = risk_manager_memory
    self.conditional_logic = conditional_logic
    self.config = config or {}
    self.react_llm = react_llm
    
    # ğŸ†• æ–°å¢ï¼šç¡®ä¿ tool_nodes åŒ…å«æŒ‡æ•°åˆ†æå·¥å…·èŠ‚ç‚¹
    # å¦‚æœ tool_nodes ä¸­æ²¡æœ‰ï¼Œè¿™é‡Œéœ€è¦åˆ›å»º
    # ç¤ºä¾‹ï¼š
    # if "index_macro" not in self.tool_nodes:
    #     from tradingagents.tools.index_tools import INDEX_ANALYSIS_TOOLS
    #     self.tool_nodes["index_macro"] = ToolNode([toolkit.fetch_macro_data])
    #     self.tool_nodes["index_policy"] = ToolNode([toolkit.fetch_policy_news])
    #     self.tool_nodes["index_sector"] = ToolNode([toolkit.fetch_sector_rotation])
```

---

### 4.3 è·¯ç”±å…¥å£è®¾è®¡

åœ¨åº”ç”¨å±‚ï¼ˆAPI æˆ– CLI å…¥å£ï¼‰æ ¹æ®ç”¨æˆ·è¾“å…¥çš„è‚¡ç¥¨/æŒ‡æ•°ä»£ç åˆ¤æ–­ `is_index` å­—æ®µï¼Œå¹¶é€‰æ‹©å¯¹åº”çš„å·¥ä½œæµã€‚

#### 4.3.1 åˆ¤æ–­é€»è¾‘

```python
# ç¤ºä¾‹ï¼šåœ¨ API å…¥å£æˆ– CLI å…¥å£

def analyze(ticker: str, trade_date: str, llm_config: dict):
    """
    æ ¹æ® ticker åˆ¤æ–­æ˜¯ä¸ªè‚¡è¿˜æ˜¯æŒ‡æ•°ï¼Œè°ƒç”¨å¯¹åº”çš„åˆ†ææµç¨‹
    
    Args:
        ticker: è‚¡ç¥¨ä»£ç æˆ–æŒ‡æ•°ä»£ç 
        trade_date: äº¤æ˜“æ—¥æœŸ
        llm_config: LLM é…ç½®
    """
    # åˆ¤æ–­æ˜¯å¦ä¸ºæŒ‡æ•°
    is_index = _is_index_ticker(ticker)
    
    # åˆå§‹åŒ–çŠ¶æ€
    initial_state = {
        "company_of_interest": ticker,
        "trade_date": trade_date,
        "messages": [],
        "is_index": is_index,
        # ... å…¶ä»–å­—æ®µåˆå§‹åŒ–ä¸ºé»˜è®¤å€¼ ...
    }
    
    # æ„å»ºå›¾
    graph_setup = GraphSetup(
        quick_thinking_llm=llm_config['quick_llm'],
        deep_thinking_llm=llm_config['deep_llm'],
        toolkit=toolkit,
        tool_nodes=tool_nodes,
        # ... å…¶ä»–å‚æ•° ...
    )
    
    if is_index:
        logger.info(f"ğŸ“Š æ£€æµ‹åˆ°æŒ‡æ•°ä»£ç : {ticker}ï¼Œå¯åŠ¨æŒ‡æ•°åˆ†ææµç¨‹")
        graph = graph_setup.setup_graph(analysis_type="index")
    else:
        logger.info(f"ğŸ“ˆ æ£€æµ‹åˆ°ä¸ªè‚¡ä»£ç : {ticker}ï¼Œå¯åŠ¨ä¸ªè‚¡åˆ†ææµç¨‹")
        graph = graph_setup.setup_graph(
            selected_analysts=["market", "social", "news", "fundamentals"],
            analysis_type="stock"
        )
    
    # æ‰§è¡Œå›¾
    result = graph.invoke(initial_state)
    
    return result

def _is_index_ticker(ticker: str) -> bool:
    """
    åˆ¤æ–­æ˜¯å¦ä¸ºæŒ‡æ•°ä»£ç 
    
    å¸¸è§æŒ‡æ•°ä»£ç è§„åˆ™ï¼š
    - ä¸Šè¯æŒ‡æ•°: sh000001, 000001.SH
    - æ·±è¯æˆæŒ‡: sz399001, 399001.SZ
    - åˆ›ä¸šæ¿æŒ‡: sz399006, 399006.SZ
    - ç§‘åˆ›50: sh000688, 000688.SH
    """
    # ç®€å•è§„åˆ™ï¼šä»¥ 000ã€399 å¼€å¤´çš„æ˜¯æŒ‡æ•°
    ticker_clean = ticker.upper().replace('.SH', '').replace('.SZ', '').replace('SH', '').replace('SZ', '')
    
    index_prefixes = ['000', '399']  # ä¸Šè¯æŒ‡æ•°ã€æ·±è¯æŒ‡æ•°
    
    for prefix in index_prefixes:
        if ticker_clean.startswith(prefix):
            return True
    
    # ä¹Ÿå¯ä»¥ä½¿ç”¨ç™½åå•
    index_whitelist = [
        'sh000001', '000001.SH',  # ä¸Šè¯æŒ‡æ•°
        'sz399001', '399001.SZ',  # æ·±è¯æˆæŒ‡
        'sz399006', '399006.SZ',  # åˆ›ä¸šæ¿æŒ‡
        'sh000688', '000688.SH',  # ç§‘åˆ›50
        'sh000300', '000300.SH',  # æ²ªæ·±300
    ]
    
    return ticker.lower() in [x.lower() for x in index_whitelist]
```

---

### 4.4 æµç¨‹å›¾ç¤º

#### 4.4.1 ä¸ªè‚¡åˆ†ææµç¨‹ï¼ˆç°æœ‰ï¼Œä¿æŒä¸å˜ï¼‰

```
START â†’ Market Analyst â†’ Social Analyst â†’ News Analyst â†’ Fundamentals Analyst 
  â†’ Bull Researcher â†’ Bear Researcher â†’ Research Manager â†’ Trader 
  â†’ Risky Analyst â†’ Neutral Analyst â†’ Safe Analyst â†’ Risk Judge â†’ END
```

#### 4.4.2 æŒ‡æ•°åˆ†ææµç¨‹ï¼ˆæ–°å¢ï¼‰

```
START â†’ Macro Analyst â†’ Policy Analyst â†’ Sector Analyst â†’ Strategy Advisor â†’ END
```

#### 4.4.3 è·¯ç”±åˆ¤æ–­æµç¨‹

```
ç”¨æˆ·è¾“å…¥ ticker
    |
    v
åˆ¤æ–­ is_index?
    |
    +--- Yes â†’ æŒ‡æ•°åˆ†ææµç¨‹ï¼ˆMacro â†’ Policy â†’ Sector â†’ Strategyï¼‰
    |
    +--- No  â†’ ä¸ªè‚¡åˆ†ææµç¨‹ï¼ˆMarket â†’ Social â†’ News â†’ Fundamentals â†’ ...ï¼‰
```
## 5. é›†æˆæ­¥éª¤

### 5.1 æ–‡ä»¶æ¸…å•

#### 5.1.1 æ–°å»ºæ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | åŠŸèƒ½æè¿° | ä¾èµ–å…³ç³» |
|---------|---------|----------|
| `tradingagents/dataflows/index_data.py` | æŒ‡æ•°åˆ†ææ•°æ®æä¾›è€… | akshare, cache |
| `tradingagents/tools/index_tools.py` | æŒ‡æ•°åˆ†æLangChainå·¥å…· | index_data.py |
| `tradingagents/agents/utils/analysis_schemas.py` | Pydanticè¾“å‡ºæ¨¡å‹ | pydantic |
| `tradingagents/agents/analysts/macro_analyst.py` | å®è§‚ç»æµåˆ†æå¸ˆ | index_tools.py |
| `tradingagents/agents/analysts/policy_analyst.py` | æ”¿ç­–åˆ†æå¸ˆ | index_tools.py |
| `tradingagents/agents/analysts/sector_analyst.py` | æ¿å—è½®åŠ¨åˆ†æå¸ˆ | index_tools.py |
| `tradingagents/agents/analysts/strategy_advisor.py` | ç­–ç•¥é¡¾é—® | æ— éœ€å·¥å…· |

#### 5.1.2 ä¿®æ”¹æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | ä¿®æ”¹å†…å®¹ | å½±å“èŒƒå›´ |
|---------|---------|----------|
| `tradingagents/agents/utils/agent_states.py` | æ‰©å±•AgentStateï¼Œæ·»åŠ æŒ‡æ•°åˆ†æå­—æ®µ | â­â­ æ ¸å¿ƒä¿®æ”¹ |
| `tradingagents/graph/setup.py` | æ·»åŠ  `_setup_index_graph()` æ–¹æ³• | â­â­â­ æ ¸å¿ƒä¿®æ”¹ |
| `tradingagents/graph/conditional_logic.py` | æ·»åŠ æŒ‡æ•°åˆ†æè·¯ç”±æ–¹æ³• | â­â­ æ ¸å¿ƒä¿®æ”¹ |
| `tradingagents/agents/utils/agent_utils.py` | åœ¨Toolkitä¸­æ³¨å†Œindexå·¥å…· | â­ å°èŒƒå›´ |

---

### 5.2 è¯¦ç»†é›†æˆæ­¥éª¤

#### æ­¥éª¤1: æ•°æ®å±‚å®ç° âœ…

**ç›®æ ‡**: åˆ›å»º `index_data.py`ï¼Œå®ç°æ•°æ®è·å–å’Œç¼“å­˜

```bash
# åˆ›å»ºæ–‡ä»¶
touch tradingagents/dataflows/index_data.py
```

**å®ç°å†…å®¹**:
- `IndexDataProvider` ç±»ï¼ˆå·²åœ¨ç¬¬2.1èŠ‚è¯¦ç»†è®¾è®¡ï¼‰
- `get_macro_economics_data()` æ–¹æ³•
- `get_policy_news()` æ–¹æ³•
- `get_sector_flows()` æ–¹æ³•
- MongoDBç¼“å­˜æœºåˆ¶

**éªŒè¯**:
```python
# æµ‹è¯•æ•°æ®è·å–
from tradingagents.dataflows.index_data import index_data_provider

data = index_data_provider.get_macro_economics_data()
print(data)
```

---

#### æ­¥éª¤2: å·¥å…·å±‚å®ç° âœ…

**ç›®æ ‡**: åˆ›å»º `index_tools.py`ï¼Œå°è£…LangChainå·¥å…·

```bash
touch tradingagents/tools/index_tools.py
```

**å®ç°å†…å®¹**:
- `fetch_macro_data` å·¥å…·ï¼ˆå·²åœ¨ç¬¬2.2èŠ‚è¯¦ç»†è®¾è®¡ï¼‰
- `fetch_policy_news` å·¥å…·
- `fetch_sector_rotation` å·¥å…·
- `INDEX_ANALYSIS_TOOLS` åˆ—è¡¨

**éªŒè¯**:
```python
from tradingagents.tools.index_tools import fetch_macro_data

result = fetch_macro_data.invoke({"query_date": "2024-12-10"})
print(result)
```

---

#### æ­¥éª¤3: Pydantic Schemaå®šä¹‰ âœ…

**ç›®æ ‡**: åˆ›å»º `analysis_schemas.py`ï¼Œå®šä¹‰è¾“å‡ºæ¨¡å‹

```bash
touch tradingagents/agents/utils/analysis_schemas.py
```

**å®ç°å†…å®¹**:
- `MacroAnalysis` æ¨¡å‹ï¼ˆå·²åœ¨ç¬¬1.2èŠ‚è¯¦ç»†è®¾è®¡ï¼‰
- `PolicyAnalysis` æ¨¡å‹
- `SectorAnalysis` æ¨¡å‹
- `StrategyOutput` æ¨¡å‹
- JSON Schema å¸¸é‡

**éªŒè¯**:
```python
from tradingagents.agents.utils.analysis_schemas import MacroAnalysis
import json

json_str = '{"economic_cycle": "å¤è‹", "liquidity": "å®½æ¾", ...}'
analysis = MacroAnalysis.parse_raw(json_str)
print(analysis.sentiment_score)
```

---

#### æ­¥éª¤4: AgentèŠ‚ç‚¹å®ç° âœ…

**ç›®æ ‡**: åˆ›å»º4ä¸ªåˆ†æå¸ˆèŠ‚ç‚¹

```bash
touch tradingagents/agents/analysts/macro_analyst.py
touch tradingagents/agents/analysts/policy_analyst.py
touch tradingagents/agents/analysts/sector_analyst.py
touch tradingagents/agents/analysts/strategy_advisor.py
```

**å®ç°å†…å®¹**:
- æ¯ä¸ªæ–‡ä»¶åŒ…å« `create_xxx_analyst()` å‡½æ•°ï¼ˆå·²åœ¨ç¬¬3èŠ‚è¯¦ç»†è®¾è®¡ï¼‰
- éµå¾ª `create_market_analyst` çš„å®ç°æ¨¡å¼
- åŒ…å«å·¥å…·è°ƒç”¨è®¡æ•°å™¨é˜²æ­¢æ­»å¾ªç¯
- JSONæ ¼å¼è¾“å‡ºæå–é€»è¾‘

**éªŒè¯**:
```python
from tradingagents.agents.analysts.macro_analyst import create_macro_analyst
from langchain_openai import ChatOpenAI

llm = ChatOpenAI(model="gpt-4")
index_toolkit = ...  # å·¥å…·é›†

macro_node = create_macro_analyst(llm, index_toolkit)

test_state = {
    "messages": [],
    "trade_date": "2024-12-10",
    "company_of_interest": "sh000001",
    "macro_tool_call_count": 0
}

result = macro_node(test_state)
print(result['macro_report'])
```

---

#### æ­¥éª¤5: çŠ¶æ€æ‰©å±• â­â­

**ç›®æ ‡**: ä¿®æ”¹ `agent_states.py`ï¼Œæ·»åŠ æŒ‡æ•°åˆ†æå­—æ®µ

```bash
# ç¼–è¾‘æ–‡ä»¶
vim tradingagents/agents/utils/agent_states.py
```

**ä¿®æ”¹å†…å®¹**:
```python
# åœ¨ AgentState ç±»ä¸­æ·»åŠ ä»¥ä¸‹å­—æ®µï¼ˆå·²åœ¨ç¬¬1.1èŠ‚è¯¦ç»†è®¾è®¡ï¼‰

class AgentState(MessagesState):
    # ... ç°æœ‰å­—æ®µ ...
    
    # ========== è·¯ç”±æ ‡è¯† (æ–°å¢) ==========
    is_index: Annotated[bool, "True for index analysis, False for stock analysis"]
    
    # ========== æŒ‡æ•°åˆ†æå­—æ®µ (æ–°å¢) ==========
    macro_report: Annotated[str, "Report from Macro Analyst (JSON format with confidence)"]
    macro_tool_call_count: Annotated[int, "Macro analyst tool call counter"]
    
    policy_report: Annotated[str, "Report from Policy Analyst (JSON format with confidence)"]
    policy_tool_call_count: Annotated[int, "Policy analyst tool call counter"]
    
    sector_report: Annotated[str, "Report from Sector Analyst (JSON format with confidence)"]
    sector_tool_call_count: Annotated[int, "Sector analyst tool call counter"]
    
    strategy_report: Annotated[str, "Final strategy report from Strategy Advisor"]
```

**éªŒè¯**:
```python
from tradingagents.agents.utils.agent_states import AgentState

state = AgentState(
    messages=[],
    company_of_interest="sh000001",
    trade_date="2024-12-10",
    is_index=True,
    macro_report="",
    macro_tool_call_count=0
)
print(state)
```

---

#### æ­¥éª¤6: è·¯ç”±é€»è¾‘æ‰©å±• â­â­

**ç›®æ ‡**: ä¿®æ”¹ `conditional_logic.py`ï¼Œæ·»åŠ æŒ‡æ•°åˆ†æè·¯ç”±æ–¹æ³•

```bash
vim tradingagents/graph/conditional_logic.py
```

**ä¿®æ”¹å†…å®¹**ï¼ˆå·²åœ¨ç¬¬4.1èŠ‚è¯¦ç»†è®¾è®¡ï¼‰:
- æ·»åŠ  `should_continue_macro()`
- æ·»åŠ  `should_continue_policy()`
- æ·»åŠ  `should_continue_sector()`
- æ·»åŠ  `should_continue_strategy()`

**éªŒè¯**:
```python
from tradingagents.graph.conditional_logic import ConditionalLogic

logic = ConditionalLogic()
test_state = {...}

result = logic.should_continue_macro(test_state)
print(result)  # åº”è¯¥è¿”å› "tools_macro" æˆ– "Msg Clear Macro"
```

---

#### æ­¥éª¤7: å›¾æ„å»ºæ‰©å±• â­â­â­

**ç›®æ ‡**: ä¿®æ”¹ `setup.py`ï¼Œæ·»åŠ æŒ‡æ•°åˆ†æå›¾æ„å»ºé€»è¾‘

```bash
vim tradingagents/graph/setup.py
```

**ä¿®æ”¹å†…å®¹**ï¼ˆå·²åœ¨ç¬¬4.2èŠ‚è¯¦ç»†è®¾è®¡ï¼‰:
1. ä¿®æ”¹ `setup_graph()` æ–¹æ³•ï¼Œæ·»åŠ  `analysis_type` å‚æ•°
2. æ·»åŠ  `_setup_index_graph()` æ–¹æ³•
3. åœ¨ `__init__()` ä¸­åˆå§‹åŒ–indexå·¥å…·èŠ‚ç‚¹

**éªŒè¯**:
```python
from tradingagents.graph.setup import GraphSetup

graph_setup = GraphSetup(...)
index_graph = graph_setup.setup_graph(analysis_type="index")

print(index_graph.get_graph().nodes())  # åº”è¯¥åŒ…å« Macro Analyst, Policy Analyst ç­‰
```

---

#### æ­¥éª¤8: å·¥å…·é›†æ³¨å†Œ

**ç›®æ ‡**: åœ¨ `Toolkit` ç±»ä¸­æ³¨å†Œindexåˆ†æå·¥å…·

```bash
vim tradingagents/agents/utils/agent_utils.py
```

**ä¿®æ”¹å†…å®¹**:
```python
# åœ¨ Toolkit ç±»ä¸­æ·»åŠ 

class Toolkit:
    def __init__(self):
        # ... ç°æœ‰å·¥å…· ...
        
        # æ–°å¢ï¼šæŒ‡æ•°åˆ†æå·¥å…·
        from tradingagents.tools.index_tools import (
            fetch_macro_data,
            fetch_policy_news,
            fetch_sector_rotation
        )
        self.fetch_macro_data = fetch_macro_data
        self.fetch_policy_news = fetch_policy_news
        self.fetch_sector_rotation = fetch_sector_rotation
```

---

#### æ­¥éª¤9: åº”ç”¨å±‚é›†æˆ

**ç›®æ ‡**: åœ¨APIæˆ–CLIå…¥å£æ·»åŠ è·¯ç”±åˆ¤æ–­é€»è¾‘

**ä¿®æ”¹å†…å®¹**ï¼ˆå·²åœ¨ç¬¬4.3èŠ‚è¯¦ç»†è®¾è®¡ï¼‰:
- æ·»åŠ  `_is_index_ticker()` åˆ¤æ–­å‡½æ•°
- åœ¨ `analyze()` å‡½æ•°ä¸­æ ¹æ® `is_index` é€‰æ‹©å·¥ä½œæµ

**ç¤ºä¾‹**:
```python
# åœ¨ main.py æˆ– api.py ä¸­

def analyze(ticker: str, trade_date: str):
    is_index = _is_index_ticker(ticker)
    
    graph_setup = GraphSetup(...)
    
    if is_index:
        graph = graph_setup.setup_graph(analysis_type="index")
    else:
        graph = graph_setup.setup_graph(
            selected_analysts=["market", "news"],
            analysis_type="stock"
        )
    
    initial_state = {
        "company_of_interest": ticker,
        "trade_date": trade_date,
        "is_index": is_index,
        "messages": []
    }
    
    result = graph.invoke(initial_state)
    return result
```

---

### 5.3 é›†æˆæ£€æŸ¥æ¸…å•

- [ ] **æ­¥éª¤1**: æ•°æ®å±‚å®ç°å®Œæˆï¼Œæµ‹è¯•é€šè¿‡
- [ ] **æ­¥éª¤2**: å·¥å…·å±‚å®ç°å®Œæˆï¼Œæµ‹è¯•é€šè¿‡
- [ ] **æ­¥éª¤3**: Pydantic Schemaå®šä¹‰å®Œæˆ
- [ ] **æ­¥éª¤4**: 4ä¸ªAgentèŠ‚ç‚¹å®ç°å®Œæˆï¼Œå•å…ƒæµ‹è¯•é€šè¿‡
- [ ] **æ­¥éª¤5**: AgentStateæ‰©å±•å®Œæˆï¼Œæ— ç ´åæ€§å½±å“
- [ ] **æ­¥éª¤6**: è·¯ç”±é€»è¾‘æ‰©å±•å®Œæˆï¼Œæµ‹è¯•é€šè¿‡
- [ ] **æ­¥éª¤7**: å›¾æ„å»ºé€»è¾‘å®Œæˆï¼Œç”Ÿæˆæ­£ç¡®çš„å·¥ä½œæµ
- [ ] **æ­¥éª¤8**: å·¥å…·é›†æ³¨å†Œå®Œæˆ
- [ ] **æ­¥éª¤9**: åº”ç”¨å±‚é›†æˆå®Œæˆï¼Œç«¯åˆ°ç«¯æµ‹è¯•é€šè¿‡

---

### 5.4 å›å½’æµ‹è¯•

**é‡è¦**: ç¡®ä¿æ–°å¢åŠŸèƒ½ä¸å½±å“ç°æœ‰ä¸ªè‚¡åˆ†ææµç¨‹

```bash
# æµ‹è¯•ç°æœ‰ä¸ªè‚¡åˆ†ææµç¨‹
python -m pytest tests/test_stock_analysis.py

# æµ‹è¯•æ–°çš„æŒ‡æ•°åˆ†ææµç¨‹
python -m pytest tests/test_index_analysis.py
```

**éªŒè¯ç‚¹**:
1. âœ… ä¸ªè‚¡åˆ†ææµç¨‹ï¼ˆ`is_index=False`ï¼‰ä»ç„¶æ­£å¸¸å·¥ä½œ
2. âœ… æŒ‡æ•°åˆ†ææµç¨‹ï¼ˆ`is_index=True`ï¼‰èƒ½æ­£ç¡®æ‰§è¡Œ
3. âœ… çŠ¶æ€å­—æ®µä¸å†²çª
4. âœ… æ—¥å¿—è¾“å‡ºæ¸…æ™°
5. âœ… ç¼“å­˜æœºåˆ¶æ­£å¸¸