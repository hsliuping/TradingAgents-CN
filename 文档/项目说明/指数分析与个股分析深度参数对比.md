# 指数分析与个股分析深度参数对比文档

本文档总结了后端 API 实现 (`app/services/simple_analysis_service.py`) 与 Web 工具 (`web/utils/analysis_runner.py`) 在处理分析深度 (`research_depth`) 参数上的异同，以及针对指数分析的特殊处理。

## 1. 概述

无论是指数分析还是个股分析，系统都使用 `research_depth` (研究深度) 参数来控制分析的复杂度和资源消耗。该参数通常分为 1-5 个等级，对应不同的配置组合，主要影响：
- **辩论轮次 (`max_debate_rounds`)**：多Agent辩论的轮数。
- **风险讨论轮次 (`max_risk_discuss_rounds`)**：风险评估团队的讨论轮数。
- **记忆功能 (`memory_enabled`)**：是否启用长期记忆（影响速度）。
- **模型选择**：不同深度可能采用不同的 LLM 模型组合（快速 vs 深度思考模型）。

## 2. 实现对比

### 2.1 后端 API 服务 (`app/services/simple_analysis_service.py`)

后端服务通过 `create_analysis_config` 辅助函数来集中处理配置逻辑。

- **参数处理**: 支持数字 (1-5) 或字符串 ("快速", "基础", "标准", "深度", "全面") 输入，内部统一转换为中文标签处理。
- **指数分析特殊处理**:
    - 在 `execute_analysis_background` 中检测到 `analysis_type="index"` 时，会跳过个股数据验证 (`prepare_stock_data_async`)。
    - 在 `_get_trading_graph` 中，如果 `analysis_type="index"`，会强制清空 `selected_analysts` (设为 `[]`)，因为指数分析不需要个股层面的分析师（如基本面分析师）。
- **配置映射**:
    - **1级 (快速)**: 辩论1轮，风险1轮，记忆关闭。
    - **2级 (基础)**: 辩论1轮，风险1轮，记忆开启。
    - **3级 (标准)**: 辩论1轮，风险2轮，记忆开启。
    - **4级 (深度)**: 辩论2轮，风险2轮，记忆开启。
    - **5级 (全面)**: 辩论3轮，风险3轮，记忆开启。

### 2.2 Web 执行工具 (`web/utils/analysis_runner.py`)

Web 端运行器在 `run_stock_analysis` 函数内部直接处理配置逻辑。

- **参数处理**: 主要接收整数类型的 `research_depth`。
- **个股分析侧重**:
    - 逻辑主要围绕个股设计，包含详细的股票代码验证 (`validate_analysis_params`) 和格式化逻辑 (A股/港股/美股)。
    - 分析师列表由前端传入，直接传递给 `TradingAgentsGraph`。
- **模型动态选择**:
    - Web Runner 包含详细的硬编码逻辑，根据 `research_depth` 和 `llm_provider` 动态选择具体的 `quick_think_llm` 和 `deep_think_llm`（例如 Google Provider 下，深度1使用 `gemini-2.5-flash-lite-preview-06-17`，深度5使用 `gemini-2.5-pro`）。
- **配置映射**:
    - 核心的轮次配置 (1-5级) 与后端完全一致。

## 3. 相似点

1.  **核心映射逻辑一致**: 两个模块对于 1-5 级深度对应的 `max_debate_rounds`, `max_risk_discuss_rounds`, 和 `memory_enabled` 的参数设置是完全相同的。
2.  **默认行为**: 都在低深度 (Level 1) 关闭了记忆功能以提升速度。

## 4. 差异点

| 特性 | 后端 API (`simple_analysis_service.py`) | Web Runner (`analysis_runner.py`) |
| :--- | :--- | :--- |
| **代码结构** | 使用独立的 `create_analysis_config` 辅助函数。 | 配置逻辑内嵌在主流程函数中。 |
| **指数分析支持** | 显式支持。自动跳过验证，清空分析师列表。 | 隐式支持。依赖调用方传入正确的参数，无专门的 `analysis_type="index"` 分支逻辑。 |
| **模型选择** | 主要依赖外部传入的模型名称或数据库配置。 | 内置了根据深度自动选择具体模型版本的详细逻辑 (Hardcoded)。 |
| **参数输入** | 兼容数字和中文字符串。 | 主要处理数字输入。 |

## 5. 建议

为了保证系统的一致性和可维护性，建议进行以下优化：

1.  **统一配置逻辑**: 抽取 `create_analysis_config` 逻辑到一个共享的工具模块 (如 `tradingagents/utils/config_utils.py`)，供 Backend API 和 Web Runner 共同调用。
2.  **统一模型选择策略**: Web Runner 中的动态模型选择逻辑非常有价值（根据深度选模型），建议将其移至共享配置模块中，使得 API 服务也能享受到根据深度自动降级/升级模型的特性。
3.  **显式化 Web 端的指数分析**: 虽然 Web 端目前可能主要用于个股，但随着功能扩展，应在 Runner 中增加对 `analysis_type` 的显式处理，确保指数分析时不会错误地运行个股数据验证逻辑。