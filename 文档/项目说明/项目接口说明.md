# TradingAgents-CN 后端 LangGraph 工作流与节点说明

> 本文档用于快速理解当前基于 LangGraph 实现的多智能体分析后端。  
> 重点：**每个 LangGraph 节点的作用、使用哪些数据源、如何逐步汇总成最终分析与交易决策**。  
> 不涉及前端，只覆盖 FastAPI + TradingAgents + 数据流部分。

---

## 1. 后端整体架构（后端视角简要）

### 1.1 关键目录

- `app/`
  - `main.py`：FastAPI 入口，注册所有路由
  - `routers/analysis.py`：**股票分析 API（LangGraph 的 HTTP 入口）**
  - `services/simple_analysis_service.py`：**封装 TradingAgentsGraph 的分析服务**
  - 其它：
    - `services/redis_progress_tracker.py` / `memory_state_manager.py`：任务状态与进度
    - `routers/sse.py` / `routers/websocket_notifications.py`：SSE & WebSocket 进度推送
    - `routers/config.py` / `routers/model_capabilities.py`：系统配置与模型能力
- `tradingagents/`
  - `graph/trading_graph.py`：**TradingAgentsGraph，LangGraph 工作流的封装入口**
  - `graph/setup.py`：构建 LangGraph `StateGraph`（节点 + 边）
  - `graph/conditional_logic.py`：节点间条件跳转逻辑（是否继续调用工具 / 继续辩论）
  - `agents/`：各类智能体节点（分析师、研究员、交易员、风险团队）
  - `agents/utils/agent_states.py`：状态结构（AgentState、InvestDebateState、RiskDebateState）
  - `agents/utils/agent_utils.py`：工具集合 `Toolkit`（统一市场/新闻/情绪/基本面工具）
  - `dataflows/`：数据源管理 & 抽象（Tushare/AKShare/Baostock/YFinance 等，多数据源降级）
  - `utils/stock_validator.py`：异步预加载 & 校验股票数据

### 1.2 API 入口与调用链

- HTTP 入口（提交分析）：
  - `POST /api/analysis/single`
    - 请求体：`SingleAnalysisRequest`（股票代码 + `AnalysisParameters`）
    - 入口：`app/routers/analysis.py::submit_single_analysis`
    - 调用链：
      1. `SimpleAnalysisService.create_analysis_task()`：创建任务 + 写 MongoDB + 内存任务状态
      2. 后台协程 `execute_analysis_background()`：
         - `prepare_stock_data_async()`：先校验 & 预拉取数据
         - `_execute_analysis_sync()`→ `_run_analysis_sync()`（在线程池中）
         - `TradingAgentsGraph.propagate(...)`：真正跑 LangGraph 图
- 结果查询：
  - `GET /api/analysis/tasks/{task_id}/status`：任务状态 + 进度
  - `GET /api/analysis/tasks/{task_id}/result`：**最终分析 / 报告 / 决策**

---

## 2. LangGraph 工作流整体结构

### 2.1 状态与图

- 状态类型（`tradingagents/agents/utils/agent_states.py`）：
  - `AgentState`：全局状态（包含 messages、各类报告、最终决策等）
  - `InvestDebateState`：多头/空头研究员辩论状态
  - `RiskDebateState`：风险团队辩论状态

- 图构建（`tradingagents/graph/setup.py`）：

```text
START
  → (分析师阶段：Market / News / Social / Fundamentals 串行执行)
  → Bull Researcher ↔ Bear Researcher (多轮辩论)
  → Research Manager（形成研究结论 & 投资计划）
  → Trader（具体交易方案）
  → Risky / Safe / Neutral Analysts（多轮风险辩论）
  → Risk Judge（风险经理最终裁决）
  → END
```

LangGraph 使用 `StateGraph(AgentState)` 来定义节点和边，每个节点都是一个 Python 函数（智能体或工具），读写 `state` 对象。

---

## 3. 节点阶段划分总览

为了理解清晰，可以按阶段拆分：

1. **初始状态构建**
   - 使用 `Propagator.create_initial_state()` 把股票代码/日期包装成自然语言任务，并放入 `AgentState.messages`。
2. **分析师阶段（Analysts）**
   - Market Analyst（市场分析师）→ `market_report`
   - News Analyst（新闻分析师）→ `news_report`
   - Social Media Analyst（社媒/情绪分析师）→ `sentiment_report`
   - Fundamentals Analyst（基本面分析师）→ `fundamentals_report`
   - 每位分析师都可能调用相应 ToolNode 中的工具（统一市场/基本面/新闻/情绪工具）获取数据。
3. **研究辩论阶段（Research Debate）**
   - Bull Researcher（看涨） & Bear Researcher（看跌） 多轮辩论，形成多空论据
   - Research Manager（研究经理）整合多空观点 + 历史记忆 → `research_team_decision` + `investment_plan`
4. **交易执行阶段（Trader）**
   - Trader 根据 `investment_plan` + 多个报告 → 生成 `trader_investment_plan`（更落地的交易方案）
5. **风险管理阶段（Risk Management）**
   - Risky Analyst / Safe Analyst / Neutral Analyst：基于所有报告 + 交易计划，进行多轮风险辩论
   - Risk Judge（风险经理）结合辩论和历史记忆 → `risk_management_decision` + **最终 `final_trade_decision`**
6. **信号处理（SignalProcessor & TradingAgentsGraph.process_signal）**
   - 把 `final_trade_decision` 解析成结构化 `decision`：
     - `action`（买入/卖出/持有）
     - `target_price`
     - `confidence`
     - `risk_score`
     - `reasoning` 等

下面详细说明每个节点。

---

## 4. 初始状态节点：Propagator

位置：`tradingagents/graph/propagation.py`

### 4.1 create_initial_state

```python
def create_initial_state(self, company_name: str, trade_date: str) -> Dict[str, Any]:
    from langchain_core.messages import HumanMessage
    analysis_request = f"请对股票 {company_name} 进行全面分析，交易日期为 {trade_date}。"
    return {
        "messages": [HumanMessage(content=analysis_request)],
        "company_of_interest": company_name,
        "trade_date": str(trade_date),
        "investment_debate_state": InvestDebateState({ ... }),
        "risk_debate_state": RiskDebateState({ ... }),
        ...
    }
```

- **作用：**
  - 把原本只有"股票代码 + 日期"的调用，变成语言模型能理解的**完整分析任务描述**。
- **数据来源：**
  - 来自服务层 `_run_analysis_sync()` 传入的 `stock_code` 与 `analysis_date`。
- **输出到状态：**
  - `messages[0]`：人类指令（主任务）
  - `company_of_interest`：股票代码或名称
  - `trade_date`：目标交易日期
  - 初始化空的 `investment_debate_state` / `risk_debate_state`

---

## 5. 分析师阶段节点（Analysts + Tools）

此阶段主要由四类分析师组成，分别负责不同维度的输入数据。每个分析师节点负责：

1. 调用相应统一工具（通过 ToolNode 或 toolkit）
2. 将返回的文本数据整理为报告字段
3. 写入 `state`，供后续节点使用

### 5.1 Market Analyst（市场分析师）

实现位置：

- 构图：`GraphSetup.setup_graph()` 中 `create_market_analyst(self.quick_thinking_llm, self.toolkit)`
- 节点函数：`tradingagents/agents/analysts/market_analyst.py::market_analyst_node`
- 工具绑定：
  - 在 `TradingAgentsGraph._create_tool_nodes()`：

    ```python
    "market": ToolNode(
        [
            self.toolkit.get_stock_market_data_unified,
            self.toolkit.get_YFin_data_online,
            self.toolkit.get_stockstats_indicators_report_online,
            self.toolkit.get_YFin_data,
            self.toolkit.get_stockstats_indicators_report,
        ]
    )
    ```

#### 5.1.1 获取的数据

- **统一工具 `get_stock_market_data_unified`（强推荐）**：
  - 自动识别股票类型（A股/港股/美股）
  - 对于 A 股：
    - 通过 `DataSourceManager` 调用：
      - MongoDB 缓存
      - Tushare / AKShare / Baostock 等（多数据源降级）
  - 对于美股：
    - YFinance / AlphaVantage / Finnhub（通过 `USDataSourceManager` 与 providers）
  - 典型数据内容：
    - 日 K 数据（开高收低）
    - 成交量
    - 技术指标（MA、MACD、RSI 等）
    - 简要统计和解释性文本（工具已整理为可读文本）

#### 5.1.2 节点如何使用数据

- Market Analyst 会：
  - 根据 `company_of_interest` 和 `trade_date` 生成系统指令，指引 LLM：
    - 关注价格趋势、成交量、波动率
    - 分析技术指标信号
    - 给出短期（1–5 天）市场预期
  - LLM 通过 ToolNode 调用 `get_stock_market_data_unified`（必要时多次调用，conditional_logic 控制不陷入死循环）
  - 将工具返回的字符串数据，连同 LLM 的解释性文本整理为 **`market_report`**，写入 `state["market_report"]`。

#### 5.1.3 对最终决策的贡献

- 在后续：
  - Bull/Bear Researcher、Research Manager、Trader、Risk 团队都会读取 `market_report`：
    - 作为市场价格与技术面依据
    - 用于支撑多头/空头论据
    - 用于判断是否处于高位/低位/箱体等技术状态

---

### 5.2 News Analyst（新闻分析师）

实现位置：

- 节点函数：`tradingagents/agents/analysts/news_analyst.py::news_analyst_node`
- 使用工具：
  - `create_unified_news_tool(toolkit)` 生成 `get_stock_news_unified` 工具
  - 也可能通过 ToolNode 调用 `toolkit.get_stock_news_unified` 等

#### 5.2.1 获取的数据

- 核心工具：**统一新闻工具** `get_stock_news_unified` / `create_unified_news_tool`：
  - 内部流程（以 A 股为例）：
    1. 优先尝试东方财富实时新闻（`get_realtime_stock_news`）
    2. 如果不足，尝试 Google News / OpenAI 集成的 web_search 工具
    3. 对港股/美股会切换不同的新闻源与语言
  - 输出：
    - 统一格式的新闻汇总文本，包括：
      - 标题、时间、来源
      - 新闻摘要
      - 初步情绪/利好利空判断
      - 近期重大事件

#### 5.2.2 节点如何使用数据

- News Analyst 会：
  - 根据 `trade_date` 和 `company_of_interest` 给出细致的系统提示：
    - 关注过去 15–30 分钟 / 最近几小时内的新闻
    - 区分利好 / 利空 / 中性事件
    - 分析短期价格影响和长期基本面影响
  - 调用统一新闻工具获取原始新闻数据
  - 将这些数据总结为中文的 **`news_report`**：
    - 事件列表与分类
    - 对股价潜在影响
    - 新闻的时效性与可信度评估（若数据滞后，会显式说明）

#### 5.2.3 对最终决策的贡献

- Bull/Bear Researcher 在辩论中，会使用 `news_report`：
  - 多头：强调利好新闻、行业向上事件
  - 空头：强调负面新闻、政策风险、突发事件
- Research Manager / Risk Manager 会：
  - 把新闻与市场数据、基本面结合，判断是否属于"噪音"还是结构性变化
  - 考虑新闻的短期冲击与长期价值影响

---

### 5.3 Social Media Analyst（社交媒体/情绪分析师）

实现位置：

- 节点函数：`tradingagents/agents/analysts/social_media_analyst.py::social_media_analyst_node`
- 工具：
  - `toolkit.get_stock_sentiment_unified`
    - 内部再调用：`get_chinese_social_sentiment`、`get_reddit_company_news` 等

#### 5.3.1 获取的数据

- `get_stock_sentiment_unified`：
  - 中国本土平台：
    - 雪球、东方财富股吧、新浪财经、财经自媒体平台
  - 若本土数据不可用，会回退到英文社区（例如 Reddit）
  - 输出：
    - 整合社交平台和财经媒体讨论的情绪报告：
      - 多空观点比例
      - 主要争议点
      - 投资者情绪（贪婪/恐惧）
      - 关键意见领袖(KOL) 的观点

#### 5.3.2 节点如何使用数据

- Social Media Analyst 的系统提示强调：
  - 平台类型和典型受众（散户 vs 机构）
  - 情绪变化趋势与驱动事件
- 最终产出 `sentiment_report`：
  - 结构化描述市场情绪，并分类出关键风险点或情绪泡沫。

#### 5.3.3 对最终决策的贡献

- 多头/空头研究员：
  - 用来解释短期涨跌和噪音
- Trader：
  - 结合情绪与市场微结构，决定仓位大小/入场节奏
- Risk 团队：
  - 如果情绪极端（过度乐观/悲观），会在风险评估中放大警惕。

---

### 5.4 Fundamentals Analyst（基本面分析师）

实现位置：

- 节点函数：`tradingagents/agents/analysts/fundamentals_analyst.py::fundamentals_analyst_node`
- 工具：
  - `toolkit.get_stock_fundamentals_unified`

#### 5.4.1 获取的数据

- `get_stock_fundamentals_unified`（统一基本面分析工具）：
  - 根据股票类型自动调用：
    - A 股：从 MongoDB + Tushare / AKShare / 财报数据集中组合
    - 美股：AlphaVantage / Finnhub 等
  - 包含信息：
    - 财务报表（收入、利润、现金流）
    - 估值指标（PE、PB、ROE、毛利率、负债率等）
    - 增长指标（营收/利润增速）
    - 行业对比、同类公司对比（视数据源而定）
  - 工具逻辑会根据分析深度（config 中的 `research_depth`）决定抓取数据的详细程度。

#### 5.4.2 节点如何使用数据

- 基本面分析师会：
  - 调用统一基本面工具并检查返回结果中是否含有核心字段
  - 根据数据，生成详细的中文基本面报告 `fundamentals_report`：
    - 公司业务结构、盈利模式
    - 财务健康情况
    - 当前估值是否偏高/偏低
    - 合理价格区间与估值结论
- 同时存在"强制报告逻辑"：
  - 即使工具调用结果"看着不太好"，也会引导模型基于已有数据生成完整报告，避免空结果。

#### 5.4.3 对最终决策的贡献

- 这是中长期投资逻辑的核心依据：
  - 多头研究员：强调成长性、护城河、低估
  - 空头研究员：强调盈利质量、负债、估值泡沫
  - Research Manager：
    - 在综合 `market_report` 与 `fundamentals_report` 时，决定是"交易性机会"还是"价值型机会"或"应回避资产"

---

### 5.5 Msg Clear X 与 tools_X 节点

构图中，每个分析师类型都有三个节点：

- `"{AnalystType} Analyst"`：真正的 LLM 分析节点
- `"tools_{analyst_type}"`：工具节点（ToolNode）
  - 负责执行 LLM 生成的 `tool_calls`，返回工具输出，写回 messages
- `"Msg Clear {AnalystType}"`：
  - 使用 `create_msg_delete()` 创建
  - 作用：清理中间消息（特别是工具调用请求/中间结果），只保留"最终报告摘要"等关键信息
  - 防止后续节点上下文过长，提高稳健性

条件逻辑（`conditional_logic.should_continue_market/social/news/fundamentals`）保证：

- 若已拿到足够长的报告（长度阈值 >100 等）→ 跳转到 `Msg Clear ...`，结束该分析师循环
- 若还存在未执行的 `tool_calls` → 跳转到 `tools_*` 执行工具
- 通过工具调用计数器避免死循环。

---

## 6. 研究辩论阶段（投资团队）

### 6.1 Bull Researcher（看涨研究员）

位置：`tradingagents/agents/researchers/bull_researcher.py`

**输入：**

- `market_report`
- `sentiment_report`
- `news_report`
- `fundamentals_report`
- `investment_debate_state`（历史辩论）
- `FinancialSituationMemory`（从过往类似案例中检索记忆）

**逻辑：**

1. 检测股票所属市场（A 股/港股/美股），确定货币与称谓（使用公司名称而非代码）。
2. 构造提示：
   - 强调成长性、竞争优势、积极指标
   - 要求用中文，逐条反驳空头观点
   - 引用 `past_memories` 中类似案例的经验教训
3. 调用 LLM `llm.invoke(prompt)`，生成"多头论据"。

**输出：**

- 更新 `investment_debate_state`：
  - `bull_history`：累积多头发言
  - `history`：整体辩论历史
  - `current_response`：最新多头发言
  - `count`：轮次计数

### 6.2 Bear Researcher（看跌研究员）

位置：`tradingagents/agents/researchers/bear_researcher.py`

- 输入与 Bull 类似，只是视角相反：
  - 强调风险、估值过高、竞争加剧、财务隐忧、负面新闻
- 输出：
  - 更新 `bear_history`、`history`、`current_response` 等

### 6.3 Research Manager（研究经理）

位置：`tradingagents/agents/managers/research_manager.py`

**输入：**

- 四大报告：
  - `market_report` / `sentiment_report` / `news_report` / `fundamentals_report`
- 全部辩论历史：`investment_debate_state.history`
- 记忆：`FinancialSituationMemory.get_memories(curr_situation, n_matches=2)`

**逻辑：**

1. 把四份报告拼成 `curr_situation`，作为"当前市场画像"。
2. 从记忆库中检索与当前情景类似的历史案例（`past_memories`）：
   - 带有过去的推荐和结果
3. 向 LLM 提示：
   - 要做出明确决策：支持多头/空头/持有，必须给理由
   - 要综合历史记忆（避免重复过去错误）
   - 要权衡短期与长期视角

**输出：**

- 更新 `investment_debate_state`，通常会包含：
  - `judge_decision`: 研究团队的最终意见（文本）
- 写入 `state`：
  - `investment_plan`：**研究经理视角的投资计划**（尚未到具体交易细节）

---

## 7. 交易员与风险管理阶段

### 7.1 Trader（交易员节点）

位置：`tradingagents/agents/trader/trader.py`

**输入：**

- `company_of_interest`（实际用于 `StockUtils.get_market_info`）
- `investment_plan`（研究经理给出的投资建议）
- `market_report` / `sentiment_report` / `news_report` / `fundamentals_report`

**逻辑：**

1. 根据市场类型（A 股/港股/美股）选择货币单位（人民币、港币、美元等）。
2. 系统提示：
   - 要把研究计划转化为具体交易策略：
     - 买入/卖出/持有
     - 分批建仓/减仓
     - 止损/止盈位
     - 时间窗口（短线、中线、波段）
3. LLM 结合各种报告，生成较为"可执行"的交易方案。

**输出：**

- 写入 `state["trader_investment_plan"]`：
  - 这是**从"研究决策"走向"交易执行"的桥梁**。

### 7.2 风险分析三人组

位置：`tradingagents/agents/risk_mgmt/*.py`

- `create_risky_debator` → Risky Analyst（激进）
- `create_safe_debator` → Safe Analyst（保守）
- `create_neutral_debator` → Neutral Analyst（中性）

**共同输入：**

- `risk_debate_state`（风险辩论历史）
- 四大报告：`market_report`、`sentiment_report`、`news_report`、`fundamentals_report`
- `trader_investment_plan`

**各自视角：**

- Risky Analyst：
  - 强调承担风险的收益潜力，有利于高收益策略
  - 通过 `risky_history` 累积激进论据
- Safe Analyst：
  - 强调资本保全、极端情景、尾部风险
  - 通过 `safe_history` 累积保守论据
- Neutral Analyst：
  - 尝试平衡激进与保守观点，寻找折衷方案
  - 通过 `neutral_history` 累积中性论据

每个节点执行时：

- 读取所有报告 + 交易计划 + 已有辩论历史
- 调用 LLM 生成一段中文辩论发言
- 更新 `risk_debate_state`（history + 对应角色 history + 最新发言）

### 7.3 Risk Judge（风险经理节点）

位置：`tradingagents/agents/managers/risk_manager.py`

**输入：**

- `risk_debate_state.history`（三方辩论全记录）
- 四大报告：`market_report` / `news_report` / `fundamentals_report` / `sentiment_report`
- `investment_plan`（研究经理的计划）
- 历史记忆（`risk_manager_memory.get_memories(...)`）

**逻辑：**

1. 拼接当前情况（市场 + 情绪 + 新闻 + 基本面），再加上辩论历史。
2. 从风险记忆库检索类似风险场景的历史建议和结果。
3. 向 LLM 提示：
   - 重点评估风险敞口是否可接受
   - 是否需要调整仓位/价格/时间窗口
   - 是否应取消或推迟交易计划
4. 生成：
   - `risk_management_decision`：风险角度的文字结论
   - **最终 `final_trade_decision`**（通常在 TradingAgentsGraph 中进一步解析结构）

**输出：**

- 更新 `state["risk_debate_state"]` 的最终状态
- 写入 `state["final_trade_decision"]`（文字版）

---

## 8. 信号处理与最终结构化决策

### 8.1 SignalProcessor 与 TradingAgentsGraph.process_signal

位置：`tradingagents/graph/signal_processing.py` & `tradingagents/graph/trading_graph.py`

- TradingAgentsGraph 的 `propagate(...)` 返回：
  - `final_state`：LangGraph 的状态（包含所有报告和辩论状态）
  - `decision`：经 `process_signal` 处理后的结构化决策（dict）

`process_signal` 主要工作：

1. 从 `final_trade_decision` 文本中提取：
   - 行动建议（买入/卖出/持有）
   - 目标价（解析货币符号，转换为 float）
   - 信心度 / 风险评分
   - 关键理由（reasoning）
2. 构造统一结构：

```python
decision = {
    "action": "买入 / 卖出 / 持有",
    "confidence": 0.0 ~ 1.0,
    "risk_score": 0.0 ~ 1.0,
    "target_price": float or None,
    "reasoning": "详细文字说明",
    ...
}
```

服务层 `_run_analysis_sync()` 会再做一次规范化：

- 将 action 翻译成中文
- 清洗 target_price 字符串（去掉货币符号等）
- 给缺失字段合理的默认值（保证 API 返回结构稳定）

### 8.2 服务层输出给后端 API

`SimpleAnalysisService._run_analysis_sync()` 最终整理出：

- `reports`：从 `state` 提取的多维报告（市场 / 基本面 / 新闻 / 情绪 / 多空辩论 / 风险辩论等）
- `decision`：上述结构化结果
- 其它字段：
  - `summary` / `recommendation` / `key_points`
  - `execution_time` / `tokens_used` 等

这些被保存到 MongoDB，并在 API `GET /api/analysis/tasks/{task_id}/result` 中返回。

---

## 9. 数据获取链路总结

将数据视角从"最底层数据源"到"最终决策"串起来：

1. **预拉取 & 验证：**
   - `prepare_stock_data_async`：
     - 检查 MongoDB 中是否已经有足够历史数据
     - 若不够，自动触发 worker 同步（Tushare / AKShare / Baostock 等）
     - 返回是否有效、股票名称、市场类型、缓存状态

2. **统一工具层（Toolkit + dataflows）：**
   - `get_stock_market_data_unified`：
     - DataSourceManager → 多数据源降级 + 缓存（MongoDB / 文件缓存）
   - `get_stock_fundamentals_unified`：
     - 聚合财报/估值指标，按深度级别控制数据获取量
   - `get_stock_news_unified` / `create_unified_news_tool`：
     - 东方财富实时新闻 → Google News / OpenAI web_search → Finnhub 等
   - `get_stock_sentiment_unified`：
     - 本土社交平台情绪 + 备用 Reddit 数据

3. **分析师节点：**
   - 将统一工具的原始文本数据，转换成"可被辩论和决策使用的报告"（market/fundamentals/news/sentiment_report）

4. **研究/交易/风险节点：**
   - 基于报告 + 历史记忆，开展多轮辩论与综合判断
   - 最终生成 `investment_plan` → `trader_investment_plan` → `final_trade_decision`

5. **信号处理 & API：**
   - `process_signal` → 结构化决策 `decision`
   - `SimpleAnalysisService` → 整理为统一 JSON 模型
   - `GET /api/analysis/tasks/{task_id}/result` 返回给前端 / 调用方

---

## 10. 如何理解"依据数据生成最终分析与决策"

从工程视角，可以用一句话概括：

> **底层数据（K 线、财报、新闻、情绪）通过"统一工具 + 四大分析师"变成多维报告，  
> 再通过"研究多空辩论 + 交易员 + 风险辩论 + 风险经理"的一系列 LangGraph 节点，  
> 最终凝结成一个结构化的交易决策 `decision`。**

更精细地看：

1. **数据可信性与完整性**：  
   - 在工具和 dataflows 层，处理：多数据源降级、缓存、数据准备、非交易日/节假日处理。
2. **信息语义化**：  
   - 四大分析师将"数据"翻译成"解释性文本报告"，涵盖市场、基本面、情绪、新闻。
3. **价值判断（多空辩论）**：  
   - Bull / Bear + Research Manager 利用报告与历史记忆，形成价值判断与投资计划。
4. **执行可行性与约束（交易 + 风险）**：  
   - Trader 将计划转化为可执行策略。
   - 三类风险分析师从不同风险偏好视角评估方案，Risk Judge 结合历史教训做最终裁决。
5. **统一输出格式**：  
   - SignalProcessor 与服务层将上述结果映射为统一 JSON 结构，方便前端 UI 和任何外部调用方使用。

---

## 11. 后端 API 接口总览

### 11.1 核心分析接口

#### POST /api/analysis/single
提交单股分析任务

**请求体：**
```json
{
  "symbol": "600519",
  "parameters": {
    "market_type": "A股",
    "analysis_date": "2025-01-10T00:00:00",
    "research_depth": "标准",
    "selected_analysts": ["market", "fundamentals", "news", "social"],
    "quick_analysis_model": "qwen-turbo",
    "deep_analysis_model": "qwen-max"
  }
}
```

**响应：**
```json
{
  "success": true,
  "data": {
    "task_id": "<uuid>",
    "status": "pending",
    "message": "任务已创建，等待执行"
  },
  "message": "分析任务已在后台启动"
}
```

#### GET /api/analysis/tasks/{task_id}/status
查询任务状态和进度

**响应示例：**
```json
{
  "success": true,
  "data": {
    "task_id": "...",
    "status": "processing | completed | failed | pending",
    "progress": 0-100,
    "message": "当前状态描述",
    "current_step": "engine_initialization | agent_analysis | ...",
    "start_time": "ISO8601",
    "elapsed_time": 123.4,
    "stock_code": "600519"
  }
}
```

#### GET /api/analysis/tasks/{task_id}/result
获取完整分析结果

**响应结构（关键字段）：**
```json
{
  "success": true,
  "data": {
    "analysis_id": "xxx",
    "stock_symbol": "600519",
    "analysis_date": "2025-01-10",
    "summary": "综合分析摘要...",
    "recommendation": "投资建议...",
    "confidence_score": 0.85,
    "risk_level": "中等",
    "key_points": ["要点1", "要点2"],
    "decision": {
      "action": "买入 | 卖出 | 持有",
      "confidence": 0.8,
      "risk_score": 0.3,
      "target_price": 123.45,
      "reasoning": "详细推理..."
    },
    "reports": {
      "market_report": "...",
      "fundamentals_report": "...",
      "news_report": "...",
      "sentiment_report": "...",
      "bull_researcher": "...",
      "bear_researcher": "...",
      "research_team_decision": "...",
      "trader_investment_plan": "...",
      "risky_analyst": "...",
      "safe_analyst": "...",
      "neutral_analyst": "...",
      "risk_management_decision": "..."
    }
  }
}
```

### 11.2 批量分析接口

#### POST /api/analysis/batch
提交批量分析任务（真正并发执行，最多10个股票）

**请求体：**
```json
{
  "title": "白酒板块批量分析",
  "symbols": ["600519", "000858"],
  "parameters": {
    "research_depth": "标准",
    "selected_analysts": ["market", "fundamentals"]
  }
}
```

### 11.3 进度推送接口

#### SSE: GET /sse/tasks/{task_id}
Server-Sent Events 实时进度流

#### WebSocket: /api/ws/tasks/{task_id}?token=<jwt>
WebSocket 任务进度推送

**消息格式：**
```json
{
  "type": "progress",
  "data": {
    "task_id": "...",
    "message": "正在分析...",
    "progress": 20.0,
    "timestamp": "2025-10-23T12:00:00"
  }
}
```

### 11.4 配置与模型管理

- `GET /api/config/system` - 获取系统配置
- `GET /api/config/models` - 获取可用模型列表
- `POST /api/config/default/llm` - 设置默认 LLM
- `GET /model-capabilities/recommend` - 模型推荐
- `POST /model-capabilities/validate` - 验证模型对

---

## 12. 数据源架构

### 12.1 数据源管理器（DataSourceManager）

位置：`tradingagents/dataflows/data_source_manager.py`

**核心职责：**
- 统一管理中国股票数据源（Tushare/AKShare/Baostock）
- 多数据源自动降级
- 优先使用 MongoDB 缓存

**数据源优先级（A股）：**
1. MongoDB 缓存（最高优先级）
2. Tushare（需要 token）
3. AKShare（免费）
4. Baostock（备用）

**数据源优先级（美股）：**
1. MongoDB 缓存
2. YFinance（主要）
3. AlphaVantage（基本面）
4. Finnhub（备用）

### 12.2 缓存策略

**双层缓存：**
- MongoDB 缓存（`tradingagents/dataflows/cache/db_cache.py`）
  - 持久化存储
  - 支持跨进程共享
  - 适合生产环境
- 文件缓存（`tradingagents/dataflows/cache/file_cache.py`）
  - 本地文件系统
  - 开发/测试环境备选

**缓存过期策略：**
- 实时数据：15-30分钟
- 日线数据：1天
- 基本面数据：7天
- 新闻数据：1小时

---

## 13. 后续提问方向建议

有了本文档，你后续可以围绕以下方向提问：

### 13.1 节点细节
- 想了解某个节点的 prompt 和行为细节
- 如何调整某个分析师的分析重点
- 如何修改辩论逻辑或轮数

### 13.2 数据源集成
- 接入新的数据源（如某券商 API）
- 修改数据源优先级
- 添加新的技术指标或基本面字段

### 13.3 模型配置
- 接入新的 LLM 厂商
- 调整不同节点使用的模型
- 优化 token 使用和成本

### 13.4 工作流定制
- 添加新的节点（如合规检查、资产配置）
- 修改节点执行顺序
- 实现不同的分析模式（快速/深度/专题）

### 13.5 性能优化
- 并发执行优化
- 缓存策略调整
- 进度追踪优化

---

## 附录：关键文件索引

### A. LangGraph 核心
- `tradingagents/graph/trading_graph.py` - TradingAgentsGraph 主类
- `tradingagents/graph/setup.py` - 图结构构建
- `tradingagents/graph/propagation.py` - 状态初始化
- `tradingagents/graph/conditional_logic.py` - 条件边逻辑
- `tradingagents/graph/signal_processing.py` - 信号处理

### B. 智能体节点
- `tradingagents/agents/analysts/market_analyst.py` - 市场分析师
- `tradingagents/agents/analysts/fundamentals_analyst.py` - 基本面分析师
- `tradingagents/agents/analysts/news_analyst.py` - 新闻分析师
- `tradingagents/agents/analysts/social_media_analyst.py` - 情绪分析师
- `tradingagents/agents/researchers/bull_researcher.py` - 看涨研究员
- `tradingagents/agents/researchers/bear_researcher.py` - 看跌研究员
- `tradingagents/agents/managers/research_manager.py` - 研究经理
- `tradingagents/agents/trader/trader.py` - 交易员
- `tradingagents/agents/risk_mgmt/` - 风险管理团队
- `tradingagents/agents/managers/risk_manager.py` - 风险经理

### C. 工具与数据
- `tradingagents/agents/utils/agent_utils.py` - 工具集 Toolkit
- `tradingagents/dataflows/data_source_manager.py` - 数据源管理
- `tradingagents/dataflows/interface.py` - 数据接口统一层
- `tradingagents/utils/stock_validator.py` - 股票数据验证

### D. 后端服务
- `app/services/simple_analysis_service.py` - 分析服务
- `app/routers/analysis.py` - 分析 API 路由
- `app/services/redis_progress_tracker.py` - 进度追踪
- `app/services/memory_state_manager.py` - 任务状态管理

---

**文档版本：** v1.0  
**最后更新：** 2025-12-11  
**维护者：** TradingAgents-CN Team
